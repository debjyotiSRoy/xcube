<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Training a learning-to-rank model">

<title>xcube - L2R Training</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="xcube - L2R Training">
<meta property="og:description" content="Training a learning-to-rank model">
<meta property="og:image" content="https://debjyotiSRoy.github.io/xcube/17_tutorial.train_l2r_files/figure-html/cell-27-output-1.png">
<meta property="og:site-name" content="xcube">
<meta property="og:image:height" content="366">
<meta property="og:image:width" content="503">
<meta name="twitter:title" content="xcube - L2R Training">
<meta name="twitter:description" content="Training a learning-to-rank model">
<meta name="twitter:image" content="https://debjyotiSRoy.github.io/xcube/17_tutorial.train_l2r_files/figure-html/cell-27-output-1.png">
<meta name="twitter:image-height" content="366">
<meta name="twitter:image-width" content="503">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">xcube</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./tutorial.train_l2r.html">L2R Training</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">xcube</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">utils</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./layers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Layers</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./text.models.core.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Core XML Text Modules</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./text.learner.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Learner for the XML Text application:</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./metrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Metrics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./collab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Collaborative filtering</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data.transforms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Transformation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l2r.models.core.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L2R Models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l2r.gradients.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L2R Gradients</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l2r.learner.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L2R Learner</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l2r.data.load.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L2R DataLoader</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l2r.callbacks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L2R Callbacks</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data.external.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Downloading…</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l2r.data.info_gain.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Information Gain</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tutorial.boot_l2r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Boot L2R</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l2r.data.stat.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Stat</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tutorial.train_l2r.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">L2R Training</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tutorial.train_mimic3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Training an XML Text Classifier</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./text.callbacks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">XML Callbacks</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tutorial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tutorials</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#getting-ready" id="toc-getting-ready" class="nav-link active" data-scroll-target="#getting-ready">Getting ready</a></li>
  <li><a href="#statistical-analysis" id="toc-statistical-analysis" class="nav-link" data-scroll-target="#statistical-analysis">Statistical Analysis</a></li>
  <li><a href="#build-l2rdataloader" id="toc-build-l2rdataloader" class="nav-link" data-scroll-target="#build-l2rdataloader">Build <code>L2RDataloader</code></a></li>
  <li><a href="#training" id="toc-training" class="nav-link" data-scroll-target="#training">Training</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/debjyotiSRoy/xcube/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">L2R Training</h1>
</div>

<div>
  <div class="description">
    Training a learning-to-rank model
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> [ <span class="op">-</span>e <span class="op">/</span>content ] <span class="op">&amp;&amp;</span> pip install <span class="op">-</span>Uqq xcube <span class="co"># upgrade xcube on colab</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xcube.l2r.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Make sure we have that “beast”:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>ic(torch.cuda.get_device_name(default_device()))<span class="op">;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>test_eq(torch.cuda.get_device_name(<span class="dv">0</span>), torch.cuda.get_device_name(default_device()))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>test_eq(default_device(), torch.device(<span class="dv">0</span>))</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"GPU memory = </span><span class="sc">{</span>torch<span class="sc">.</span>cuda<span class="sc">.</span>get_device_properties(default_device())<span class="sc">.</span>total_memory<span class="op">/</span><span class="dv">1024</span><span class="op">**</span><span class="dv">3</span><span class="sc">}</span><span class="ss">GB"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>ic| torch.cuda.get_device_name(default_device()): 'Quadro RTX 8000'</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>GPU memory = 44.99969482421875GB</code></pre>
</div>
</div>
<p>Setting some environment variables:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># os.environ['CUDA_LAUNCH_BLOCKING'] = "1"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Setting defaults for pandas and matplotlib:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the default figure size</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"figure.figsize"</span>] <span class="op">=</span> (<span class="dv">6</span>, <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In this tutorial we will train a l2r model. We will bootstrap the model using the data we prepared in tutorial <a href="./tutorial.boot_l2r.html">booting L2R</a></p>
<section id="getting-ready" class="level2">
<h2 class="anchored" data-anchor-id="getting-ready">Getting ready</h2>
<p>Prepping l2r data for xcube’s <a href="https://debjyotiSRoy.github.io/xcube/l2r.data.load.html#l2rdataloader"><code>L2RDataLoader</code></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>source <span class="op">=</span> untar_xxx(XURLs.MIMIC3_L2R)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>source.ls()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(#11) [Path('/home/deb/.xcube/data/mimic3_l2r/info.pkl'),Path('/home/deb/.xcube/data/mimic3_l2r/code_descriptions.csv'),Path('/home/deb/.xcube/data/mimic3_l2r/mimic3-9k_tok_lbl_info.pkl'),Path('/home/deb/.xcube/data/mimic3_l2r/code_desc.pkl'),Path('/home/deb/.xcube/data/mimic3_l2r/p_TL.pkl'),Path('/home/deb/.xcube/data/mimic3_l2r/trn_val_split.pkl'),Path('/home/deb/.xcube/data/mimic3_l2r/mimic3-9k_tok.ft'),Path('/home/deb/.xcube/data/mimic3_l2r/mimic3-9k_lbl.ft'),Path('/home/deb/.xcube/data/mimic3_l2r/mimic3-9k.csv'),Path('/home/deb/.xcube/data/mimic3_l2r/scored_tokens.pth')...]</code></pre>
</div>
</div>
<p>Note: If you don’t have enough GPU/CPU memory just run the last cell of this section to load the pregenerated ones.</p>
<p>Here we can just load the file which contains the relevant information about the tokens, labels and their mutual-information-gain:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cheking if you have enough memory to set device</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>cuda_memory <span class="op">=</span> torch.cuda.get_device_properties(torch.cuda.current_device()).total_memory<span class="op">/</span><span class="dv">1024</span><span class="op">**</span><span class="dv">3</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> cuda_memory <span class="op">&lt;</span> <span class="fl">10.</span>: <span class="bu">print</span>(<span class="ss">f"Not Enough GPU Memory (just </span><span class="sc">{</span>cuda_memory<span class="sc">}</span><span class="ss"> GB), we'll use </span><span class="sc">{</span>default_device(use<span class="op">=</span><span class="va">False</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>l2r_bootstrap <span class="op">=</span> torch.load(source<span class="op">/</span><span class="st">'mimic3-9k_tok_lbl_info.pkl'</span>, map_location<span class="op">=</span>default_device())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>test_eq(l2r_bootstrap.keys(), [<span class="st">'toks'</span>, <span class="st">'lbs'</span>, <span class="st">'mut_info_lbl_entropy'</span>, <span class="st">'mutual_info_jaccard'</span>])</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>toks <span class="op">=</span> l2r_bootstrap.get(<span class="st">'toks'</span>, <span class="va">None</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>lbs <span class="op">=</span> l2r_bootstrap.get(<span class="st">'lbs'</span>, <span class="va">None</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>info <span class="op">=</span> l2r_bootstrap.get(<span class="st">'mutual_info_jaccard'</span>, <span class="va">None</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> o <span class="kw">in</span> (toks, lbs, info): <span class="cf">assert</span> o <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>test_eq(info.shape, (<span class="bu">len</span>(toks), <span class="bu">len</span>(lbs)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>info</code> contains the mutual-information-gain values for the tokens and labels. In what follows we’ll toss in some pandas to take a good hard look at the data before we proceed towards making xcube’s <a href="https://debjyotiSRoy.github.io/xcube/l2r.data.load.html#l2rdataloader"><code>L2RDataLoader</code></a>:</p>
<p><em>Note:</em> Storing the tokens and the labels in a dataframe as <code>object</code> will take up a lot of RAM space when we prepare that <code>DataLoader</code>. So we are going to store the corresponding token and label indices instead in a dataframe called <code>df_l2r</code>. We are also going to store the tokens and the labels with their corresponding indices in seperate dataframes (this will help in quick merging for analysis).</p>
<p>Here we will rank the tokens for each label based on the decreasing values of the mutual-info and stack them up with mutual-info.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>ranked <span class="op">=</span> info.argsort(descending<span class="op">=</span><span class="va">True</span>, dim<span class="op">=</span><span class="dv">0</span>).argsort(dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>info_ranked <span class="op">=</span>torch.stack((info, ranked), dim<span class="op">=</span><span class="dv">2</span>).flatten(start_dim<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> pd.MultiIndex.from_product([<span class="bu">range</span>(<span class="bu">len</span>(lbs)), [<span class="st">'mutual_info'</span>, <span class="st">'rank'</span>]], names<span class="op">=</span>[<span class="st">'label'</span>, <span class="st">'key2'</span>])</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>df_l2r <span class="op">=</span> pd.DataFrame(info_ranked, index<span class="op">=</span><span class="bu">range</span>(<span class="bu">len</span>(toks)), columns<span class="op">=</span>cols)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>df_l2r.index.name<span class="op">=</span><span class="st">'token'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>df_l2r.head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">label</th>
<th colspan="2" data-quarto-table-cell-role="th" data-halign="left">0</th>
<th colspan="2" data-quarto-table-cell-role="th" data-halign="left">1</th>
<th colspan="2" data-quarto-table-cell-role="th" data-halign="left">2</th>
<th colspan="2" data-quarto-table-cell-role="th" data-halign="left">3</th>
<th colspan="2" data-quarto-table-cell-role="th" data-halign="left">4</th>
<th data-quarto-table-cell-role="th">...</th>
<th colspan="2" data-quarto-table-cell-role="th" data-halign="left">8917</th>
<th colspan="2" data-quarto-table-cell-role="th" data-halign="left">8918</th>
<th colspan="2" data-quarto-table-cell-role="th" data-halign="left">8919</th>
<th colspan="2" data-quarto-table-cell-role="th" data-halign="left">8920</th>
<th colspan="2" data-quarto-table-cell-role="th" data-halign="left">8921</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">key2</th>
<th data-quarto-table-cell-role="th">mutual_info</th>
<th data-quarto-table-cell-role="th">rank</th>
<th data-quarto-table-cell-role="th">mutual_info</th>
<th data-quarto-table-cell-role="th">rank</th>
<th data-quarto-table-cell-role="th">mutual_info</th>
<th data-quarto-table-cell-role="th">rank</th>
<th data-quarto-table-cell-role="th">mutual_info</th>
<th data-quarto-table-cell-role="th">rank</th>
<th data-quarto-table-cell-role="th">mutual_info</th>
<th data-quarto-table-cell-role="th">rank</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">mutual_info</th>
<th data-quarto-table-cell-role="th">rank</th>
<th data-quarto-table-cell-role="th">mutual_info</th>
<th data-quarto-table-cell-role="th">rank</th>
<th data-quarto-table-cell-role="th">mutual_info</th>
<th data-quarto-table-cell-role="th">rank</th>
<th data-quarto-table-cell-role="th">mutual_info</th>
<th data-quarto-table-cell-role="th">rank</th>
<th data-quarto-table-cell-role="th">mutual_info</th>
<th data-quarto-table-cell-role="th">rank</th>
</tr>
<tr class="header">
<th data-quarto-table-cell-role="th">token</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.000022</td>
<td>866.0</td>
<td>0.000011</td>
<td>1022.0</td>
<td>0.000022</td>
<td>1156.0</td>
<td>0.000011</td>
<td>823.0</td>
<td>0.000033</td>
<td>984.0</td>
<td>...</td>
<td>0.000011</td>
<td>850.0</td>
<td>0.000033</td>
<td>944.0</td>
<td>0.000011</td>
<td>960.0</td>
<td>0.000011</td>
<td>771.0</td>
<td>6.888287e-07</td>
<td>31821.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.000000</td>
<td>56854.0</td>
<td>0.000000</td>
<td>41418.0</td>
<td>0.000000</td>
<td>56853.0</td>
<td>0.000000</td>
<td>41410.0</td>
<td>0.000000</td>
<td>22836.0</td>
<td>...</td>
<td>0.000000</td>
<td>41421.0</td>
<td>0.000000</td>
<td>22861.0</td>
<td>0.000000</td>
<td>41423.0</td>
<td>0.000000</td>
<td>41412.0</td>
<td>0.000000e+00</td>
<td>32385.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.000000</td>
<td>56855.0</td>
<td>0.000000</td>
<td>41419.0</td>
<td>0.000000</td>
<td>56854.0</td>
<td>0.000000</td>
<td>41411.0</td>
<td>0.000000</td>
<td>22837.0</td>
<td>...</td>
<td>0.000000</td>
<td>41422.0</td>
<td>0.000000</td>
<td>22862.0</td>
<td>0.000000</td>
<td>41424.0</td>
<td>0.000000</td>
<td>41413.0</td>
<td>0.000000e+00</td>
<td>32386.0</td>
</tr>
</tbody>
</table>

<p>3 rows × 17844 columns</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>df_l2r <span class="op">=</span> df_l2r.stack(level<span class="op">=</span><span class="dv">0</span>).reset_index().rename_axis(<span class="va">None</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># the above pandas trick can be simulated using numpy as follows</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># n = df_l2r.to_numpy()</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># n_toks, n_lbs = len(df_l2r.index), len(df_l2r.columns.levels[0])</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co"># n = n.reshape(-1, 2)</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co"># tok_lbs_idxs = np.mgrid[slice(0,n_toks), slice(0,n_lbs)].reshape(2,-1).T</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co"># n = np.concatenate((tok_lbs_idxs,n), axis=-1)</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co"># df_l2r = pd.DataFrame(n, columns=['token', 'label', 'mutual_info', 'rank'])</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>df_l2r[[<span class="st">'token'</span>, <span class="st">'label'</span>]] <span class="op">=</span> df_l2r[[<span class="st">'token'</span>, <span class="st">'label'</span>]].astype(np.int32) </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>test_eq(<span class="bu">len</span>(df_l2r), <span class="bu">len</span>(toks) <span class="op">*</span> <span class="bu">len</span>(lbs))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>df_l2r.head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">token</th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">mutual_info</th>
<th data-quarto-table-cell-role="th">rank</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>0</td>
<td>0.000022</td>
<td>866.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>1</td>
<td>0.000011</td>
<td>1022.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>2</td>
<td>0.000022</td>
<td>1156.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>df_l2r.memory_usage()<span class="op">/</span><span class="dv">1024</span><span class="op">**</span><span class="dv">3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Index          1.192093e-07
token          1.906211e+00
label          1.906211e+00
mutual_info    1.906211e+00
rank           1.906211e+00
dtype: float64</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>df_toks <span class="op">=</span> pd.DataFrame([(i, w) <span class="cf">for</span> i,w <span class="kw">in</span> <span class="bu">enumerate</span>(toks)], columns<span class="op">=</span>[<span class="st">'token'</span>, <span class="st">'tok_val'</span>])</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>df_lbs <span class="op">=</span> pd.DataFrame([(i,w) <span class="cf">for</span> i, w <span class="kw">in</span> <span class="bu">enumerate</span>(lbs)], columns<span class="op">=</span>[<span class="st">'lbl'</span>, <span class="st">'lbl_val'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>df_toks.head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">token</th>
<th data-quarto-table-cell-role="th">tok_val</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>xxunk</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>xxpad</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2</td>
<td>xxbos</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>df_lbs.head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">lbl</th>
<th data-quarto-table-cell-role="th">lbl_val</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>003.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>003.1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2</td>
<td>003.8</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>You can save <code>df_l2r</code>, <code>df_toks</code> and <code>df_lbs</code> if you are working on your own dataset. In this case though <a href="https://debjyotiSRoy.github.io/xcube/data.external.html#untar_xxx"><code>untar_xxx</code></a> has already downloaded those for you.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>L(source.glob(<span class="st">"**/*.ft"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(#3) [Path('/home/deb/.xcube/data/mimic3_l2r/mimic3-9k_tok.ft'),Path('/home/deb/.xcube/data/mimic3_l2r/mimic3-9k_lbl.ft'),Path('/home/deb/.xcube/data/mimic3_l2r/mimic3-9k_tok_lbl.ft')]</code></pre>
</div>
</div>
</section>
<section id="statistical-analysis" class="level2">
<h2 class="anchored" data-anchor-id="statistical-analysis">Statistical Analysis</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>df_l2r <span class="op">=</span> pd.read_feather(source<span class="op">/</span><span class="st">'mimic3-9k_tok_lbl.ft'</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>test_eq(df_l2r.dtypes.mutual_info, np.float32)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>df_l2r.head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">token</th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">mutual_info</th>
<th data-quarto-table-cell-role="th">rank</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>0</td>
<td>0.000022</td>
<td>866.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>1</td>
<td>0.000011</td>
<td>1022.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>2</td>
<td>0.000022</td>
<td>1156.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>If you loaded the pregenerated <code>df_l2r</code> then you will see the column “bcx_mutual_info”. It is a box-cox transformation of the “mutual-info”. In this section we’ll justify that transformation. So let’s perform some statistical analysis of that <code>mutual_info</code> column before we build the <a href="https://debjyotiSRoy.github.io/xcube/l2r.data.load.html#l2rdataloader"><code>L2RDataLoader</code></a> in the next section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import gc; gc.collect()</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># df_l2r.info()</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ic(df_l2r.memory_usage().sum()/1024**3)</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ic(sys.getsizeof(df_l2r)/1024**3);</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co"># df_collab.token.nunique()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>mut_infos <span class="op">=</span> df_l2r[<span class="st">'mutual_info'</span>].to_numpy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>mut_infos.<span class="bu">min</span>(), mut_infos.<span class="bu">max</span>(), mut_infos.mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(-6.852321e-05, 0.99999636, 7.175153e-05)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>skew(mut_infos)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 2.22 s, sys: 1.14 s, total: 3.36 s
Wall time: 3.36 s</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>142.75660007849734</code></pre>
</div>
</div>
<p>The mutual-info values are incredibly skewed. So we need to apply some transformation. Sometimes <code>mut_infos</code> might contain negs, we need to convert those to eps.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># np.where(mut_infos&lt;0, 1, 0).sum() # or, better yet</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>where_negs <span class="op">=</span> mut_infos <span class="op">&lt;</span> <span class="dv">0</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>ic(np.<span class="bu">sum</span>(where_negs))</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>eps <span class="op">=</span> np.float32(<span class="fl">1e-20</span>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>mut_infos[where_negs] <span class="op">=</span> eps</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>test_eq(np.<span class="bu">sum</span>(mut_infos<span class="op">&lt;</span><span class="dv">0</span>), <span class="dv">0</span>)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>ic(np.<span class="bu">min</span>(mut_infos), np.<span class="bu">max</span>(mut_infos), np.mean(mut_infos))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>ic| np.sum(where_negs): 111226814
ic| np.min(mut_infos): 0.0
    np.max(mut_infos): 0.99999636
    np.mean(mut_infos): 7.697003e-05</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>hist, bins, _ <span class="op">=</span> plt.hist(mut_infos, bins<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.yscale('log')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="17_tutorial.train_l2r_files/figure-html/cell-27-output-1.png" class="img-fluid"></p>
</div>
</div>
<p><strong>Applying log transform:</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>log_mut_infos <span class="op">=</span> np.log(mut_infos <span class="op">+</span> eps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>np.isnan(log_mut_infos).<span class="bu">sum</span>(), np.isneginf(log_mut_infos).<span class="bu">sum</span>(), np.isinf(log_mut_infos).<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(0, 0, 0)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 2.35 s, sys: 959 ms, total: 3.31 s
Wall time: 3.3 s</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>-1.3383214188674972</code></pre>
</div>
</div>
<p>A little better skewness than before!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>hist, bins, _ <span class="op">=</span> plt.hist(log_mut_infos, bins<span class="op">=</span><span class="dv">50</span>,)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="17_tutorial.train_l2r_files/figure-html/cell-31-output-1.png" class="img-fluid"></p>
</div>
</div>
<p><strong>Applying sqrt transform:</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>sqrt_mut_infos <span class="op">=</span> np.sqrt(mut_infos)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>np.isnan(sqrt_mut_infos).<span class="bu">sum</span>(), np.isinf(sqrt_mut_infos).<span class="bu">sum</span>(), np.isneginf(sqrt_mut_infos).<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(0, 0, 0)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 2.38 s, sys: 1.25 s, total: 3.63 s
Wall time: 3.63 s</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>16.40865608826817</code></pre>
</div>
</div>
<p>Worse than log transform!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>hist, bins, _ <span class="op">=</span> plt.hist(sqrt_mut_infos, bins<span class="op">=</span><span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="17_tutorial.train_l2r_files/figure-html/cell-35-output-1.png" class="img-fluid"></p>
</div>
</div>
<p><strong>Apply box-cox transfrom:</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>bcx_mut_infos, <span class="op">*</span>_ <span class="op">=</span> boxcox(mut_infos<span class="op">+</span>eps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/deb/miniconda3/envs/deep/lib/python3.10/site-packages/scipy/stats/_morestats.py:933: RuntimeWarning: overflow encountered in power
  variance = np.var(data**lmb / lmb, axis=0)
/home/deb/miniconda3/envs/deep/lib/python3.10/site-packages/numpy/core/_methods.py:233: RuntimeWarning: invalid value encountered in subtract
  x = asanyarray(arr - arrmean)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>np.isnan(bcx_mut_infos).<span class="bu">sum</span>(), np.isinf(bcx_mut_infos).<span class="bu">sum</span>(), np.isneginf(bcx_mut_infos).<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(0, 0, 0)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 2.45 s, sys: 1.04 s, total: 3.49 s
Wall time: 3.49 s</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>-0.885981418331696</code></pre>
</div>
</div>
<p>This is the best skew so we’ll go with boxcox.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>df_l2r[<span class="st">'bcx_mutual_info'</span>] <span class="op">=</span> bcx_mut_infos</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>hist, bins, _ <span class="op">=</span> plt.hist(bcx_mut_infos, bins<span class="op">=</span><span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="17_tutorial.train_l2r_files/figure-html/cell-40-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>np.<span class="bu">min</span>(bcx_mut_infos), np.<span class="bu">max</span>(bcx_mut_infos), np.mean(bcx_mut_infos), np.median(bcx_mut_infos)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(-9.734209, -3.6358892e-06, -7.381837, -6.9605794)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># from IPython.display import clear_output</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="co"># clear_output(wait=True)</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="co"># from tqdm import tqdm</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="co"># from time import sleep</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="co"># import psutil</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a><span class="co"># with tqdm(total=100, desc='cpu%', position=1) as cpubar, tqdm(total=100, desc='ram%', position=0) as rambar:</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a><span class="co">#     while True:</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a><span class="co">#         rambar.n=psutil.virtual_memory().percent</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a><span class="co">#         cpubar.n=psutil.cpu_percent()</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a><span class="co">#         rambar.refresh()</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a><span class="co">#         cpubar.refresh()</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a><span class="co">#         sleep(0.5)</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a><span class="co">#         clear_output(wait=True)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Box plots using matplotlib</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>fig, (ax1, ax2) <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>ax1 <span class="op">=</span> fig.add_subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> fig.add_subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>ax1.boxplot(mut_infos, vert<span class="op">=</span><span class="dv">0</span>, notch<span class="op">=</span><span class="va">True</span>, patch_artist<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>ax1.set_xscale(<span class="st">'log'</span>)</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'Mutual Information'</span>)</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>ax2.boxplot(bcx_mut_infos, vert<span class="op">=</span><span class="dv">0</span>, notch<span class="op">=</span><span class="va">True</span>, patch_artist<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ax2.set_xscale('symlog')</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>ax2.set_xlabel(<span class="st">'Box-Cox Mutual Information'</span>)</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="17_tutorial.train_l2r_files/figure-html/cell-43-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 1min 35s, sys: 9.16 s, total: 1min 44s
Wall time: 1min 44s</code></pre>
</div>
</div>
<p>Histograms and kde using matplotlib:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>fig, (ax1, ax2) <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="co"># hist, bins, pathches = ax1.hist(df_l2r['mutual_info'])</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>hist, bins, pathches <span class="op">=</span> ax1.hist(mut_infos)</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'Mutual Information'</span>)</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'frequency'</span>)</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>ax1.grid(axis<span class="op">=</span><span class="st">'y'</span>, color<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>ax1.set_yscale(<span class="st">'log'</span>)</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ax2.hist(df_l2r['bcx_mutual_info'])</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>ax2.hist(bcx_mut_infos)</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>ax2.set_xlabel(<span class="st">'Boxcox Mutual Information'</span>)</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'frequency'</span>)</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>ax2.grid(axis<span class="op">=</span><span class="st">'y'</span>, color<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>ax2.set_yscale(<span class="st">'log'</span>)</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">'Histograms of with and without BoxCox of Mutual Information'</span>)</span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="17_tutorial.train_l2r_files/figure-html/cell-44-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>bdrs <span class="op">=</span> [bins[i:i<span class="op">+</span><span class="dv">2</span>] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(bins)<span class="op">-</span><span class="dv">1</span>)]</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>pd.DataFrame({<span class="st">'mut_infos bdrs'</span>: bdrs, <span class="st">'counts'</span>: hist})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mut_infos bdrs</th>
<th data-quarto-table-cell-role="th">counts</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>[0.0, 0.09999963641166687]</td>
<td>511675599.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>[0.09999963641166687, 0.19999927282333374]</td>
<td>14848.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>[0.19999927282333374, 0.2999989092350006]</td>
<td>3323.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>[0.2999989092350006, 0.3999985456466675]</td>
<td>191.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>[0.3999985456466675, 0.49999818205833435]</td>
<td>454.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>[0.49999818205833435, 0.5999978184700012]</td>
<td>30.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>[0.5999978184700012, 0.6999974250793457]</td>
<td>5.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>[0.6999974250793457, 0.799997091293335]</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>[0.799997091293335, 0.8999967575073242]</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>[0.8999967575073242, 0.9999963641166687]</td>
<td>94.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># from scipy.stats import gaussian_kde</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="co"># density = gaussian_kde(df_l2r['mutual_info'])</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="co"># xs = np.linspace(0, 1, 200)</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="co"># density.covariance_factor = lambda : .25</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="co"># density._compute_covariance()</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.plot(xs, density(xs))</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.show()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now build the <code>Dataloaders</code> object from this dataframe <code>df_collab</code>, by defaultit takes the first column as the user (in our case the token) and the second column as the item (in our case the label), and the third column as the ratings (in our case the frequency):</p>
</section>
<section id="build-l2rdataloader" class="level2">
<h2 class="anchored" data-anchor-id="build-l2rdataloader">Build <code>L2RDataloader</code></h2>
<p>In this section we’ll build <a href="https://debjyotiSRoy.github.io/xcube/l2r.data.load.html#l2rdataloader"><code>L2RDataLoader</code></a> for <a href="https://www.microsoft.com/en-us/research/wp-content/uploads/2016/02/MSR-TR-2010-82.pdf">Learning to Rank (L2R)</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>df_l2r <span class="op">=</span> pd.read_feather(source<span class="op">/</span><span class="st">'mimic3-9k_tok_lbl.ft'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>df_l2r <span class="op">=</span> df_l2r.drop([<span class="st">'mutual_info'</span>, <span class="st">'bcx_mutual_info'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>df_l2r.token.nunique(), df_l2r.label.nunique()</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>df_l2r.head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">token</th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">rank</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>0</td>
<td>866.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>1</td>
<td>1022.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>2</td>
<td>1156.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><strong><code>df_tiny</code></strong>: If we need a smaller dataset for quick iterations</p>
<p>Note: For technical reasons behind building a <code>L2RDataloader</code> the number of tokens should be <span class="math inline">\(x (mod 64) \equiv 8\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>num_toks, num_lbs <span class="op">=</span> <span class="dv">8</span> <span class="op">+</span> <span class="dv">5</span><span class="op">*</span><span class="dv">64</span>, <span class="dv">104</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># might have to repeat this a few times until the cell asserst true</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">101</span>)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>rnd_toks <span class="op">=</span> np.random.randint(<span class="dv">0</span>, <span class="bu">len</span>(df_l2r.token.unique()), size<span class="op">=</span>(num_toks,) )</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">101</span>)</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>rnd_lbs <span class="op">=</span> np.random.randint(<span class="dv">0</span>, <span class="bu">len</span>(df_l2r.label.unique()), size<span class="op">=</span>(num_lbs,) )</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> df_l2r.token.isin(rnd_toks) <span class="op">&amp;</span> df_l2r.label.isin(rnd_lbs)</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>df_tiny <span class="op">=</span> df_l2r[mask].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>test_eq(df_tiny.token.nunique(), num_toks) </span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>test_eq(df_tiny.label.nunique(), num_lbs) </span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a><span class="co"># df_tiny.apply(lambda x: x.nunique())</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>df_tiny.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">token</th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">rank</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>22</td>
<td>49</td>
<td>1877.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>22</td>
<td>239</td>
<td>21308.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>22</td>
<td>394</td>
<td>39854.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>22</td>
<td>436</td>
<td>8618.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>22</td>
<td>561</td>
<td>1646.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Let’s just delete the <code>df_l2r</code> to free up RAM:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># df_l2r = pd.DataFrame()</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="co"># lst = [df_l2r]</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="co"># del lst</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="co"># del df_l2r</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="co"># import gc; gc.collect()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Only for <code>df_tiny</code></strong>:</p>
<p>Due to random sampling the rankings are not uniform i.e., not from 0 to <code>num_toks</code>. A litte preprocessing to make sure that we have uniform rankings for all labels.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>grouped <span class="op">=</span> df_tiny.groupby(<span class="st">'label'</span>, group_keys<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sort_rerank(df, column<span class="op">=</span><span class="st">'rank'</span>):</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values(by<span class="op">=</span>column)</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'rank'</span>] <span class="op">=</span> <span class="bu">range</span>(<span class="bu">len</span>(df))</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>df_tiny <span class="op">=</span> grouped.<span class="bu">apply</span>(sort_rerank)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>dict_grouped <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">list</span>(df_tiny.groupby(<span class="st">'label'</span>)))</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="co"># checking a random label has ranks 0 thru `num_toks`</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>a_lbl <span class="op">=</span> random.choice(<span class="bu">list</span>(dict_grouped.keys()))</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>test_eq(<span class="bu">range</span>(num_toks), dict_grouped[a_lbl][<span class="st">'rank'</span>].values)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>dict_grouped[a_lbl].head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">token</th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">rank</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">5660</td>
<td>9679</td>
<td>3455</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">8364</td>
<td>13976</td>
<td>3455</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4620</td>
<td>6801</td>
<td>3455</td>
<td>2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">772</td>
<td>1788</td>
<td>3455</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2748</td>
<td>4458</td>
<td>3455</td>
<td>4</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Using Pandas <code>groupby</code> to add quantized <em>relevance scores</em> to each token-label pair based on the corresponding ranks:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>grouped <span class="op">=</span> df_tiny.groupby(<span class="st">'label'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dict_grouped = dict(list(grouped))</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="co"># _tmp = dict_grouped[16].copy()</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="co"># _tmp.head()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cut(df, qnts, column<span class="op">=</span><span class="st">'rank'</span>):</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>    num <span class="op">=</span> df.to_numpy()</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>    bins <span class="op">=</span> np.quantile(num[:, <span class="op">-</span><span class="dv">1</span>], qnts)</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>    num[:, <span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> <span class="bu">len</span>(bins) <span class="op">-</span> np.digitize(num[:, <span class="op">-</span><span class="dv">1</span>], bins)</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># bins = np.quantile(df['rank'], qnts)</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># df[column] = len(bins) - np.digitize(df['rank'], bins)</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># df[column] = pd.qcut(df[column], qnts, labels=labels)</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> num</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>qnts <span class="op">=</span> np.concatenate([array([<span class="dv">0</span>]), np.geomspace(<span class="fl">1e-2</span>, <span class="dv">1</span>, <span class="dv">10</span>)])</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>scored <span class="op">=</span> grouped.<span class="bu">apply</span>(cut, qnts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>11.9 ms ± 279 µs per loop (mean ± std. dev. of 15 runs, 50 loops each)</code></pre>
</div>
</div>
<p>Pandas <code>groupby</code> was just to ellucidate how we do the scoring. It ain’t all that good when dealing with big datasets. So in reality we are going to use tensorized implemnetation. Follow along:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>pdl <span class="op">=</span> PreLoadTrans(df_tiny, device<span class="op">=</span>torch.device(<span class="st">'cpu'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If interested please read sourcecode of <a href="10_l2r.data.load">[<code>PreLoadTrans.quantized_score</code>](https://debjyotiSRoy.github.io/xcube/l2r.data.load.html#preloadtrans.quantized_score)</a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># %%timeit -n 50 -r 15</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>scored_toks <span class="op">=</span> pdl.quantized_score()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 1e+03 ns, sys: 0 ns, total: 1e+03 ns
Wall time: 3.34 µs</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/deb/xcube/xcube/l2r/data/load.py:56: UserWarning: torch.searchsorted(): input value tensor is non-contiguous, this will lower the performance due to extra data copy when converting non-contiguous tensor to contiguous, please use contiguous input value tensor if possible. This message will only appear once per program. (Triggered internally at /opt/conda/conda-bld/pytorch_1670525541990/work/aten/src/ATen/native/BucketizationUtils.h:33.)
  relv_scores = bins.shape[0] - torch.searchsorted(bins.T, data[:, :, -1], right=False) # shape (8922, 57352)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>test_eqs(scored_toks.shape, </span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>         (df_tiny.label.nunique(), df_tiny.token.nunique(), <span class="dv">4</span>), </span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>         (pdl.num_lbs, pdl.num_toks, <span class="dv">4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Save if you want to! BTW <a href="https://debjyotiSRoy.github.io/xcube/data.external.html#untar_xxx"><code>untar_xxx</code></a> has got the one for the full dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>L(source.glob(<span class="st">"**/*scored*.pth"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(#1) [Path('/home/deb/.xcube/data/mimic3_l2r/scored_tokens.pth')]</code></pre>
</div>
</div>
<p>Create training and validation split:</p>
<p><strong>Remember</strong>: In <code>scored_toks</code> dim 0: labels, dim 1: 4 tuple (token, label, rank, score). Below is an example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>tok, lbl, rank, score <span class="op">=</span> L(scored_toks[<span class="dv">97</span>, <span class="dv">32</span>], use_list<span class="op">=</span><span class="va">True</span>).<span class="bu">map</span>(Tensor.item)</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>ic(tok, lbl, rank, score)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>ic| tok: 41514.0, lbl: 8124.0, rank: 234.0, score: 4.0</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>df_tiny[(df_tiny.token <span class="op">==</span> tok)  <span class="op">&amp;</span> (df_tiny.label <span class="op">==</span> lbl)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">token</th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">rank</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">23393</td>
<td>41514</td>
<td>8124</td>
<td>234</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><strong>Remember:</strong> For each label the tokens are ranked 0 through <code>num_toks</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>ranks <span class="op">=</span> scored_toks[:, :, <span class="dv">2</span>].unique(dim<span class="op">=</span><span class="dv">1</span>).sort(<span class="op">-</span><span class="dv">1</span>).values</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>ranks_shouldbe <span class="op">=</span> torch.arange(scored_toks.shape[<span class="dv">1</span>], dtype<span class="op">=</span>torch.<span class="bu">float</span>).expand(scored_toks.shape[<span class="dv">0</span>], <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>test_eq(ranks, ranks_shouldbe)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Remember:</strong> For each label <code>quantized_score</code> scores the tokens on a log scale based on their ranks. The score scale is 1-101: 101 being the highest score (assigned to most relevant token), and 1 is the lowest score (assigned to least relevant tokens).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>scores <span class="op">=</span> scored_toks[:, :, <span class="op">-</span><span class="dv">1</span>].unique(dim<span class="op">=</span><span class="dv">1</span>).sort(<span class="op">-</span><span class="dv">1</span>).values</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>scores[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([  1.,   1.,   1.,   1.,   2.,   2.,   2.,   2.,   2.,   2.,   3.,   3.,
          3.,   3.,   4.,   4.,   4.,   4.,   4.,   4.,   5.,   5.,   5.,   6.,
          6.,   6.,   6.,   6.,   6.,   7.,   7.,   7.,   7.,   7.,   8.,   8.,
          8.,   8.,   8.,   8.,   8.,   8.,   9.,   9.,   9.,   9.,   9.,   9.,
         10.,  10.,  10.,  10.,  11.,  11.,  11.,  11.,  11.,  11.,  12.,  12.,
         12.,  12.,  12.,  13.,  13.,  13.,  13.,  13.,  13.,  14.,  14.,  14.,
         14.,  15.,  15.,  15.,  16.,  16.,  16.,  17.,  17.,  17.,  17.,  17.,
         18.,  18.,  18.,  19.,  19.,  19.,  19.,  20.,  20.,  20.,  20.,  21.,
         21.,  21.,  21.,  22.,  22.,  22.,  22.,  23.,  23.,  23.,  23.,  24.,
         24.,  24.,  25.,  25.,  25.,  26.,  26.,  27.,  27.,  27.,  28.,  28.,
         29.,  29.,  30.,  30.,  31.,  31.,  32.,  32.,  33.,  34.,  34.,  35.,
         36.,  37.,  38.,  39.,  40.,  42.,  43.,  45.,  48.,  51.,  55.,  63.,
        101.])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>scored_toks, binned_toks, probs, is_valid, bin_size, bin_bds <span class="op">=</span> pdl.train_val_split()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 90.4 ms, sys: 3.56 ms, total: 94 ms
Wall time: 13.8 ms</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>val_sl <span class="op">=</span> pdl.pad_split()</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>test_eq(is_valid.<span class="bu">sum</span>(dim<span class="op">=-</span><span class="dv">1</span>).unique().item(), val_sl)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>val_sl<span class="op">=</span><span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>val_sl=16
CPU times: user 353 ms, sys: 0 ns, total: 353 ms
Wall time: 48.4 ms</code></pre>
</div>
</div>
<p>Taking a look at the train/valid split for some labels (just to make sure we ticked all boxes!):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>df1 <span class="op">=</span> pd.DataFrame(scored_toks[<span class="dv">89</span>], columns<span class="op">=</span>[<span class="st">'token'</span>, <span class="st">'label'</span>, <span class="st">'rank'</span>, <span class="st">'score'</span>]).sort_values(by<span class="op">=</span><span class="st">'score'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>df1.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">token</th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">rank</th>
<th data-quarto-table-cell-role="th">score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">226</td>
<td>28488.0</td>
<td>6820.0</td>
<td>0.0</td>
<td>101.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">225</td>
<td>2274.0</td>
<td>6820.0</td>
<td>1.0</td>
<td>63.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">224</td>
<td>50503.0</td>
<td>6820.0</td>
<td>2.0</td>
<td>55.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">223</td>
<td>56935.0</td>
<td>6820.0</td>
<td>3.0</td>
<td>51.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">222</td>
<td>20945.0</td>
<td>6820.0</td>
<td>4.0</td>
<td>48.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>name <span class="op">=</span> partial(namestr, namespace<span class="op">=</span><span class="bu">globals</span>())</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>row_vals <span class="op">=</span> <span class="bu">apply</span>(torch.Tensor.size, (scored_toks, binned_toks, probs, is_valid, bin_size, bin_bds))</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(index <span class="op">=</span> <span class="bu">list</span>(itertools.chain.from_iterable(<span class="bu">apply</span>(name, [scored_toks, binned_toks, probs, is_valid, bin_size, bin_bds]))), columns<span class="op">=</span>[<span class="st">'shape'</span>], data<span class="op">=</span>{<span class="st">'shape'</span>: row_vals})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">shape</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">scored_toks</td>
<td>(104, 328, 4)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">binned_toks</td>
<td>(104, 328)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">probs</td>
<td>(104, 328)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">is_valid</td>
<td>(104, 328)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">bin_size</td>
<td>(11,)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bin_bds</td>
<td>(8, 2)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Lowest numbered bin contains irrelevant tokens for a label, and the highest numbered bin contains most relevant tokens:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>df2 <span class="op">=</span> pd.DataFrame({<span class="st">'bin #'</span>: <span class="bu">range</span>(<span class="bu">len</span>(bin_size)), </span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>                    <span class="co">#'bin_bds': list(bin_bds.numpy()), </span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'bin_size'</span>: bin_size})</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>df2.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">bin #</th>
<th data-quarto-table-cell-role="th">bin_size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>30</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>180</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2</td>
<td>75</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>3</td>
<td>27</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>4</td>
<td>10</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>df_toks <span class="op">=</span> pd.read_feather(source<span class="op">/</span><span class="st">'mimic3-9k_tok.ft'</span>)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>df_lbs <span class="op">=</span> pd.read_feather(source<span class="op">/</span><span class="st">'mimic3-9k_lbl.ft'</span>)</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>a_lbl <span class="op">=</span> np.random.choice(pdl.num_lbs)</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>df_lbs.iloc[[a_lbl]]</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a><span class="co"># df_lbs.loc[[a_lbl]]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">lbl</th>
<th data-quarto-table-cell-role="th">lbl_val</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">52</td>
<td>52</td>
<td>018.95</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>df3 <span class="op">=</span> pd.DataFrame({<span class="st">'token'</span>: scored_toks[a_lbl, :, <span class="dv">0</span>] ,<span class="st">'score'</span>: scored_toks[a_lbl, :, <span class="op">-</span><span class="dv">1</span>], <span class="st">'probs'</span>: probs[a_lbl], </span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'binned_toks'</span>: binned_toks[a_lbl], </span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>                    <span class="co">#'bds': list(bin_bds[binned_toks[a_lbl]].numpy()), </span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'size'</span>: bin_size[binned_toks[a_lbl]], </span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'is_valid'</span>: is_valid[a_lbl]})</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>df3 <span class="op">=</span> df_toks.merge(df3, on<span class="op">=</span><span class="st">'token'</span>)</span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>df3.sort_values(by<span class="op">=</span><span class="st">'score'</span>, ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">token</th>
<th data-quarto-table-cell-role="th">tok_val</th>
<th data-quarto-table-cell-role="th">score</th>
<th data-quarto-table-cell-role="th">probs</th>
<th data-quarto-table-cell-role="th">binned_toks</th>
<th data-quarto-table-cell-role="th">size</th>
<th data-quarto-table-cell-role="th">is_valid</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">30</td>
<td>4924</td>
<td>distance</td>
<td>101.0</td>
<td>0.333333</td>
<td>10</td>
<td>1</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25</td>
<td>4056</td>
<td>defined</td>
<td>63.0</td>
<td>0.333333</td>
<td>6</td>
<td>1</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>2100</td>
<td>wnl</td>
<td>55.0</td>
<td>0.166667</td>
<td>5</td>
<td>4</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>436</td>
<td>change</td>
<td>51.0</td>
<td>0.166667</td>
<td>5</td>
<td>4</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>591</td>
<td>motion</td>
<td>48.0</td>
<td>0.166667</td>
<td>5</td>
<td>4</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>1327</td>
<td>residual</td>
<td>45.0</td>
<td>0.166667</td>
<td>5</td>
<td>4</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>22</td>
<td>patient</td>
<td>43.0</td>
<td>0.066667</td>
<td>4</td>
<td>10</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>1788</td>
<td>thursday</td>
<td>42.0</td>
<td>0.066667</td>
<td>4</td>
<td>10</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>1699</td>
<td>clopidogrel</td>
<td>40.0</td>
<td>0.066667</td>
<td>4</td>
<td>10</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>2021</td>
<td>saturations</td>
<td>39.0</td>
<td>0.066667</td>
<td>4</td>
<td>10</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>1944</td>
<td>4l</td>
<td>38.0</td>
<td>0.066667</td>
<td>4</td>
<td>10</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>2265</td>
<td>hemodynamics</td>
<td>37.0</td>
<td>0.066667</td>
<td>4</td>
<td>10</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">13</td>
<td>2467</td>
<td>according</td>
<td>36.0</td>
<td>0.066667</td>
<td>4</td>
<td>10</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12</td>
<td>2274</td>
<td>medial</td>
<td>35.0</td>
<td>0.066667</td>
<td>4</td>
<td>10</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>2998</td>
<td>synagis</td>
<td>34.0</td>
<td>0.066667</td>
<td>4</td>
<td>10</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>3159</td>
<td>film</td>
<td>34.0</td>
<td>0.066667</td>
<td>4</td>
<td>10</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>3748</td>
<td>dispo</td>
<td>33.0</td>
<td>0.024691</td>
<td>3</td>
<td>27</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">16</td>
<td>3401</td>
<td>twenty</td>
<td>32.0</td>
<td>0.024691</td>
<td>3</td>
<td>27</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>3575</td>
<td>attached</td>
<td>32.0</td>
<td>0.024691</td>
<td>3</td>
<td>27</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">27</td>
<td>4598</td>
<td>stopping</td>
<td>31.0</td>
<td>0.024691</td>
<td>3</td>
<td>27</td>
<td>0.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>test_eqs(is_valid[a_lbl].<span class="bu">sum</span>(), df3[<span class="st">'is_valid'</span>].<span class="bu">sum</span>(), pdl.val_sl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>df3[df3[<span class="st">'is_valid'</span>] <span class="op">==</span> <span class="dv">1</span>].sort_values(by<span class="op">=</span><span class="st">'score'</span>, ascending<span class="op">=</span><span class="va">False</span>)<span class="co">#.groupby('binned_toks').size()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">token</th>
<th data-quarto-table-cell-role="th">tok_val</th>
<th data-quarto-table-cell-role="th">score</th>
<th data-quarto-table-cell-role="th">probs</th>
<th data-quarto-table-cell-role="th">binned_toks</th>
<th data-quarto-table-cell-role="th">size</th>
<th data-quarto-table-cell-role="th">is_valid</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">25</td>
<td>4056</td>
<td>defined</td>
<td>63.0</td>
<td>0.333333</td>
<td>6</td>
<td>1</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">14</td>
<td>2998</td>
<td>synagis</td>
<td>34.0</td>
<td>0.066667</td>
<td>4</td>
<td>10</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">29</td>
<td>4750</td>
<td>ccy</td>
<td>29.0</td>
<td>0.024691</td>
<td>3</td>
<td>27</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>3469</td>
<td>brace</td>
<td>28.0</td>
<td>0.024691</td>
<td>3</td>
<td>27</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">28</td>
<td>4608</td>
<td>pericarditis</td>
<td>25.0</td>
<td>0.024691</td>
<td>3</td>
<td>27</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">170</td>
<td>32817</td>
<td>cadmium</td>
<td>19.0</td>
<td>0.008889</td>
<td>2</td>
<td>75</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">195</td>
<td>36874</td>
<td>discrepant</td>
<td>18.0</td>
<td>0.008889</td>
<td>2</td>
<td>75</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">47</td>
<td>8157</td>
<td>fundi</td>
<td>17.0</td>
<td>0.008889</td>
<td>2</td>
<td>75</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">272</td>
<td>48514</td>
<td>vorinostat</td>
<td>13.0</td>
<td>0.008889</td>
<td>2</td>
<td>75</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">306</td>
<td>54261</td>
<td>entroclysis</td>
<td>13.0</td>
<td>0.008889</td>
<td>2</td>
<td>75</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">114</td>
<td>21311</td>
<td>icbg</td>
<td>8.0</td>
<td>0.003704</td>
<td>1</td>
<td>180</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">183</td>
<td>35391</td>
<td>bender</td>
<td>5.0</td>
<td>0.003704</td>
<td>1</td>
<td>180</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">216</td>
<td>39783</td>
<td>susbsequently</td>
<td>4.0</td>
<td>0.003704</td>
<td>1</td>
<td>180</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">261</td>
<td>46217</td>
<td>cuurently</td>
<td>3.0</td>
<td>0.003704</td>
<td>1</td>
<td>180</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">302</td>
<td>53619</td>
<td>transfred</td>
<td>1.0</td>
<td>0.022222</td>
<td>0</td>
<td>30</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">322</td>
<td>56325</td>
<td>psuedoanuerysm</td>
<td>1.0</td>
<td>0.022222</td>
<td>0</td>
<td>30</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>top_lens <span class="op">=</span> pdl.count_topbins()</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>test_eq(top_lens.shape, [pdl.num_lbs])</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"For </span><span class="sc">{</span>torch<span class="sc">.</span>where(top_lens <span class="op">&gt;=</span> <span class="dv">1</span>)[<span class="dv">0</span>]<span class="sc">.</span>numel()<span class="sc">}</span><span class="ss"> labels out of total </span><span class="sc">{</span>pdl<span class="sc">.</span>num_lbs<span class="sc">}</span><span class="ss">, in the validation set we have at least one top 2 bin"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>For 56 labels out of total 104, in the validation set we have at least one top 2 bin</code></pre>
</div>
</div>
<p>Prepare the train/val dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>trn_dset, val_dset <span class="op">=</span> pdl.datasets()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>test_eq(val_dset.shape, (scored_toks.shape[<span class="dv">0</span>], val_sl, scored_toks.shape[<span class="dv">2</span>]))</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>test_eq(trn_dset.shape, scored_toks.shape) </span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>ic(trn_dset.shape, val_dset.shape)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>ic| trn_dset.shape: torch.Size([104, 328, 4])
    val_dset.shape: torch.Size([104, 16, 4])</code></pre>
</div>
</div>
<p>Again, <a href="https://debjyotiSRoy.github.io/xcube/data.external.html#untar_xxx"><code>untar_xxx</code></a> has got the trn/val split for the full dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>L(source.glob(<span class="st">"**/*split*.pkl"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(#1) [Path('/home/deb/.xcube/data/mimic3_l2r/trn_val_split.pkl')]</code></pre>
</div>
</div>
<p>If you want to load the splits for the full dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>trn_dset, val_dset <span class="op">=</span> torch.load(source<span class="op">/</span><span class="st">'trn_val_split.pkl'</span>)</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>ic(trn_dset.shape, val_dset.shape)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>ic| trn_dset.shape: torch.Size([8922, 57352, 4])
    val_dset.shape: torch.Size([8922, 32, 4])</code></pre>
</div>
</div>
<p>Now we are ready to create the train/valid <code>DataLoaders</code>:</p>
<p><strong>Implementation note:</strong> We have written the training dataloader which we call <a href="https://debjyotiSRoy.github.io/xcube/l2r.data.load.html#l2rdataloader"><code>L2RDataLoader</code></a>. It ofcourse inherits from fastai’s incredibly hackable <a href="https://docs.fast.ai/data.load.html#dataloader"><code>DataLoader</code></a> class. In a little more technical terms, another way to say this is that <a href="https://debjyotiSRoy.github.io/xcube/l2r.data.load.html#l2rdataloader"><code>L2RDataLoader</code></a> provides different implementation of the callbacks <code>before_iter</code> and <code>create_batches</code>. However for the validation dataloader we directly use fastai’s <code>DataLoader</code>. Lastly, we store the training and validation dataloder objects using fastai’s <a href="https://docs.fast.ai/data.core.html#dataloaders"><code>DataLoaders</code></a> class.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>bs_full <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>bs_tiny <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>sl <span class="op">=</span> <span class="dv">64</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>lbs_chunks_full <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>lbs_chunks_tiny <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>trn_dl <span class="op">=</span> L2RDataLoader(dataset<span class="op">=</span>trn_dset, sl<span class="op">=</span>sl, bs<span class="op">=</span>bs_tiny, lbs_chunks<span class="op">=</span>lbs_chunks_tiny, shuffle<span class="op">=</span><span class="va">False</span>, after_batch<span class="op">=</span>partial(to_device, device<span class="op">=</span>default_device(use<span class="op">=</span><span class="va">True</span>)), num_workers<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Don’t forget to check the length</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(trn_dl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>24</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>ic(trn_dl.num_workers, trn_dl.fake_l.num_workers)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>ic| trn_dl.num_workers: 1, trn_dl.fake_l.num_workers: 0</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>xb <span class="op">=</span> trn_dl.one_batch()</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>ic(xb.shape, xb.device)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>ic| xb.shape: torch.Size([8, 4, 64, 4])
    xb.device: device(type='cuda', index=0)</code></pre>
</div>
</div>
<p>A fake rundown of the training loop to make sure the training dataloader got created alright:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> xb <span class="kw">in</span> progress_bar(trn_dl):</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="24" class="" max="24" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [24/24 00:00&lt;00:00]
    </div>
    
</div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 1.4 s, sys: 12.8 ms, total: 1.41 s
Wall time: 298 ms</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.data.load <span class="im">import</span> DataLoader</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.data.core <span class="im">import</span> DataLoaders</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>val_dset <span class="op">=</span> val_dset.unsqueeze(<span class="dv">0</span>)</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>val_dl <span class="op">=</span> DataLoader(val_dset, bs<span class="op">=</span><span class="dv">1</span>, shuffle<span class="op">=</span><span class="va">False</span>, after_batch<span class="op">=</span>partial(to_device, device<span class="op">=</span>default_device()), num_workers<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>ic(val_dl.num_workers, val_dl.fake_l.num_workers)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>ic| val_dl.num_workers: 1, val_dl.fake_l.num_workers: 0</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>xb <span class="op">=</span> val_dl.one_batch()</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>ic(xb.shape, xb.device)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>ic| xb.shape: torch.Size([1, 104, 16, 4])
    xb.device: device(type='cuda', index=0)</code></pre>
</div>
</div>
<p>A fake rundown of the validation set to make sure the validation dataloader got created alright:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> xb <span class="kw">in</span> progress_bar(val_dl):</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="1" class="" max="1" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [1/1 00:00&lt;00:00]
    </div>
    
</div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 6.07 ms, sys: 0 ns, total: 6.07 ms
Wall time: 15.8 ms</code></pre>
</div>
</div>
<p>Bunching together the training and validation dataloaders:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> DataLoaders(trn_dl, val_dl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="training" class="level2">
<h2 class="anchored" data-anchor-id="training">Training</h2>
<p>…yes, finally!</p>
<section id="keeping-records" class="level4">
<h4 class="anchored" data-anchor-id="keeping-records"><strong>Keeping records:</strong></h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> [<span class="st">'lin'</span>, <span class="st">'nn'</span>]</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>algos <span class="op">=</span> [<span class="st">'ranknet'</span>, <span class="st">'lambdarank'</span>]</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> pd.Index([<span class="st">'tiny'</span>, <span class="st">'full'</span>], name<span class="op">=</span><span class="st">'dataset'</span>)</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> pd.MultiIndex.from_product([m, algos], names <span class="op">=</span> [<span class="st">'model'</span>, <span class="st">'algo'</span>])</span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(columns<span class="op">=</span>cols, index<span class="op">=</span>idx)</span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>df[:] <span class="op">=</span> <span class="st">'TBD'</span></span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>df.loc[<span class="st">'tiny'</span>][<span class="st">'nn'</span>][<span class="st">'ranknet'</span>] <span class="op">=</span> <span class="st">"{'grad_func': functools.partial(&lt;function rank_loss3 at 0x7f6f87e800d0&gt;, gain_fn='exp', k=6), 'opt_func': functools.partial(&lt;function RMSProp at 0x7f6f87e31870&gt;, mom=0.9, wd=0.2), 'opt': None, 'lr': 0.001, 'loss_func': &lt;function loss_fn2 at 0x7f6f7cdb1990&gt;, 'num_factors': 200, 'n_act': 100, 'num_lbs': 105, 'num_toks': 329, 'seed': 877979, 'epochs': 15, 'best': 75.66}"</span></span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a>df.loc[<span class="st">'tiny'</span>][<span class="st">'lin'</span>][<span class="st">'ranknet'</span>] <span class="op">=</span> <span class="st">"{'grad_func': functools.partial(&lt;function rank_loss3 at 0x7f6f87e800d0&gt;, gain_fn='exp', k=6), 'opt_func': functools.partial(&lt;function SGD at 0x7f6f87e31750&gt;, mom=0.9), 'opt': None, 'lr': 0.0001, 'loss_func': &lt;function loss_fn2 at 0x7f6f73f748b0&gt;, 'num_factors': 200, 'num_lbs': 105, 'num_toks': 329, 'seed': 877979, 'epochs': 15, 'best': 75}"</span></span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a>df.loc[<span class="st">'tiny'</span>][<span class="st">'nn'</span>][<span class="st">'lambdarank'</span>] <span class="op">=</span> <span class="st">"{'grad_func': functools.partial(&lt;function rank_loss3 at 0x7fdc0ed6ad40&gt;, gain_fn='exp', k=15, lambrank=True), 'opt_func': functools.partial(&lt;function RMSProp at 0x7fdc0ed28280&gt;, mom=0.9, wd=0.0), 'opt': &lt;fastai.optimizer.Optimizer object at 0x7fdc0ede79a0&gt;, 'lr': 0.001, 'loss_func': &lt;function loss_fn2 at 0x7fdc0ed6ae60&gt;, 'lr_max': 0.01445439737290144, 'num_factors': 200, 'n_act': 100, 'num_lbs': 105, 'num_toks': 329, 'seed': 1, 'epochs': 15, 'best': 'ndcg_at_6 = 39.05', 'model': 'L2R_NN(</span><span class="ch">\\</span><span class="st">n  (token_factors): Embedding(329, 200, padding_idx=328)</span><span class="ch">\\</span><span class="st">n  (label_factors): Embedding(105, 200, padding_idx=104)</span><span class="ch">\\</span><span class="st">n  (layers): Sequential(</span><span class="ch">\\</span><span class="st">n    (0): Linear(in_features=200, out_features=100, bias=True)</span><span class="ch">\\</span><span class="st">n    (1): ReLU()</span><span class="ch">\\</span><span class="st">n    (2): Linear(in_features=100, out_features=1, bias=True)</span><span class="ch">\\</span><span class="st">n    (3): Dropout(p=0.2, inplace=False)</span><span class="ch">\\</span><span class="st">n  )</span><span class="ch">\\</span><span class="st">n)</span><span class="ch">\\</span><span class="st">n self.n_act = 100, self.dp = 0.2'}"</span></span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a>df.loc[<span class="st">'tiny'</span>][<span class="st">'lin'</span>][<span class="st">'lambdarank'</span>] <span class="op">=</span> <span class="st">"{'grad_func': functools.partial(&lt;function rank_loss3 at 0x7f4c7dd42c20&gt;, gain_fn='exp', k=15, lambrank=True), 'opt_func': functools.partial(&lt;function RMSProp at 0x7f4c7dd04160&gt;, mom=0.9, wd=0.0), 'opt': &lt;fastai.optimizer.Optimizer object at 0x7f4c5c1da410&gt;, 'lr': 0.007, 'loss_func': &lt;function loss_fn2 at 0x7f4c74b9add0&gt;, 'num_factors': 200, 'n_act': None, 'num_lbs': 105, 'num_toks': 329, 'seed': 1, 'epochs': 15, 'best': 52.21}"</span></span>
<span id="cb132-13"><a href="#cb132-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-14"><a href="#cb132-14" aria-hidden="true" tabindex="-1"></a>df.loc[<span class="st">'full'</span>][<span class="st">'nn'</span>][<span class="st">'ranknet'</span>] <span class="op">=</span> <span class="st">'TBD'</span></span>
<span id="cb132-15"><a href="#cb132-15" aria-hidden="true" tabindex="-1"></a>df.loc[<span class="st">'full'</span>][<span class="st">'lin'</span>][<span class="st">'ranknet'</span>] <span class="op">=</span> {<span class="st">'lr'</span>: <span class="fl">1e-5</span>, <span class="st">'opt'</span>: <span class="st">'partial(SGD, mom=0.9, wd=0.0)'</span>, <span class="st">'best'</span>: <span class="fl">63.73</span>, <span class="st">'epochs'</span>: <span class="dv">3</span>, <span class="st">'seed'</span>: <span class="dv">1</span>, <span class="st">'gain'</span>: <span class="st">'cubic'</span>, <span class="st">'factors'</span>: <span class="dv">100</span>}</span>
<span id="cb132-16"><a href="#cb132-16" aria-hidden="true" tabindex="-1"></a>df.loc[<span class="st">'full'</span>][<span class="st">'nn'</span>][<span class="st">'lambdarank'</span>] <span class="op">=</span> <span class="st">'TBD'</span></span>
<span id="cb132-17"><a href="#cb132-17" aria-hidden="true" tabindex="-1"></a>df.loc[<span class="st">'full'</span>][<span class="st">'lin'</span>][<span class="st">'lambdarank'</span>] <span class="op">=</span> {<span class="st">'lr'</span>: [<span class="fl">7e-4</span>, <span class="fl">7e-4</span>, <span class="fl">7e-4</span>], <span class="st">'opt'</span>: <span class="st">'partial(RMSProp, mom=0.9, wd=0.0)'</span>, <span class="st">'best'</span>: <span class="fl">12.85</span>, <span class="st">'epochs'</span>: [<span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">4</span>], <span class="st">'seed'</span>: <span class="dv">1</span>, <span class="st">'gain'</span>: <span class="st">'exp'</span>, <span class="st">'factors'</span>: <span class="dv">200</span>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">model</th>
<th colspan="2" data-quarto-table-cell-role="th" data-halign="left">lin</th>
<th colspan="2" data-quarto-table-cell-role="th" data-halign="left">nn</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">algo</th>
<th data-quarto-table-cell-role="th">ranknet</th>
<th data-quarto-table-cell-role="th">lambdarank</th>
<th data-quarto-table-cell-role="th">ranknet</th>
<th data-quarto-table-cell-role="th">lambdarank</th>
</tr>
<tr class="header">
<th data-quarto-table-cell-role="th">dataset</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">tiny</td>
<td>{'grad_func': functools.partial(&lt;function rank_loss3 at 0x7f6f87e800d0&gt;, gain_fn='exp', k=6), 'opt_func': functools.partial(&lt;function SGD at 0x7f6f87e31750&gt;, mom=0.9), 'opt': None, 'lr': 0.0001, 'loss_func': &lt;function loss_fn2 at 0x7f6f73f748b0&gt;, 'num_factors': 200, 'num_lbs': 105, 'num_toks': 329, 'seed': 877979, 'epochs': 15, 'best': 75}</td>
<td>{'grad_func': functools.partial(&lt;function rank_loss3 at 0x7f4c7dd42c20&gt;, gain_fn='exp', k=15, lambrank=True), 'opt_func': functools.partial(&lt;function RMSProp at 0x7f4c7dd04160&gt;, mom=0.9, wd=0.0), 'opt': &lt;fastai.optimizer.Optimizer object at 0x7f4c5c1da410&gt;, 'lr': 0.007, 'loss_func': &lt;function loss_fn2 at 0x7f4c74b9add0&gt;, 'num_factors': 200, 'n_act': None, 'num_lbs': 105, 'num_toks': 329, 'seed': 1, 'epochs': 15, 'best': 52.21}</td>
<td>{'grad_func': functools.partial(&lt;function rank_loss3 at 0x7f6f87e800d0&gt;, gain_fn='exp', k=6), 'opt_func': functools.partial(&lt;function RMSProp at 0x7f6f87e31870&gt;, mom=0.9, wd=0.2), 'opt': None, 'lr': 0.001, 'loss_func': &lt;function loss_fn2 at 0x7f6f7cdb1990&gt;, 'num_factors': 200, 'n_act': 100, 'num_lbs': 105, 'num_toks': 329, 'seed': 877979, 'epochs': 15, 'best': 75.66}</td>
<td>{'grad_func': functools.partial(&lt;function rank_loss3 at 0x7fdc0ed6ad40&gt;, gain_fn='exp', k=15, lambrank=True), 'opt_func': functools.partial(&lt;function RMSProp at 0x7fdc0ed28280&gt;, mom=0.9, wd=0.0), 'opt': &lt;fastai.optimizer.Optimizer object at 0x7fdc0ede79a0&gt;, 'lr': 0.001, 'loss_func': &lt;function loss_fn2 at 0x7fdc0ed6ae60&gt;, 'lr_max': 0.01445439737290144, 'num_factors': 200, 'n_act': 100, 'num_lbs': 105, 'num_toks': 329, 'seed': 1, 'epochs': 15, 'best': 'ndcg_at_6 = 39.05', 'model': 'L2R_NN(\n (token_factors): Embedding(329, 200, padding_idx=328)\n (label_factors): Embedding(105, 200, paddin...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">full</td>
<td>{'lr': 1e-05, 'opt': 'partial(SGD, mom=0.9, wd=0.0)', 'best': 63.73, 'epochs': 3, 'seed': 1, 'gain': 'cubic', 'factors': 100}</td>
<td>{'lr': [0.0007, 0.0007, 0.0007], 'opt': 'partial(RMSProp, mom=0.9, wd=0.0)', 'best': 12.85, 'epochs': [4, 2, 4, 4], 'seed': 1, 'gain': 'exp', 'factors': 200}</td>
<td>TBD</td>
<td>TBD</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="get-the-dataloaders" class="level4">
<h4 class="anchored" data-anchor-id="get-the-dataloaders"><strong>Get the <code>DataLoaders</code>:</strong></h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>tmp <span class="op">=</span> Path.cwd()<span class="op">/</span><span class="st">'tmp'</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>tmp.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>list_files(<span class="bu">str</span>(tmp))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tmp/
    mimic3-9k_dls_clas_tiny.pkl
    nn_lambdarank_tiny.pth
    mimic3-9k_dls_clas_tiny_r.pkl
    dls_full.pkl
    dls_tiny.pkl
    lin_lambdarank_full.pth
    lin_lambdarank_tiny.pth
    .ipynb_checkpoints/
    models/
        mimic3-9k_lm_finetuned_r.pth
        mimic3-9k_clas_full.pth
        mimic3-9k_clas_tiny_r.pth
        mimic3-9k_lm_finetuned.pth
        mimic3-9k_clas_tiny_vocab.pkl
        mimic3-9k_clas_tiny_r_vocab.pkl
        mimic3-9k_clas_tiny.pth
        mimic3-9k_clas_full_vocab.pkl</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>set_seed(<span class="dv">1</span>, <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Setting the <code>fname</code> capturing which model (neural net vs linear) we want to run, which algorithm (ranknet vs lambdarank) and on which dataset (tiny vs full). This <code>fname</code> is then used to automaticall grab the appropriate dataloder, make the model and set relevant learner parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>fname <span class="op">=</span> <span class="st">'lin_lambdarank_tiny'</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>monitor <span class="op">=</span> <span class="st">'ndcg_at_6'</span> <span class="cf">if</span> <span class="st">'lambda'</span> <span class="kw">in</span> fname <span class="cf">else</span> <span class="st">'acc'</span></span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> fname.split(<span class="st">'_'</span>)</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'We will run a </span><span class="sc">{</span>s[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> model using the </span><span class="sc">{</span>s[<span class="dv">1</span>]<span class="sc">}</span><span class="ss"> algorithm on the </span><span class="sc">{</span>s[<span class="dv">2</span>]<span class="sc">}</span><span class="ss"> dataset. And our metric of interest(moi) is </span><span class="sc">{</span>monitor<span class="sc">}</span><span class="ss">.'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>We will run a lin model using the lambdarank algorithm on the tiny dataset. And our metric of interest(moi) is ndcg_at_6.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 11.7 ms, sys: 8.62 s, total: 8.63 s
Wall time: 15.3 s</code></pre>
</div>
</div>
</section>
<section id="make-the-model" class="level4">
<h4 class="anchored" data-anchor-id="make-the-model"><strong>Make the Model:</strong></h4>
<p>Based on the dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>Datasizes <span class="op">=</span> namedtuple(<span class="st">"Datasizes"</span>, (<span class="st">'num_lbs'</span>, <span class="st">'num_toks'</span>, <span class="st">'num_factors'</span>))</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>sizes <span class="op">=</span> Datasizes(<span class="op">*</span>dls.dataset.shape[:<span class="op">-</span><span class="dv">1</span>], <span class="dv">200</span>) <span class="co"># or pdl.num_lbs, pdl.num_toks, 200</span></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>sizes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Datasizes(num_lbs=104, num_toks=328, num_factors=200)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> (L2R_NN(<span class="op">*</span>sizes, layers<span class="op">=</span>[<span class="dv">100</span>], embed_p<span class="op">=</span><span class="fl">0.2</span>, ps<span class="op">=</span>[<span class="fl">0.1</span>], bn_final<span class="op">=</span><span class="va">False</span>, y_range<span class="op">=</span><span class="va">None</span>) <span class="cf">if</span> <span class="st">'nn'</span> <span class="kw">in</span> fname <span class="cf">else</span> L2R_DotProductBias(<span class="op">*</span>sizes,y_range<span class="op">=</span><span class="va">None</span>)).to(default_device())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Create the <code>Learner</code> and train:</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.optimizer <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> grab_learner_params(fname):</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Get relevant `learner` params depending on the `fname`"</span></span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>    nn, lambrank, tiny <span class="op">=</span>  [sp <span class="op">==</span> n <span class="cf">for</span> sp, n <span class="kw">in</span> <span class="bu">zip</span>(fname.split(<span class="st">'_'</span>), [<span class="st">'nn'</span>, <span class="st">'lambdarank'</span>, <span class="st">'tiny'</span>])]</span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create a dictionary that maps binary conditions to tuple (nn, lambdarank, tiny)</span></span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a>    conditions <span class="op">=</span> {</span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a>        (<span class="va">True</span>, <span class="va">True</span>, <span class="va">True</span>):  <span class="bu">dict</span>(lr <span class="op">=</span> <span class="fl">1e-3</span>, lambrank <span class="op">=</span> lambrank, opt_func <span class="op">=</span> partial(RMSProp, mom<span class="op">=</span><span class="fl">0.9</span>, wd<span class="op">=</span><span class="fl">0.0</span>)),   <span class="co"># nn_lambdarank_tiny</span></span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a>        (<span class="va">True</span>, <span class="va">True</span>, <span class="va">False</span>): <span class="bu">dict</span>(lr <span class="op">=</span> <span class="fl">1e-2</span>, lambrank <span class="op">=</span> lambrank, opt_func <span class="op">=</span> partial(Adam, mom<span class="op">=</span><span class="fl">0.9</span>, wd<span class="op">=</span><span class="fl">0.1</span>)),   <span class="co"># nn_lambdarank_full</span></span>
<span id="cb145-9"><a href="#cb145-9" aria-hidden="true" tabindex="-1"></a>        (<span class="va">True</span>, <span class="va">False</span>, <span class="va">True</span>):  <span class="bu">dict</span>(lr <span class="op">=</span> <span class="fl">1e-2</span>, lambrank <span class="op">=</span> lambrank, opt_func <span class="op">=</span> partial(RMSProp, mom<span class="op">=</span><span class="fl">0.9</span>, wd<span class="op">=</span><span class="fl">0.2</span>)),  <span class="co"># nn_ranknet_tiny</span></span>
<span id="cb145-10"><a href="#cb145-10" aria-hidden="true" tabindex="-1"></a>        (<span class="va">True</span>, <span class="va">False</span>, <span class="va">False</span>): <span class="bu">dict</span>(lr <span class="op">=</span> <span class="va">None</span>, lambrank <span class="op">=</span> lambrank, opt_func <span class="op">=</span> <span class="va">None</span>),  <span class="co"># nn_ranknet_full</span></span>
<span id="cb145-11"><a href="#cb145-11" aria-hidden="true" tabindex="-1"></a>        (<span class="va">False</span>, <span class="va">True</span>, <span class="va">True</span>): <span class="bu">dict</span>(lr <span class="op">=</span> <span class="fl">7e-3</span>, lambrank <span class="op">=</span> lambrank, opt_func <span class="op">=</span> partial(RMSProp, mom<span class="op">=</span><span class="fl">0.9</span>, wd<span class="op">=</span><span class="fl">0.0</span>)),   <span class="co"># lin_lambdarank_tiny</span></span>
<span id="cb145-12"><a href="#cb145-12" aria-hidden="true" tabindex="-1"></a>        (<span class="va">False</span>, <span class="va">True</span>, <span class="va">False</span>): <span class="bu">dict</span>(lr <span class="op">=</span> <span class="fl">7e-3</span>, lambrank <span class="op">=</span> lambrank, opt_func <span class="op">=</span> partial(RMSProp, mom<span class="op">=</span><span class="fl">0.9</span>, wd<span class="op">=</span><span class="fl">0.0</span>)),  <span class="co"># lin_lambdarank_full</span></span>
<span id="cb145-13"><a href="#cb145-13" aria-hidden="true" tabindex="-1"></a>        (<span class="va">False</span>, <span class="va">False</span>, <span class="va">True</span>): <span class="bu">dict</span>(lr <span class="op">=</span> <span class="fl">1e-4</span>, lambrank <span class="op">=</span> lambrank, opt_func <span class="op">=</span> <span class="va">None</span>),  <span class="co"># lin_ranknet_tiny</span></span>
<span id="cb145-14"><a href="#cb145-14" aria-hidden="true" tabindex="-1"></a>        (<span class="va">False</span>, <span class="va">False</span>, <span class="va">False</span>): <span class="bu">dict</span>(lr <span class="op">=</span> <span class="va">None</span>, lambrank <span class="op">=</span> lambrank, opt_func <span class="op">=</span> <span class="va">None</span>), <span class="co"># lin_ranknet_full</span></span>
<span id="cb145-15"><a href="#cb145-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb145-16"><a href="#cb145-16" aria-hidden="true" tabindex="-1"></a>    learner_params <span class="op">=</span> conditions.get((nn, lambrank, tiny), (<span class="va">True</span>, <span class="va">True</span>, <span class="va">True</span>))</span>
<span id="cb145-17"><a href="#cb145-17" aria-hidden="true" tabindex="-1"></a>    default_cbs <span class="op">=</span> [TrainEval(), TrackResults(train_metrics<span class="op">=</span><span class="va">False</span>, beta<span class="op">=</span><span class="fl">0.98</span>), ProgressBarCallback(), Monitor(), SaveCallBack(fname, monitor<span class="op">=</span>monitor)]</span>
<span id="cb145-18"><a href="#cb145-18" aria-hidden="true" tabindex="-1"></a>    grad_fn <span class="op">=</span> partial(rank_loss3, gain_fn<span class="op">=</span><span class="st">'exp'</span>, k<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb145-19"><a href="#cb145-19" aria-hidden="true" tabindex="-1"></a>    learner_params <span class="op">=</span> {<span class="op">**</span>learner_params, <span class="op">**</span>{<span class="st">'cbs'</span>:default_cbs, <span class="st">'grad_fn'</span>:grad_fn}}</span>
<span id="cb145-20"><a href="#cb145-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> learner_params</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>learner_params <span class="op">=</span> grab_learner_params(fname)</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>learner_params</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'lr': 0.007,
 'lambrank': True,
 'opt_func': functools.partial(&lt;function RMSProp&gt;, mom=0.9, wd=0.0),
 'cbs': [TrainEval, TrackResults, ProgressBarCallback, Monitor, SaveCallBack],
 'grad_fn': functools.partial(&lt;function rank_loss3&gt;, gain_fn='exp', k=15)}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>learner <span class="op">=</span> get_learner(model, dls, <span class="op">**</span>learner_params)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>learner.path <span class="op">=</span> tmp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s record some useful hyperparameters in a record dict which we can store in the dataframe in the record keeping section:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>learner_attrs <span class="op">=</span> [<span class="st">'grad_func'</span>, <span class="st">'opt_func'</span>, <span class="st">'opt'</span>, <span class="st">'lr'</span>, <span class="st">'loss_func'</span>, <span class="st">'lr_max'</span>]</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>model_attrs <span class="op">=</span> [<span class="st">'num_factors'</span>, <span class="st">'n_act'</span>, <span class="st">'num_lbs'</span>, <span class="st">'num_toks'</span>]</span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>record <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(learner_attrs <span class="op">+</span> model_attrs, getattrs(learner, <span class="op">*</span>learner_attrs) <span class="op">+</span> getattrs(learner.model, <span class="op">*</span>model_attrs)))</span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>record[<span class="st">'seed'</span>] <span class="op">=</span> torch.initial_seed()</span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>record[<span class="st">'epochs'</span>] <span class="op">=</span> <span class="dv">15</span></span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a>record[<span class="st">'best'</span>] <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>monitor<span class="sc">}</span><span class="ss"> = 37.97'</span></span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a>record[<span class="st">'model'</span>] <span class="op">=</span> <span class="bu">str</span>(learner.model)</span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a><span class="bu">str</span>(record)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>"{'grad_func': functools.partial(&lt;function rank_loss3&gt;, gain_fn='exp', k=15, lambrank=True), 'opt_func': functools.partial(&lt;function RMSProp&gt;, mom=0.9, wd=0.0), 'opt': None, 'lr': 0.007, 'loss_func': &lt;function loss_fn2&gt;, 'lr_max': None, 'num_factors': 200, 'n_act': None, 'num_lbs': 105, 'num_toks': 329, 'seed': 1, 'epochs': 15, 'best': 'ndcg_at_6 = 37.97', 'model': 'L2R_DotProductBias(\\n  (token_factors): Embedding(329, 200, padding_idx=328)\\n  (token_bias): Embedding(329, 1, padding_idx=328)\\n  (label_factors): Embedding(105, 200, padding_idx=104)\\n  (label_bias): Embedding(105, 1, padding_idx=104)\\n)'}"</code></pre>
</div>
</div>
<p>Finding learning rate:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.callback.schedule <span class="im">import</span> valley, slide, steep</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>learner.xrl_find(num_it<span class="op">=</span><span class="dv">300</span>, suggest_funcs<span class="op">=</span>(valley, slide, steep))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Smoothing ndcg_at_6
0 True 1.2428 0.732 0.6955 0.6977
0 False NA NA NA NA
1 True 1.2239 0.7202 0.6793 0.6992
1 False NA NA NA NA</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<pre><code>SuggestedLRs(valley=0.010964781977236271, slide=0.05248074606060982, steep=0.07356422394514084)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="17_tutorial.train_l2r_files/figure-html/cell-108-output-5.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co"># learner.fit_one_cycle(1, lr_max=0.014454)</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="co"># learner.fit_one_cycle(15, lr_max=0.014454)</span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a><span class="co"># learner.fit_one_cycle(1, lr_max=0.0611)</span></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a><span class="co"># learner.fit_one_cycle(3, lr_max=0.0611)</span></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a><span class="co"># learner.fit_one_cycle(1, lr_max=0.01239)</span></span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a><span class="co"># learner.fit_one_cycle(3, lr_max=0.01239)</span></span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a>learner.fit_one_cycle(<span class="dv">1</span>, lr_max<span class="op">=</span><span class="fl">0.010964</span>)</span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a>learner.fit_one_cycle(<span class="dv">3</span>, lr_max<span class="op">=</span><span class="fl">0.010964</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>0 True 1.3046 NA NA NA
0 False 0.9848 0.774 0.7596 0.7612
0 True 1.2438 NA NA NA
0 False 0.9702 0.7635 0.7474 0.7637
1 True 1.2317 NA NA NA
1 False 0.9498 0.7723 0.7571 0.7631
2 True 1.2137 NA NA NA
2 False 0.9418 0.7711 0.756 0.764</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>learner.track_results.plot_sched()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="17_tutorial.train_l2r_files/figure-html/cell-110-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="co"># len(learner.cbs[1].grads_full['token_factors.weight'])</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a><span class="co"># learner.cbs</span></span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a><span class="co"># learner.track_results</span></span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a><span class="co"># learner.opt.hypers[-1]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>learner <span class="op">=</span> learner.load(fname, device<span class="op">=</span>default_device())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>learner.validate()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>0 False 1.0591 0.7812 0.7686 0.76</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>learner.cbs[<span class="op">-</span><span class="dv">1</span>].best <span class="op">=</span> <span class="fl">0.7686</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="co"># emb_szs = get_emb_sz(dls.train_ds, {})</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="plots" class="level4">
<h4 class="anchored" data-anchor-id="plots">Plots</h4>
<p><strong>Plotting losses and metrics:</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>,<span class="dv">8</span>))</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> L(loss_logger).<span class="bu">map</span>(torch.Tensor.item)</span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>val_loss <span class="op">=</span> L(metric_logger).itemgot(<span class="dv">0</span>)</span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a>val_acc <span class="op">=</span> L(metric_logger).itemgot(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a>val_ndcg <span class="op">=</span> L(metric_logger).itemgot(<span class="dv">2</span>)</span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-7"><a href="#cb165-7" aria-hidden="true" tabindex="-1"></a><span class="co"># axes[0,0].scatter(range(len(loss)), loss)</span></span>
<span id="cb165-8"><a href="#cb165-8" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>,<span class="dv">0</span>].plot(<span class="bu">range</span>(<span class="bu">len</span>(loss)), loss)</span>
<span id="cb165-9"><a href="#cb165-9" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>,<span class="dv">0</span>].set_xlabel(<span class="st">'batches*epochs'</span>)</span>
<span id="cb165-10"><a href="#cb165-10" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'train loss'</span>)</span>
<span id="cb165-11"><a href="#cb165-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-12"><a href="#cb165-12" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>,<span class="dv">1</span>].plot(val_loss)</span>
<span id="cb165-13"><a href="#cb165-13" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>,<span class="dv">1</span>].set_xlabel(<span class="st">'epochs'</span>)</span>
<span id="cb165-14"><a href="#cb165-14" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'val loss'</span>)</span>
<span id="cb165-15"><a href="#cb165-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-16"><a href="#cb165-16" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">0</span>].plot(val_acc)</span>
<span id="cb165-17"><a href="#cb165-17" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>,<span class="dv">0</span>].set_xlabel(<span class="st">'epochs'</span>)</span>
<span id="cb165-18"><a href="#cb165-18" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>,<span class="dv">0</span>].set_ylabel(<span class="st">'val accuracy'</span>)</span>
<span id="cb165-19"><a href="#cb165-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-20"><a href="#cb165-20" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>,<span class="dv">1</span>].plot(val_ndcg)</span>
<span id="cb165-21"><a href="#cb165-21" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>,<span class="dv">1</span>].set_xlabel(<span class="st">'epochs'</span>)</span>
<span id="cb165-22"><a href="#cb165-22" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>,<span class="dv">1</span>].set_ylabel(<span class="st">'val ndcg@6 (candidate 16)'</span>)</span>
<span id="cb165-23"><a href="#cb165-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-24"><a href="#cb165-24" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Plotting Statistics of the Model Parameters</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>,<span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>,<span class="dv">8</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (k,v), ax <span class="kw">in</span> <span class="bu">zip</span>(grad_logger.items(), axes.flatten()):</span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>    mean_grads <span class="op">=</span> L(v).<span class="bu">map</span>(compose(torch.Tensor.square, torch.Tensor.mean, torch.Tensor.sqrt, torch.Tensor.item))</span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sparsity = L(v).map(sparsity)</span></span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a>    ax.plot(mean_grads, color<span class="op">=</span><span class="st">'r'</span>, label<span class="op">=</span><span class="st">'mean'</span>)</span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(k)</span>
<span id="cb166-7"><a href="#cb166-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ax_a = ax.twinx()</span></span>
<span id="cb166-8"><a href="#cb166-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ax_a.plot(sparsity, color='b', label='sparsity')</span></span>
<span id="cb166-9"><a href="#cb166-9" aria-hidden="true" tabindex="-1"></a>    ax.legend(loc<span class="op">=</span><span class="st">'best'</span>)</span>
<span id="cb166-10"><a href="#cb166-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ax_a.legend(loc='best')</span></span>
<span id="cb166-11"><a href="#cb166-11" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">'RMS of the Gradients of Model Parameters'</span>)</span>
<span id="cb166-12"><a href="#cb166-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sparsity(t): </span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span> <span class="op">-</span> (torch.count_nonzero(t)<span class="op">/</span>t.numel()).item()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>,<span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>,<span class="dv">8</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (k,v), ax <span class="kw">in</span> <span class="bu">zip</span>(grad_logger.items(), axes.flatten()):</span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a>    sp <span class="op">=</span> L(v).<span class="bu">map</span>(sparsity)</span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>    ax.scatter(<span class="bu">range</span>(<span class="bu">len</span>(sp)), sp, color<span class="op">=</span><span class="st">'r'</span>, label<span class="op">=</span><span class="st">'sparsity'</span>)</span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(k)</span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ax_a = ax.twinx()</span></span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ax_a.plot(sparsity, color='b', label='sparsity')</span></span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a>    ax.legend(loc<span class="op">=</span><span class="st">'best'</span>)</span>
<span id="cb168-9"><a href="#cb168-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ax_a.legend(loc='best')</span></span>
<span id="cb168-10"><a href="#cb168-10" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">'Sparsity of the Model Parameters'</span>)</span>
<span id="cb168-11"><a href="#cb168-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="analysis-to-find-out-what-the-l2r-model-is-upto" class="level4">
<h4 class="anchored" data-anchor-id="analysis-to-find-out-what-the-l2r-model-is-upto">Analysis to find out what the L2R model is upto:</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> to_device(learner.dls.train.dataset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>_ndcg_at_k <span class="op">=</span> ndcg_at_k(dataset, learner.model, k<span class="op">=</span><span class="dv">15</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 5.73 s, sys: 0 ns, total: 5.73 s
Wall time: 5.86 s</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>ic(_ndcg_at_k.shape, _ndcg_at_k.<span class="bu">min</span>(), _ndcg_at_k.mean(), _ndcg_at_k.<span class="bu">max</span>(), _ndcg_at_k.median(), _ndcg_at_k.std())<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>ic| _ndcg_at_k.shape: torch.Size([1, 8922])
    _ndcg_at_k.min(): tensor(4.0372e-19, device='cuda:0')
    _ndcg_at_k.mean(): tensor(0.3494, device='cuda:0')
    _ndcg_at_k.max(): tensor(0.9934, device='cuda:0')
    _ndcg_at_k.median(): tensor(0.3283, device='cuda:0')
    _ndcg_at_k.std(): tensor(0.2672, device='cuda:0')</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>qnts <span class="op">=</span> torch.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">100</span>)</span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a>plt.plot(qnts, _ndcg_at_k.cpu().quantile(qnts, dim<span class="op">=-</span><span class="dv">1</span>).view(<span class="op">-</span><span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'quantiles'</span>)</span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'ndcg@k'</span>)</span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Quantile Plot for ndcg@k of all the labels'</span>)</span>
<span id="cb174-6"><a href="#cb174-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="17_tutorial.train_l2r_files/figure-html/cell-123-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>acc <span class="op">=</span> accuracy(dataset, learner.model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 276 ms, sys: 0 ns, total: 276 ms
Wall time: 286 ms</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>ic(acc.shape, acc.<span class="bu">min</span>(), acc.mean(), acc.<span class="bu">max</span>(), acc.median(), acc.std())<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>ic| acc.shape: torch.Size([1, 104])
    acc.min(): tensor(0.6281, device='cuda:0')
    acc.mean(): tensor(0.7566, device='cuda:0')
    acc.max(): tensor(0.7964, device='cuda:0')
    acc.median(): tensor(0.7626, device='cuda:0')
    acc.std(): tensor(0.0296, device='cuda:0')</code></pre>
</div>
</div>
<p>Let’s pick some random labels and see the rankings produced by the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>df_res, df_ndcg<span class="op">=</span> learner.show_results(k<span class="op">=</span><span class="dv">15</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a>df_ndcg[df_ndcg.ndcg_at_k <span class="op">&gt;=</span> <span class="fl">0.5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">labels</th>
<th data-quarto-table-cell-role="th">ndcg_at_k</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>5644</td>
<td>0.505686</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6</td>
<td>5102</td>
<td>0.608648</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>1804</td>
<td>0.594066</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>2355</td>
<td>0.581916</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22</td>
<td>8161</td>
<td>0.500200</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">28</td>
<td>2877</td>
<td>0.557069</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">30</td>
<td>129</td>
<td>0.706364</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">33</td>
<td>1245</td>
<td>0.733052</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">35</td>
<td>16</td>
<td>0.618285</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">38</td>
<td>1208</td>
<td>0.518697</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">53</td>
<td>6305</td>
<td>0.767246</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">58</td>
<td>1068</td>
<td>0.748479</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">89</td>
<td>1104</td>
<td>0.534632</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">91</td>
<td>5173</td>
<td>0.572957</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">92</td>
<td>934</td>
<td>0.650478</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a>df_ndcg.head(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">labels</th>
<th data-quarto-table-cell-role="th">ndcg_at_k</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>8526</td>
<td>4.967139e-16</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>7962</td>
<td>4.525589e-15</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3987</td>
<td>5.901048e-01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>6165</td>
<td>2.050589e-13</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>6168</td>
<td>3.538292e-10</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>2640</td>
<td>3.429065e-13</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>862</td>
<td>1.326269e-14</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>2750</td>
<td>2.974324e-14</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>7083</td>
<td>1.927360e-12</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>7382</td>
<td>3.322057e-13</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>df_res</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">label</th>
<th colspan="6" data-quarto-table-cell-role="th" data-halign="left">4565</th>
<th colspan="4" data-quarto-table-cell-role="th" data-halign="left">6569</th>
<th data-quarto-table-cell-role="th">...</th>
<th colspan="4" data-quarto-table-cell-role="th" data-halign="left">1047</th>
<th colspan="6" data-quarto-table-cell-role="th" data-halign="left">1349</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">key2</th>
<th data-quarto-table-cell-role="th">tok</th>
<th data-quarto-table-cell-role="th">lbl</th>
<th data-quarto-table-cell-role="th">rank</th>
<th data-quarto-table-cell-role="th">score</th>
<th data-quarto-table-cell-role="th">preds</th>
<th data-quarto-table-cell-role="th">model_rank</th>
<th data-quarto-table-cell-role="th">tok</th>
<th data-quarto-table-cell-role="th">lbl</th>
<th data-quarto-table-cell-role="th">rank</th>
<th data-quarto-table-cell-role="th">score</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">rank</th>
<th data-quarto-table-cell-role="th">score</th>
<th data-quarto-table-cell-role="th">preds</th>
<th data-quarto-table-cell-role="th">model_rank</th>
<th data-quarto-table-cell-role="th">tok</th>
<th data-quarto-table-cell-role="th">lbl</th>
<th data-quarto-table-cell-role="th">rank</th>
<th data-quarto-table-cell-role="th">score</th>
<th data-quarto-table-cell-role="th">preds</th>
<th data-quarto-table-cell-role="th">model_rank</th>
</tr>
<tr class="header">
<th data-quarto-table-cell-role="th">toks</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>51577.0</td>
<td>4565.0</td>
<td>53188.0</td>
<td>1.0</td>
<td>-41.782745</td>
<td>54696.0</td>
<td>51577.0</td>
<td>6569.0</td>
<td>51079.0</td>
<td>2.0</td>
<td>...</td>
<td>50834.0</td>
<td>2.0</td>
<td>-45.150726</td>
<td>55395.0</td>
<td>51577.0</td>
<td>1349.0</td>
<td>53188.0</td>
<td>1.0</td>
<td>-32.015938</td>
<td>34146.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>52360.0</td>
<td>4565.0</td>
<td>36926.0</td>
<td>5.0</td>
<td>-36.372681</td>
<td>46839.0</td>
<td>52360.0</td>
<td>6569.0</td>
<td>35079.0</td>
<td>6.0</td>
<td>...</td>
<td>21593.0</td>
<td>11.0</td>
<td>-37.832306</td>
<td>46060.0</td>
<td>52360.0</td>
<td>1349.0</td>
<td>36928.0</td>
<td>5.0</td>
<td>-38.207287</td>
<td>48127.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>37101.0</td>
<td>4565.0</td>
<td>23703.0</td>
<td>10.0</td>
<td>-42.323380</td>
<td>55161.0</td>
<td>37101.0</td>
<td>6569.0</td>
<td>40328.0</td>
<td>4.0</td>
<td>...</td>
<td>32080.0</td>
<td>7.0</td>
<td>-31.006001</td>
<td>31124.0</td>
<td>37101.0</td>
<td>1349.0</td>
<td>23697.0</td>
<td>10.0</td>
<td>-38.562450</td>
<td>48761.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>37705.0</td>
<td>4565.0</td>
<td>24090.0</td>
<td>10.0</td>
<td>-24.040859</td>
<td>17313.0</td>
<td>37705.0</td>
<td>6569.0</td>
<td>40714.0</td>
<td>4.0</td>
<td>...</td>
<td>32466.0</td>
<td>7.0</td>
<td>-29.984770</td>
<td>28882.0</td>
<td>37705.0</td>
<td>1349.0</td>
<td>24084.0</td>
<td>10.0</td>
<td>-35.929695</td>
<td>43524.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>14257.0</td>
<td>4565.0</td>
<td>4641.0</td>
<td>28.0</td>
<td>-27.471664</td>
<td>24536.0</td>
<td>14257.0</td>
<td>6569.0</td>
<td>13676.0</td>
<td>16.0</td>
<td>...</td>
<td>12842.0</td>
<td>17.0</td>
<td>-24.753557</td>
<td>18343.0</td>
<td>14257.0</td>
<td>1349.0</td>
<td>4612.0</td>
<td>28.0</td>
<td>-25.678783</td>
<td>19302.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">57347</td>
<td>4537.0</td>
<td>4565.0</td>
<td>16797.0</td>
<td>14.0</td>
<td>-17.453377</td>
<td>7259.0</td>
<td>4537.0</td>
<td>6569.0</td>
<td>3001.0</td>
<td>32.0</td>
<td>...</td>
<td>3601.0</td>
<td>30.0</td>
<td>-15.355591</td>
<td>2176.0</td>
<td>4537.0</td>
<td>1349.0</td>
<td>16785.0</td>
<td>14.0</td>
<td>-18.952923</td>
<td>8060.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">57348</td>
<td>1622.0</td>
<td>4565.0</td>
<td>1927.0</td>
<td>37.0</td>
<td>-14.181708</td>
<td>4227.0</td>
<td>1622.0</td>
<td>6569.0</td>
<td>33860.0</td>
<td>6.0</td>
<td>...</td>
<td>950.0</td>
<td>45.0</td>
<td>-9.783297</td>
<td>112.0</td>
<td>1622.0</td>
<td>1349.0</td>
<td>1878.0</td>
<td>37.0</td>
<td>-18.222450</td>
<td>7188.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">57349</td>
<td>16373.0</td>
<td>4565.0</td>
<td>5797.0</td>
<td>25.0</td>
<td>-19.083836</td>
<td>9199.0</td>
<td>16373.0</td>
<td>6569.0</td>
<td>15122.0</td>
<td>15.0</td>
<td>...</td>
<td>16773.0</td>
<td>14.0</td>
<td>-17.529833</td>
<td>5061.0</td>
<td>16373.0</td>
<td>1349.0</td>
<td>5781.0</td>
<td>25.0</td>
<td>-29.995731</td>
<td>29059.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">57350</td>
<td>43863.0</td>
<td>4565.0</td>
<td>31410.0</td>
<td>7.0</td>
<td>-39.971527</td>
<td>52866.0</td>
<td>43863.0</td>
<td>6569.0</td>
<td>25107.0</td>
<td>9.0</td>
<td>...</td>
<td>40880.0</td>
<td>4.0</td>
<td>-26.384148</td>
<td>21487.0</td>
<td>43863.0</td>
<td>1349.0</td>
<td>31405.0</td>
<td>7.0</td>
<td>-34.167110</td>
<td>39351.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">57351</td>
<td>11619.0</td>
<td>4565.0</td>
<td>5573.0</td>
<td>26.0</td>
<td>-26.214912</td>
<td>21706.0</td>
<td>11619.0</td>
<td>6569.0</td>
<td>14697.0</td>
<td>15.0</td>
<td>...</td>
<td>16236.0</td>
<td>14.0</td>
<td>-22.856853</td>
<td>14855.0</td>
<td>11619.0</td>
<td>1349.0</td>
<td>5553.0</td>
<td>26.0</td>
<td>-25.605606</td>
<td>19152.0</td>
</tr>
</tbody>
</table>

<p>57352 rows × 600 columns</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a>df_lbl <span class="op">=</span> df_res.loc[:, <span class="dv">934</span>]</span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a>df_lbl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">key2</th>
<th data-quarto-table-cell-role="th">tok</th>
<th data-quarto-table-cell-role="th">lbl</th>
<th data-quarto-table-cell-role="th">rank</th>
<th data-quarto-table-cell-role="th">score</th>
<th data-quarto-table-cell-role="th">preds</th>
<th data-quarto-table-cell-role="th">model_rank</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">toks</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>51577.0</td>
<td>934.0</td>
<td>53188.0</td>
<td>1.0</td>
<td>-19.667917</td>
<td>5888.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>52360.0</td>
<td>934.0</td>
<td>34324.0</td>
<td>6.0</td>
<td>-31.594564</td>
<td>32015.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>37101.0</td>
<td>934.0</td>
<td>31239.0</td>
<td>7.0</td>
<td>-39.322235</td>
<td>50443.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>37705.0</td>
<td>934.0</td>
<td>31626.0</td>
<td>7.0</td>
<td>-41.059654</td>
<td>52976.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>14257.0</td>
<td>934.0</td>
<td>12569.0</td>
<td>17.0</td>
<td>-24.408052</td>
<td>15270.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">57347</td>
<td>4537.0</td>
<td>934.0</td>
<td>3247.0</td>
<td>31.0</td>
<td>-17.787853</td>
<td>3021.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">57348</td>
<td>1622.0</td>
<td>934.0</td>
<td>9534.0</td>
<td>20.0</td>
<td>-17.016525</td>
<td>2166.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">57349</td>
<td>16373.0</td>
<td>934.0</td>
<td>14253.0</td>
<td>15.0</td>
<td>-25.219761</td>
<td>16950.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">57350</td>
<td>43863.0</td>
<td>934.0</td>
<td>43040.0</td>
<td>4.0</td>
<td>-41.898140</td>
<td>53898.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">57351</td>
<td>11619.0</td>
<td>934.0</td>
<td>13718.0</td>
<td>16.0</td>
<td>-31.796059</td>
<td>32533.0</td>
</tr>
</tbody>
</table>

<p>57352 rows × 6 columns</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>df2 <span class="op">=</span> df_lbl.sort_values(by<span class="op">=</span><span class="st">'rank'</span>).head(<span class="dv">15</span>)</span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>df2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">key2</th>
<th data-quarto-table-cell-role="th">tok</th>
<th data-quarto-table-cell-role="th">lbl</th>
<th data-quarto-table-cell-role="th">rank</th>
<th data-quarto-table-cell-role="th">score</th>
<th data-quarto-table-cell-role="th">preds</th>
<th data-quarto-table-cell-role="th">model_rank</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">toks</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">38712</td>
<td>9429.0</td>
<td>934.0</td>
<td>0.0</td>
<td>101.0</td>
<td>2.399450</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">30106</td>
<td>31007.0</td>
<td>934.0</td>
<td>1.0</td>
<td>100.0</td>
<td>-5.644907</td>
<td>17.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">50302</td>
<td>5150.0</td>
<td>934.0</td>
<td>2.0</td>
<td>100.0</td>
<td>-0.324139</td>
<td>3.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">20514</td>
<td>42988.0</td>
<td>934.0</td>
<td>3.0</td>
<td>100.0</td>
<td>-5.003191</td>
<td>13.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16688</td>
<td>48423.0</td>
<td>934.0</td>
<td>4.0</td>
<td>100.0</td>
<td>5.765238</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">39796</td>
<td>21173.0</td>
<td>934.0</td>
<td>5.0</td>
<td>100.0</td>
<td>-10.666720</td>
<td>136.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">26300</td>
<td>24115.0</td>
<td>934.0</td>
<td>6.0</td>
<td>99.0</td>
<td>-7.009228</td>
<td>26.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">29622</td>
<td>24101.0</td>
<td>934.0</td>
<td>7.0</td>
<td>97.0</td>
<td>-11.829512</td>
<td>220.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">29563</td>
<td>52417.0</td>
<td>934.0</td>
<td>8.0</td>
<td>96.0</td>
<td>-6.944853</td>
<td>25.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">20455</td>
<td>52706.0</td>
<td>934.0</td>
<td>9.0</td>
<td>95.0</td>
<td>-4.231724</td>
<td>11.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">40045</td>
<td>56483.0</td>
<td>934.0</td>
<td>10.0</td>
<td>94.0</td>
<td>-8.524904</td>
<td>49.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">39812</td>
<td>12054.0</td>
<td>934.0</td>
<td>11.0</td>
<td>92.0</td>
<td>-8.043360</td>
<td>38.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1172</td>
<td>40229.0</td>
<td>934.0</td>
<td>12.0</td>
<td>92.0</td>
<td>-13.823061</td>
<td>541.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13627</td>
<td>41785.0</td>
<td>934.0</td>
<td>13.0</td>
<td>91.0</td>
<td>-14.363610</td>
<td>696.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">56275</td>
<td>47498.0</td>
<td>934.0</td>
<td>14.0</td>
<td>90.0</td>
<td>-10.826721</td>
<td>151.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="co"># idcg_at_k = pow(2, df2['score']) * (1 / np.log2(df2['rank']+2)  )</span></span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a><span class="co"># idcg_at_k</span></span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a><span class="co"># df3 = df_lbl.sort_values(by='model_rank').head(10)</span></span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a><span class="co"># df3</span></span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-7"><a href="#cb185-7" aria-hidden="true" tabindex="-1"></a><span class="co"># dcg_at_k = pow(2, df3['score'])  *(1/np.log2(df3['model_rank']+2))</span></span>
<span id="cb185-8"><a href="#cb185-8" aria-hidden="true" tabindex="-1"></a><span class="co"># dcg_at_k</span></span>
<span id="cb185-9"><a href="#cb185-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-10"><a href="#cb185-10" aria-hidden="true" tabindex="-1"></a><span class="co"># dcg_at_k.sum()/idcg_at_k.sum()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>