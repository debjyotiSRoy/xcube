<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>xcube - Training an XML Text Classifier</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="xcube - Training an XML Text Classifier">
<meta property="og:description" content="">
<meta property="og:image" content="https://debjyotiSRoy.github.io/xcube/18_tutorial.train_mimic3_files/figure-html/cell-51-output-2.png">
<meta property="og:site-name" content="xcube">
<meta property="og:image:height" content="268">
<meta property="og:image:width" content="392">
<meta name="twitter:title" content="xcube - Training an XML Text Classifier">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://debjyotiSRoy.github.io/xcube/18_tutorial.train_mimic3_files/figure-html/cell-51-output-2.png">
<meta name="twitter:image-height" content="268">
<meta name="twitter:image-width" content="392">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">xcube</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./tutorial.train_mimic3.html">Training an XML Text Classifier</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">xcube</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">utils</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./layers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Layers</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./text.models.core.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Core XML Text Modules</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./text.learner.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Learner for the XML Text application:</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./metrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Metrics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./collab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Collaborative filtering</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data.transforms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Transformation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l2r.models.core.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L2R Models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l2r.gradients.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L2R Gradients</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l2r.learner.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L2R Learner</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l2r.data.load.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L2R DataLoader</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l2r.callbacks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L2R Callbacks</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data.external.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Downloading…</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l2r.data.info_gain.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Information Gain</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tutorial.boot_l2r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Boot L2R</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l2r.data.stat.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Stat</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tutorial.train_l2r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L2R Training</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tutorial.train_mimic3.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Training an XML Text Classifier</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./text.callbacks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">XML Callbacks</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tutorial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tutorials</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#dataloaders-for-the-language-model" id="toc-dataloaders-for-the-language-model" class="nav-link active" data-scroll-target="#dataloaders-for-the-language-model"><code>DataLoaders</code> for the Language Model</a></li>
  <li><a href="#learner-for-the-language-model-fine-tuning" id="toc-learner-for-the-language-model-fine-tuning" class="nav-link" data-scroll-target="#learner-for-the-language-model-fine-tuning"><code>Learner</code> for the Language Model Fine-Tuning:</a>
  <ul class="collapse">
  <li><a href="#saving-the-encoder-of-the-language-model" id="toc-saving-the-encoder-of-the-language-model" class="nav-link" data-scroll-target="#saving-the-encoder-of-the-language-model">Saving the encoder of the Language Model</a></li>
  <li><a href="#saving-the-decoder-of-the-language-model" id="toc-saving-the-decoder-of-the-language-model" class="nav-link" data-scroll-target="#saving-the-decoder-of-the-language-model">Saving the decoder of the Language Model</a></li>
  </ul></li>
  <li><a href="#dataloaders-for-the-multi-label-classifier-using-fastais-mid-level-data-api" id="toc-dataloaders-for-the-multi-label-classifier-using-fastais-mid-level-data-api" class="nav-link" data-scroll-target="#dataloaders-for-the-multi-label-classifier-using-fastais-mid-level-data-api"><code>DataLoaders</code> for the Multi-Label Classifier (using fastai’s Mid-Level Data API)</a>
  <ul class="collapse">
  <li><a href="#loading-raw-data" id="toc-loading-raw-data" class="nav-link" data-scroll-target="#loading-raw-data">Loading Raw Data</a></li>
  <li><a href="#dataset-statistics-optional" id="toc-dataset-statistics-optional" class="nav-link" data-scroll-target="#dataset-statistics-optional">Dataset Statistics (Optional)</a></li>
  <li><a href="#steps-for-creating-the-classifier-dataloaders-using-fastais-transforms" id="toc-steps-for-creating-the-classifier-dataloaders-using-fastais-transforms" class="nav-link" data-scroll-target="#steps-for-creating-the-classifier-dataloaders-using-fastais-transforms">Steps for creating the classifier <code>DataLoaders</code> using fastai’s <code>Transforms</code>:</a></li>
  </ul></li>
  <li><a href="#learner-for-multi-label-classifier-fine-tuning" id="toc-learner-for-multi-label-classifier-fine-tuning" class="nav-link" data-scroll-target="#learner-for-multi-label-classifier-fine-tuning"><code>Learner</code> for Multi-Label Classifier Fine-Tuning</a></li>
  <li><a href="#dev-ignore" id="toc-dev-ignore" class="nav-link" data-scroll-target="#dev-ignore">Dev (Ignore)</a></li>
  <li><a href="#fine-tuning-the-classifier" id="toc-fine-tuning-the-classifier" class="nav-link" data-scroll-target="#fine-tuning-the-classifier">Fine-Tuning the Classifier</a></li>
  <li><a href="#fine-tune-the-fwd-dev" id="toc-fine-tune-the-fwd-dev" class="nav-link" data-scroll-target="#fine-tune-the-fwd-dev">Fine-Tune the Fwd (Dev)</a></li>
  <li><a href="#checking-how-to-avoid-overfitting" id="toc-checking-how-to-avoid-overfitting" class="nav-link" data-scroll-target="#checking-how-to-avoid-overfitting">Checking how to avoid overfitting:</a></li>
  <li><a href="#fine-tuning-the-bwd-classifier" id="toc-fine-tuning-the-bwd-classifier" class="nav-link" data-scroll-target="#fine-tuning-the-bwd-classifier">Fine-Tuning the Bwd Classifier</a></li>
  <li><a href="#tta" id="toc-tta" class="nav-link" data-scroll-target="#tta">TTA</a></li>
  <li><a href="#plotting-the-label-embeddings" id="toc-plotting-the-label-embeddings" class="nav-link" data-scroll-target="#plotting-the-label-embeddings">Plotting the Label Embeddings</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/debjyotiSRoy/xcube/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Training an XML Text Classifier</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> [ <span class="op">-</span>e <span class="op">/</span>content ] <span class="op">&amp;&amp;</span> pip install <span class="op">-</span>Uqq xcube <span class="co"># upgrade xcube on colab</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.text.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xcube.text.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.metrics <span class="im">import</span> accuracy <span class="co"># there's an 'accuracy' metric in xcube as well (Deb fix name conflict later)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Make sure we have that “beast”:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>ic(torch.cuda.get_device_name(default_device()))<span class="op">;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>test_eq(torch.cuda.get_device_name(<span class="dv">0</span>), torch.cuda.get_device_name(default_device()))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>test_eq(default_device(), torch.device(<span class="dv">0</span>))</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"GPU memory = </span><span class="sc">{</span>torch<span class="sc">.</span>cuda<span class="sc">.</span>get_device_properties(default_device())<span class="sc">.</span>total_memory<span class="op">/</span><span class="dv">1024</span><span class="op">**</span><span class="dv">3</span><span class="sc">}</span><span class="ss">GB"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>ic| torch.cuda.get_device_name(default_device()): 'Quadro RTX 8000'</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>GPU memory = 44.99969482421875GB</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>source <span class="op">=</span> untar_xxx(XURLs.MIMIC3)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>source_l2r <span class="op">=</span> untar_xxx(XURLs.MIMIC3_L2R)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Setting some environment variables:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">'CUDA_LAUNCH_BLOCKING'</span>] <span class="op">=</span> <span class="st">"1"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Setting defaults for pandas and matplotlib:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the default figure size</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"figure.figsize"</span>] <span class="op">=</span> (<span class="dv">8</span>, <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Altering some default jupyter settings:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.core.interactiveshell <span class="im">import</span> InteractiveShell</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># InteractiveShell.ast_node_interactivity = "last" # "all"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="dataloaders-for-the-language-model" class="level2">
<h2 class="anchored" data-anchor-id="dataloaders-for-the-language-model"><code>DataLoaders</code> for the Language Model</h2>
<p>To be able to use Transfer Learning, first we need to fine-tune our Language Model (which we pretrained on Wikipedia) on the corpus of Wiki-500k (the one we downloaded). Here we will build the <code>DataLoaders</code> object using fastai’s <code>DataBlock</code> API:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> source<span class="op">/</span><span class="st">'mimic3-9k.csv'</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>head <span class="op">-</span>n <span class="dv">1</span> {data}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>subject_id,hadm_id,text,labels,length,is_valid</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(data,</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>                 header<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>                 names<span class="op">=</span>[<span class="st">'subject_id'</span>, <span class="st">'hadm_id'</span>, <span class="st">'text'</span>, <span class="st">'labels'</span>, <span class="st">'length'</span>, <span class="st">'is_valid'</span>],</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>                 dtype<span class="op">=</span>{<span class="st">'subject_id'</span>: <span class="bu">str</span>, <span class="st">'hadm_id'</span>: <span class="bu">str</span>, <span class="st">'text'</span>: <span class="bu">str</span>, <span class="st">'labels'</span>: <span class="bu">str</span>, <span class="st">'length'</span>: np.int64, <span class="st">'is_valid'</span>: <span class="bu">bool</span>})</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>52726</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>df[[<span class="st">'text'</span>, <span class="st">'labels'</span>]] <span class="op">=</span> df[[<span class="st">'text'</span>, <span class="st">'labels'</span>]].astype(<span class="bu">str</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s take a look at the data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>df.head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">subject_id</th>
<th data-quarto-table-cell-role="th">hadm_id</th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">labels</th>
<th data-quarto-table-cell-role="th">length</th>
<th data-quarto-table-cell-role="th">is_valid</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>86006</td>
<td>111912</td>
<td>admission date discharge date date of birth sex f service surgery allergies patient recorded as having no known allergies to drugs attending first name3 lf chief complaint 60f on coumadin was found slightly drowsy tonight then fell down stairs paramedic found her unconscious and she was intubated w o any medication head ct shows multiple iph transferred to hospital1 for further eval major surgical or invasive procedure none past medical history her medical history is significant for hypertension osteoarthritis involving bilateral knee joints with a dependence on cane for ambulation chronic...</td>
<td>801.35;348.4;805.06;807.01;998.30;707.24;E880.9;427.31;414.01;401.9;V58.61;V43.64;707.00;E878.1;96.71</td>
<td>230</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>85950</td>
<td>189769</td>
<td>admission date discharge date service neurosurgery allergies sulfa sulfonamides attending first name3 lf chief complaint cc cc contact info major surgical or invasive procedure none history of present illness hpi 88m who lives with family had fall yesterday today had decline in mental status ems called pt was unresponsive on arrival went to osh head ct showed large r sdh pt was intubated at osh and transferred to hospital1 for further care past medical history cad s p mi in s p cabg in ventricular aneurysm at that time cath in with occluded rca unable to intervene chf reported ef 1st degre...</td>
<td>852.25;E888.9;403.90;585.9;250.00;414.00;V45.81;96.71</td>
<td>304</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>88025</td>
<td>180431</td>
<td>admission date discharge date date of birth sex f service surgery allergies no known allergies adverse drug reactions attending first name3 lf chief complaint s p fall major surgical or invasive procedure none history of present illness 45f etoh s p fall from window at feet found ambulating and slurring speech on scene intubated en route for declining mental status in the er the patient was found to be bradycardic to the s with bp of systolic she was given atropine dilantin and was started on saline past medical history unknown social history unknown family history unknown physical exam ex...</td>
<td>518.81;348.4;348.82;801.25;427.89;E882;V49.86;305.00;96.71;38.93</td>
<td>359</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We will now create the <code>DataLoaders</code> using <code>DataBlock</code> API:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>dls_lm <span class="op">=</span> DataBlock(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    blocks   <span class="op">=</span> TextBlock.from_df(<span class="st">'text'</span>, is_lm<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    get_x    <span class="op">=</span> ColReader(<span class="st">'text'</span>),</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    splitter <span class="op">=</span> RandomSplitter(<span class="fl">0.1</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>).dataloaders(df, bs<span class="op">=</span><span class="dv">384</span>, seq_len<span class="op">=</span><span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<p>For the backward LM:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>dls_lm_r <span class="op">=</span> DataBlock(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    blocks   <span class="op">=</span> TextBlock.from_df(<span class="st">'text'</span>, is_lm<span class="op">=</span><span class="va">True</span>, backwards<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    get_x    <span class="op">=</span> ColReader(<span class="st">'text'</span>),</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    splitter <span class="op">=</span> RandomSplitter(<span class="fl">0.1</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>).dataloaders(df, bs<span class="op">=</span><span class="dv">384</span>, seq_len<span class="op">=</span><span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<p>Let’s take a look at the batches:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>dls_lm.show_batch(max_n<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">text_</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>xxbos admission date discharge date date of birth sex m history of present illness first name8 namepattern2 known lastname is the firstborn of triplets at week gestation born to a year old gravida para woman immune rpr non reactive hepatitis b surface antigen negative group beta strep status unknown this was an intrauterine insemination achieved pregnancy the pregnancy was uncomplicated until when mother was admitted for evaluation of pregnancy induced hypertension she was treated with betamethasone and discharged home she</td>
<td>admission date discharge date date of birth sex m history of present illness first name8 namepattern2 known lastname is the firstborn of triplets at week gestation born to a year old gravida para woman immune rpr non reactive hepatitis b surface antigen negative group beta strep status unknown this was an intrauterine insemination achieved pregnancy the pregnancy was uncomplicated until when mother was admitted for evaluation of pregnancy induced hypertension she was treated with betamethasone and discharged home she was</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>occluded rca with l to r collaterals the femoral sheath was sewn in started on heparin and transferred to hospital1 for surgical revascularization past medical history coronary artery diease s p myocardial infarction s p pci to rca subarachnoid hemorrhage secondary to streptokinase hypertension hyperlipidemia hiatal hernia gastritis depression reactive airway disease s p ppm placement for 2nd degree av block social history history of smoking having quit in with a pack year history family history strong family history of</td>
<td>rca with l to r collaterals the femoral sheath was sewn in started on heparin and transferred to hospital1 for surgical revascularization past medical history coronary artery diease s p myocardial infarction s p pci to rca subarachnoid hemorrhage secondary to streptokinase hypertension hyperlipidemia hiatal hernia gastritis depression reactive airway disease s p ppm placement for 2nd degree av block social history history of smoking having quit in with a pack year history family history strong family history of premature</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>dls_lm_r.show_batch(max_n<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">text_</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>sb west d i basement name first doctor bldg name ward hospital lm lf name3 first lf name last name last doctor d i 30a visit fellow sb west d i name first doctor name last doctor d i 30p visit attending opat appointments up follow disease infectious garage name ward hospital parking best east campus un location ctr clinical name ward hospital sc building fax telephone md namepattern4 name last pattern1 name name11 first with am at wednesday when</td>
<td>west d i basement name first doctor bldg name ward hospital lm lf name3 first lf name last name last doctor d i 30a visit fellow sb west d i name first doctor name last doctor d i 30p visit attending opat appointments up follow disease infectious garage name ward hospital parking best east campus un location ctr clinical name ward hospital sc building fax telephone md namepattern4 name last pattern1 name name11 first with am at wednesday when services</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>bare and catheterization cardiac a for hospital1 to flown were you infarction myocardial or attack heart a and pain chest had you instructions discharge independent ambulatory status activity interactive and alert consciousness of level coherent and clear status mental condition discharge hyperglycemia hyperlipidemia hypertension infarction myocardial inferior acute diagnosis discharge home disposition discharge refills tablets disp pain chest for needed as year month of total a for minutes every sublingual tablet one sig sublingual tablet mg nitroglycerin day a once</td>
<td>and catheterization cardiac a for hospital1 to flown were you infarction myocardial or attack heart a and pain chest had you instructions discharge independent ambulatory status activity interactive and alert consciousness of level coherent and clear status mental condition discharge hyperglycemia hyperlipidemia hypertension infarction myocardial inferior acute diagnosis discharge home disposition discharge refills tablets disp pain chest for needed as year month of total a for minutes every sublingual tablet one sig sublingual tablet mg nitroglycerin day a once po</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The length of our vocabulary is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(dls_lm.vocab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>57376</code></pre>
</div>
</div>
<p>Let’s take a look at some words of the vocab:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(coll_repr(L(dls_lm.vocab), <span class="dv">30</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(#57376) ['xxunk','xxpad','xxbos','xxeos','xxfld','xxrep','xxwrep','xxup','xxmaj','the','and','to','of','was','with','a','on','in','for','mg','no','tablet','patient','is','he','at','blood','name','po','she'...]</code></pre>
</div>
</div>
<p>Creating the <code>DataLaoders</code> takes some time, so smash that <em>save</em> button (also a good idea to save the <code>dls_lm.vocab</code> for later use) if you are working on your own dataset. In this case though <a href="https://debjyotiSRoy.github.io/xcube/data.external.html#untar_xxx"><code>untar_xxx</code></a> has got it for you:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(L(source.glob(<span class="st">"**/*dls*lm*.pkl"</span>)).<span class="bu">map</span>(<span class="bu">str</span>))) <span class="co"># the ones with _r are for the reverse language model</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>/home/deb/.xcube/data/mimic3/mimic3-9k_dls_lm.pkl
/home/deb/.xcube/data/mimic3/mimic3-9k_dls_lm_vocab_r.pkl
/home/deb/.xcube/data/mimic3/mimic3-9k_dls_lm_vocab.pkl
/home/deb/.xcube/data/mimic3/mimic3-9k_dls_lm_r.pkl
/home/deb/.xcube/data/mimic3/mimic3-9k_dls_lm_old.pkl</code></pre>
</div>
</div>
<p>To load back the <code>dls_lm</code> later on:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>dls_lm <span class="op">=</span> torch.load(source<span class="op">/</span><span class="st">'mimic3-9k_dls_lm.pkl'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>dls_lm_r <span class="op">=</span> torch.load(source<span class="op">/</span><span class="st">'mimic3-9k_dls_lm_r.pkl'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="learner-for-the-language-model-fine-tuning" class="level2">
<h2 class="anchored" data-anchor-id="learner-for-the-language-model-fine-tuning"><code>Learner</code> for the Language Model Fine-Tuning:</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> language_model_learner(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    dls_lm, AWD_LSTM, drop_mult<span class="op">=</span><span class="fl">0.3</span>,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    metrics<span class="op">=</span>[accuracy, Perplexity()]).to_fp16()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And, one more for the reverse:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>learn_r <span class="op">=</span> language_model_learner(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    dls_lm_r, AWD_LSTM, drop_mult<span class="op">=</span><span class="fl">0.3</span>, backwards<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    metrics<span class="op">=</span>[accuracy, Perplexity()]).to_fp16()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Training a language model on the full datset takes a lot of time. So you can train one on a tiny dataset for illustration. Or you can skip the training and just load up the one that’s pretrained and downloaded by <a href="https://debjyotiSRoy.github.io/xcube/data.external.html#untar_xxx"><code>untar_xxx</code></a> and just do the validation.</p>
<p>Let’s compute the learning rate using the <code>lr_find</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>lr_min, lr_steep, lr_valley, lr_slide <span class="op">=</span> learn.lr_find(suggest_funcs<span class="op">=</span>(minimum, steep, valley, slide))</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>lr_min, lr_steep, lr_valley, lr_slide</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">1</span>, lr_min)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">perplexity</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>3.646323</td>
<td>3.512013</td>
<td>0.382642</td>
<td>33.515659</td>
<td>2:27:57</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>It takes quite a while to train each epoch, so we’ll be saving the intermediate model results during the training process:</p>
<p>Since we have completed the initial training, we will now continue fine-tuning the model after unfreezing:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>learn.unfreeze()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and run <code>lr_find</code> again, because we now have more layers to train, and the last layers weight have already been trained for one epoch:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>lr_min, lr_steep, lr_valley, lr_slide <span class="op">=</span> learn.lr_find(suggest_funcs<span class="op">=</span>(minimum, steep, valley, slide))</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>lr_min, lr_steep, lr_valley, lr_slide</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now traing with a suitable learning rate:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">10</span>, lr_max<span class="op">=</span><span class="fl">2e-3</span>, cbs<span class="op">=</span>SaveModelCallback(fname<span class="op">=</span><span class="st">'lm'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note: Make sure if you have trained the most recent language model <code>Learner</code> for more epochs (then you need to save that version)</p>
<p>Here you can load the pretrained language model which <a href="https://debjyotiSRoy.github.io/xcube/data.external.html#untar_xxx"><code>untar_xxx</code></a> downloaded:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> learn.load(source<span class="op">/</span><span class="st">'mimic3-9k_lm'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>learn_r <span class="op">=</span> learn_r.load(source<span class="op">/</span><span class="st">'mimic3-9k_lm_r'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s validate the <code>Learner</code> to make sure we loaded the correct version:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>learn.validate()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<pre><code>(#3) [2.060459852218628,0.5676611661911011,7.849578857421875]</code></pre>
</div>
</div>
<p>and the reverse…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>learn_r.validate()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<pre><code>(#3) [2.101907968521118,0.5691556334495544,8.18176555633545]</code></pre>
</div>
</div>
<section id="saving-the-encoder-of-the-language-model" class="level3">
<h3 class="anchored" data-anchor-id="saving-the-encoder-of-the-language-model">Saving the encoder of the Language Model</h3>
<p><strong>Crucial:</strong> Once we have trained our LM we will save all of our model except the final layer that converts activation to probabilities of picking each token in our vocabulary. The model not including the final layer has a sexy name - <em>encoder</em>. We will save it using <code>save_encoder</code> method of the <code>Learner</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.save_encoder('lm_finetuned')</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co"># learn_r.save_encoder('lm_finetuned_r')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="saving-the-decoder-of-the-language-model" class="level3">
<h3 class="anchored" data-anchor-id="saving-the-decoder-of-the-language-model">Saving the decoder of the Language Model</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>learn.save_decoder(<span class="st">'mimic3-9k_lm_decoder'</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>learn_r.save_decoder(<span class="st">'mimic3-9k_lm_decoder_r'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This completes the second stage of the text classification process - fine-tuning the Language Model pretrained on Wikipedia corpus. We will now use it to fine-tune a text multi-label text classifier.</p>
</section>
</section>
<section id="dataloaders-for-the-multi-label-classifier-using-fastais-mid-level-data-api" class="level2">
<h2 class="anchored" data-anchor-id="dataloaders-for-the-multi-label-classifier-using-fastais-mid-level-data-api"><code>DataLoaders</code> for the Multi-Label Classifier (using fastai’s Mid-Level Data API)</h2>
<p>Fastai’s midlevel data api is the swiss army knife of data preprocessing. Detailed tutorials can be found here <a href="https://docs.fast.ai/tutorial.pets.html">intermediate</a>, <a href="https://docs.fast.ai/tutorial.siamese.html">advanced</a>. We will use it here to create our dataloaders for the classifier.</p>
<section id="loading-raw-data" class="level3">
<h3 class="anchored" data-anchor-id="loading-raw-data">Loading Raw Data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> source<span class="op">/</span><span class="st">'mimic3-9k.csv'</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>head <span class="op">-</span>n <span class="dv">1</span> {data}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>subject_id,hadm_id,text,labels,length,is_valid</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># !shuf -n 200000 {data} &gt; {data_sample}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(data,</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>                 header<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>                 names<span class="op">=</span>[<span class="st">'subject_id'</span>, <span class="st">'hadm_id'</span>, <span class="st">'text'</span>, <span class="st">'labels'</span>, <span class="st">'length'</span>, <span class="st">'is_valid'</span>],</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>                 dtype<span class="op">=</span>{<span class="st">'subject_id'</span>: <span class="bu">str</span>, <span class="st">'hadm_id'</span>: <span class="bu">str</span>, <span class="st">'text'</span>: <span class="bu">str</span>, <span class="st">'labels'</span>: <span class="bu">str</span>, <span class="st">'length'</span>: np.int64, <span class="st">'is_valid'</span>: <span class="bu">bool</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>df[[<span class="st">'text'</span>, <span class="st">'labels'</span>]] <span class="op">=</span> df[[<span class="st">'text'</span>, <span class="st">'labels'</span>]].astype(<span class="bu">str</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>df.head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">subject_id</th>
<th data-quarto-table-cell-role="th">hadm_id</th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">labels</th>
<th data-quarto-table-cell-role="th">length</th>
<th data-quarto-table-cell-role="th">is_valid</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>86006</td>
<td>111912</td>
<td>admission date discharge date date of birth sex f service surgery allergies patient recorded as having no known allergies to drugs attending first name3 lf chief complaint 60f on coumadin was found slightly drowsy tonight then fell down stairs paramedic found her unconscious and she was intubated w o any medication head ct shows multiple iph transferred to hospital1 for further eval major surgical or invasive procedure none past medical history her medical history is significant for hypertension osteoarthritis involving bilateral knee joints with a dependence on cane for ambulation chronic...</td>
<td>801.35;348.4;805.06;807.01;998.30;707.24;E880.9;427.31;414.01;401.9;V58.61;V43.64;707.00;E878.1;96.71</td>
<td>230</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>85950</td>
<td>189769</td>
<td>admission date discharge date service neurosurgery allergies sulfa sulfonamides attending first name3 lf chief complaint cc cc contact info major surgical or invasive procedure none history of present illness hpi 88m who lives with family had fall yesterday today had decline in mental status ems called pt was unresponsive on arrival went to osh head ct showed large r sdh pt was intubated at osh and transferred to hospital1 for further care past medical history cad s p mi in s p cabg in ventricular aneurysm at that time cath in with occluded rca unable to intervene chf reported ef 1st degre...</td>
<td>852.25;E888.9;403.90;585.9;250.00;414.00;V45.81;96.71</td>
<td>304</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>88025</td>
<td>180431</td>
<td>admission date discharge date date of birth sex f service surgery allergies no known allergies adverse drug reactions attending first name3 lf chief complaint s p fall major surgical or invasive procedure none history of present illness 45f etoh s p fall from window at feet found ambulating and slurring speech on scene intubated en route for declining mental status in the er the patient was found to be bradycardic to the s with bp of systolic she was given atropine dilantin and was started on saline past medical history unknown social history unknown family history unknown physical exam ex...</td>
<td>518.81;348.4;348.82;801.25;427.89;E882;V49.86;305.00;96.71;38.93</td>
<td>359</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Sample a small fraction of the dataset to ensure quick iteration (Skip this if you want to do this on the full dataset)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># df = df.sample(frac=0.3, random_state=89, ignore_index=True)</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="co"># df = df.sample(frac=0.025, random_state=89, ignore_index=True)</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.sample(frac<span class="op">=</span><span class="fl">0.005</span>, random_state<span class="op">=</span><span class="dv">89</span>, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>264</code></pre>
</div>
</div>
<p>Let’s now gather the labels from the ‘labels’ columns of the df:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>lbl_freqs <span class="op">=</span> Counter()</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> labels <span class="kw">in</span> df.labels: lbl_freqs.update(labels.split(<span class="st">';'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The total number of labels are:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(lbl_freqs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>8922</code></pre>
</div>
</div>
<p>Let’s take a look at the most common labels:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(lbl_freqs.most_common(<span class="dv">20</span>), columns<span class="op">=</span>[<span class="st">'label'</span>, <span class="st">'frequency'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">frequency</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>401.9</td>
<td>20053</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>38.93</td>
<td>14444</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>428.0</td>
<td>12842</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>427.31</td>
<td>12594</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>414.01</td>
<td>12179</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>96.04</td>
<td>9932</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>96.6</td>
<td>9161</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>584.9</td>
<td>8907</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>250.00</td>
<td>8784</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>96.71</td>
<td>8619</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>272.4</td>
<td>8504</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>518.81</td>
<td>7249</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>99.04</td>
<td>7147</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>39.61</td>
<td>6809</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>599.0</td>
<td>6442</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>530.81</td>
<td>6156</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>96.72</td>
<td>5926</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>272.0</td>
<td>5766</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>285.9</td>
<td>5296</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>88.56</td>
<td>5240</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Let’s make a list of all labels (We will use it later while creating the <code>DataLoader</code>)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>lbls <span class="op">=</span> <span class="bu">list</span>(lbl_freqs.keys())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="dataset-statistics-optional" class="level3">
<h3 class="anchored" data-anchor-id="dataset-statistics-optional">Dataset Statistics (Optional)</h3>
<blockquote class="blockquote">
<p>Let’s try to understand what captures the hardness of an xml dataset</p>
</blockquote>
<section id="check-1-number-of-instances-trainvalid-split" class="level4">
<h4 class="anchored" data-anchor-id="check-1-number-of-instances-trainvalid-split">Check #1: Number of instances (train/valid split)</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>train, valid <span class="op">=</span> df.index[<span class="op">~</span>df[<span class="st">'is_valid'</span>]], df.index[df[<span class="st">'is_valid'</span>]]</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(train), <span class="bu">len</span>(valid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(244, 20)</code></pre>
</div>
</div>
</section>
<section id="check-2-avg-number-of-instances-per-label" class="level4">
<h4 class="anchored" data-anchor-id="check-2-avg-number-of-instances-per-label">Check #2: Avg number of instances per label</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>array(<span class="bu">list</span>(lbl_freqs.values())).mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>3.341463414634146</code></pre>
</div>
</div>
</section>
<section id="check-3-plotting-the-label-distribution" class="level4">
<h4 class="anchored" data-anchor-id="check-3-plotting-the-label-distribution">Check #3: Plotting the label distribution</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>lbl_count <span class="op">=</span> []</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> lbls <span class="kw">in</span> df.labels: lbl_count.append(<span class="bu">len</span>(lbls.split(<span class="st">','</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>df_copy <span class="op">=</span> df.copy()</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>df_copy[<span class="st">'label_count'</span>] <span class="op">=</span> lbl_count</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>df_copy.head(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">labels</th>
<th data-quarto-table-cell-role="th">is_valid</th>
<th data-quarto-table-cell-role="th">label_count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Methodical Bible study: A new approach to hermeneutics /SEP/ Methodical Bible study: A new approach to hermeneutics. Inductive study compares related Bible texts in order to let the Bible interpret itself, rather than approaching Scripture with predetermined notions of what it will say. Dr. Trainas Methodical Bible Study was not intended to be the last word in inductive Bible study; but since its first publication in 1952, it has become a foundational text in this field. Christian colleges and seminaries have made it required reading for beginning Bible students, while many churches have...</td>
<td>34141,119299,126600,128716,187372,218742</td>
<td>False</td>
<td>6</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Southeastern Mills Roast Beef Gravy Mix, 4.5-Ounce Packages (Pack of 24) /SEP/ Southeastern Mills Roast Beef Gravy Mix, 4.5-Ounce Packages (Pack of 24). Makes 3-1/2 cups. Down home taste. Makes hearty beef stew base.</td>
<td>465536,465553,615429</td>
<td>False</td>
<td>3</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The average number of labels per instance is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>df_copy.label_count.mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>5.385563363865518</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>sns.distplot(df_copy.label_count, bins<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'b'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/deb/miniconda3/lib/python3.9/site-packages/seaborn/distributions.py:2619: FutureWarning: `distplot` is a deprecated function and will be removed in a future version. Please adapt your code to use either `displot` (a figure-level function with similar flexibility) or `histplot` (an axes-level function for histograms).
  warnings.warn(msg, FutureWarning)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="18_tutorial.train_mimic3_files/figure-html/cell-51-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>lbls_sorted <span class="op">=</span> <span class="bu">sorted</span>(lbl_freqs.items(), key<span class="op">=</span><span class="kw">lambda</span> item: item[<span class="dv">1</span>], reverse<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>lbls_sorted[:<span class="dv">20</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[('455619', 2258),
 ('455662', 2176),
 ('547041', 2160),
 ('516790', 1214),
 ('455712', 1203),
 ('455620', 1133),
 ('632786', 1132),
 ('632789', 1132),
 ('632785', 1030),
 ('632788', 1030),
 ('492255', 938),
 ('455014', 872),
 ('670034', 850),
 ('427871', 815),
 ('599701', 803),
 ('308331', 801),
 ('581325', 801),
 ('649272', 799),
 ('455704', 762),
 ('666760', 733)]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>ranked_lbls <span class="op">=</span> L(lbls_sorted).itemgot(<span class="dv">0</span>)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>ranked_freqs <span class="op">=</span> L(lbls_sorted).itemgot(<span class="dv">1</span>)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>ranked_lbls, ranked_freqs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>((#670091) ['455619','455662','547041','516790','455712','455620','632786','632789','632785','632788'...],
 (#670091) [2258,2176,2160,1214,1203,1133,1132,1132,1030,1030...])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">5</span>))</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>ax.plot(ranked_freqs)</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Labels ranked by frequency'</span>)</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Text Count'</span>)</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>ax.set_yscale(<span class="st">'log'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="18_tutorial.train_mimic3_files/figure-html/cell-55-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="check-4-computing-the-min-label-freq-for-each-text" class="level4">
<h4 class="anchored" data-anchor-id="check-4-computing-the-min-label-freq-for-each-text">Check #4: Computing the min label freq for each text</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>df_copy.head(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">labels</th>
<th data-quarto-table-cell-role="th">is_valid</th>
<th data-quarto-table-cell-role="th">label_count</th>
<th data-quarto-table-cell-role="th">min_code_freq</th>
<th data-quarto-table-cell-role="th">max_code_freq</th>
<th data-quarto-table-cell-role="th">90pct_code_freq</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Methodical Bible study: A new approach to hermeneutics /SEP/ Methodical Bible study: A new approach to hermeneutics. Inductive study compares related Bible texts in order to let the Bible interpret itself, rather than approaching Scripture with predetermined notions of what it will say. Dr. Trainas Methodical Bible Study was not intended to be the last word in inductive Bible study; but since its first publication in 1952, it has become a foundational text in this field. Christian colleges and seminaries have made it required reading for beginning Bible students, while many churches have...</td>
<td>34141,119299,126600,128716,187372,218742</td>
<td>False</td>
<td>6</td>
<td>2</td>
<td>29</td>
<td>25.5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Southeastern Mills Roast Beef Gravy Mix, 4.5-Ounce Packages (Pack of 24) /SEP/ Southeastern Mills Roast Beef Gravy Mix, 4.5-Ounce Packages (Pack of 24). Makes 3-1/2 cups. Down home taste. Makes hearty beef stew base.</td>
<td>465536,465553,615429</td>
<td>False</td>
<td>3</td>
<td>2</td>
<td>3</td>
<td>3.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>MMF Industries 24-Key Portable Zippered Key Case (201502417) /SEP/ MMF Industries 24-Key Portable Zippered Key Case (201502417). The MMF Industries 201502417 24-Key Portable Zippered Key Case is an attractive burgundy-colored leather-like vinyl case with brass corners and looks like a portfolio. Its easy-slide zipper keeps keys enclosed, and a hook-and-loop fastener strips keep keys securely in place. Key tags are included.\tZippered key case offers a portable alternative to metal wall key cabinets. Included key tags are backed by hook-and-loop closures. Easy slide zipper keeps keys enclos...</td>
<td>393828</td>
<td>False</td>
<td>1</td>
<td>2</td>
<td>2</td>
<td>2.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Hoover the Fishing President /SEP/ Hoover the Fishing President. Hal Elliott Wert has spent years researching Herbert Hoover, Franklin Roosevelt, and Harry Truman. He holds a Ph.D. from the University of Kansas and currently teaches at the Kansas City Art Institute.</td>
<td>167614,223686</td>
<td>False</td>
<td>2</td>
<td>4</td>
<td>4</td>
<td>4.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>GeoPuzzle U.S.A. and Canada - Educational Geography Jigsaw Puzzle (69 pcs) /SEP/ GeoPuzzle U.S.A. and Canada - Educational Geography Jigsaw Puzzle (69 pcs). GeoPuzzles are jigsaw puzzles that make learning world geography fun. The pieces of a GeoPuzzle are shaped like individual countries, so children learn as they put the puzzle together. Award-winning Geopuzzles help to build fine motor, cognitive, language, and problem-solving skills, and are a great introduction to world geography for children 4 and up. Designed by an art professor, jumbo sized and brightly colored GeoPuzzles are avail...</td>
<td>480528,480530,480532,485144,485146,598793</td>
<td>False</td>
<td>6</td>
<td>5</td>
<td>10</td>
<td>8.5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Amazon.com: Paul Fredrick Men's Cotton Pinpoint Oxford Straight Collar Dress Shirt: Clothing /SEP/ Amazon.com: Paul Fredrick Men's Cotton Pinpoint Oxford Straight Collar Dress Shirt: Clothing. Pinpoint Oxford Cotton. Traditional Straight Collar, 1/4 Topstitched. Button Cuffs, 1/4 Topstitched. Embedded Collar Stay. Regular, Big and Tall. Top Center Placket. Split Yoke. Single Front Rounded Pocket. Machine Wash Or Dry Clean. Imported. * Big and Tall Sizes - addl $5.00</td>
<td>516790,567615,670034</td>
<td>False</td>
<td>3</td>
<td>256</td>
<td>1214</td>
<td>1141.2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Darkest Fear : A Myron Bolitar Novel /SEP/ Darkest Fear : A Myron Bolitar Novel. Myron Bolitar's father's recent heart attack brings Myron smack into a midlife encounter with issues of adulthood and mortality. And if that's not enough to turn his life upside down, the reappearance of his first serious girlfriend is. The basketball star turned sports agent, who does a little detecting when business is slow, is saddened by the news that Emily Downing's 13-year-old son is dying and desperately needs a bone marrow transplant; even if she did leave him for the man who destroyed his basketball c...</td>
<td>50442,50516,50647,50672,50680,662538</td>
<td>False</td>
<td>6</td>
<td>2</td>
<td>3</td>
<td>2.5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>In Debt We Trust (2007) /SEP/ In Debt We Trust (2007). Just a few decades ago, owing more money than you had in your bank account was the exception, not the rule. Yet, in the last 10 years, consumer debt has doubled and, for the first time, Americans are spending more than they're saving -- or making. This April, award-winning former ABC News and CNN producer Danny Schechter investigates America's mounting debt crisis in his latest hard-hitting expose, IN DEBT WE TRUST. While many Americans are "maxing out" on credit cards, there is a much deeper story: power is shifting into few...</td>
<td>493095,499382,560691,589867,591343,611615,619231</td>
<td>False</td>
<td>7</td>
<td>4</td>
<td>50</td>
<td>47.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Craftsman 9-34740 32 Piece 1/4-3/8 Drive Standard/Metric Socket Wrench Set /SEP/ Craftsman 9-34740 32 Piece 1/4-3/8 Drive Standard/Metric Socket Wrench Set. Craftsman 9-34740 32 Pc. 1/4-3/8 Drive Standard/Metric Socket Wrench Set. The Craftsman 9-34740 32 Pc. 1/4-3/8 Drive Standard/Metric Socket Wrench Set includes 1/4 Inch Drive Sockets; 8 Six-Point Standard Sockets:9-43492 7/32-Inch, 9-43496 11/32,9-43493 1/4-Inch, 9-43497 3/8-Inch, 9-43494 9/32-Inch, 9-43498 7/16-Inch,9-43495 5/16-Inch, 9-43499 1/2-Inch; 7 Six-Point Metric Sockets:9-43505 4mm, 9-43504 8mm, 9-43501 5mm, 9-43507 9mm,9-435...</td>
<td>590298,609038</td>
<td>False</td>
<td>2</td>
<td>2</td>
<td>2</td>
<td>2.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>2013 Hammer Nutrition Complex Carbohydrate Energy Gel - 12-Pack /SEP/ 2013 Hammer Nutrition Complex Carbohydrate Energy Gel - 12-Pack. Hammer Nutrition made the Complex Carbohydrate Energy Gel with natural ingredients and real fruit, so you won't have those unhealthy insulin-spike sugar highs. Instead, you get prolonged energy levels from the complex carbohydrates and amino acids in this Hammer Gel. The syrup-like consistency makes it easy to drink straight or add to your water. Unlike nutrition bars that freeze on your winter treks or melt during hot adventure races, the Complex Carbohydr...</td>
<td>453268,453277,510450,516828,520780,542684,634756</td>
<td>False</td>
<td>7</td>
<td>3</td>
<td>11</td>
<td>9.2</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>df_copy[<span class="st">'min_code_freq'</span>] <span class="op">=</span> df_copy.<span class="bu">apply</span>(</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> row: <span class="bu">min</span>([lbl_freqs[lbl] <span class="cf">for</span> lbl <span class="kw">in</span> row.labels.split(<span class="st">','</span>)]), axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>df_copy[<span class="st">'max_code_freq'</span>] <span class="op">=</span> df_copy.<span class="bu">apply</span>(</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> row: <span class="bu">max</span>([lbl_freqs[lbl] <span class="cf">for</span> lbl <span class="kw">in</span> row.labels.split(<span class="st">','</span>)]), axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>df_copy[<span class="st">'90pct_code_freq'</span>] <span class="op">=</span> df_copy.<span class="bu">apply</span>(</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> row: np.percentile([lbl_freqs[lbl] <span class="cf">for</span> lbl <span class="kw">in</span> row.labels.split(<span class="st">','</span>)], <span class="dv">90</span>), axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(nrows<span class="op">=</span><span class="dv">3</span>, ncols<span class="op">=</span><span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">20</span>,<span class="dv">20</span>))</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> freq, axis <span class="kw">in</span> <span class="bu">zip</span>([<span class="st">'min_code_freq'</span>, <span class="st">'max_code_freq'</span>, <span class="st">'90pct_code_freq'</span>], axes):</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    df_copy[freq].hist(ax<span class="op">=</span>axis[<span class="dv">0</span>], bins<span class="op">=</span><span class="dv">25</span>)</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    axis[<span class="dv">0</span>].set_xlabel(freq)</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    axis[<span class="dv">0</span>].set_ylabel(<span class="st">'Text Count'</span>)</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>    df_copy[freq].plot.density(ax<span class="op">=</span>axis[<span class="dv">1</span>])</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>    axis[<span class="dv">1</span>].set_xlabel(freq)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="18_tutorial.train_mimic3_files/figure-html/cell-60-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>min_code_freqs <span class="op">=</span> Counter(df_copy[<span class="st">'min_code_freq'</span>])</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>max_code_freqs <span class="op">=</span> Counter(df_copy[<span class="st">'max_code_freq'</span>])</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>nintypct_code_freqs <span class="op">=</span> Counter(df_copy[<span class="st">'90pct_code_freq'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>total_notes <span class="op">=</span> L(min_code_freqs.values()).<span class="bu">sum</span>()</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>total_notes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>643474</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> kmin <span class="kw">in</span> min_code_freqs:</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>    min_code_freqs[kmin] <span class="op">=</span> (min_code_freqs[kmin]<span class="op">/</span>total_notes) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> kmax <span class="kw">in</span> max_code_freqs:</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    max_code_freqs[kmax] <span class="op">=</span> (max_code_freqs[kmax]<span class="op">/</span>total_notes) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k90pct <span class="kw">in</span> nintypct_code_freqs:</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>    nintypct_code_freqs[k90pct] <span class="op">=</span> (nintypct_code_freqs[k90pct]<span class="op">/</span>total_notes) <span class="op">*</span> <span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>min_code_freqs <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">sorted</span>(min_code_freqs.items(), key<span class="op">=</span><span class="kw">lambda</span> item: item[<span class="dv">0</span>]))</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>max_code_freqs <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">sorted</span>(max_code_freqs.items(), key<span class="op">=</span><span class="kw">lambda</span> item: item[<span class="dv">0</span>]))</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>nintypct_code_freqs <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">sorted</span>(nintypct_code_freqs.items(), key<span class="op">=</span><span class="kw">lambda</span> item: item[<span class="dv">0</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(nrows<span class="op">=</span><span class="dv">3</span>, ncols<span class="op">=</span><span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">20</span>,<span class="dv">20</span>))</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> axis, freq_dict, label <span class="kw">in</span> <span class="bu">zip</span>(axes, (min_code_freqs, max_code_freqs, nintypct_code_freqs), (<span class="st">'min'</span>, <span class="st">'max'</span>, <span class="st">'90pct'</span>)):</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>    axis[<span class="dv">0</span>].plot(freq_dict.keys(), freq_dict.values())</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    axis[<span class="dv">0</span>].set_xlabel(<span class="ss">f"</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss"> label freq (f)"</span>)</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>    axis[<span class="dv">0</span>].set_ylabel(<span class="st">"</span><span class="sc">% o</span><span class="st">f texts (P[f])"</span>)<span class="op">;</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>    axis[<span class="dv">1</span>].plot(freq_dict.keys(), np.cumsum(<span class="bu">list</span>(freq_dict.values())))</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>    axis[<span class="dv">1</span>].set_xlabel(<span class="ss">f"</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss"> code freq (f)"</span>)</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>    axis[<span class="dv">1</span>].set_ylabel(<span class="st">"P[f&lt;=t]"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="18_tutorial.train_mimic3_files/figure-html/cell-65-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="steps-for-creating-the-classifier-dataloaders-using-fastais-transforms" class="level3">
<h3 class="anchored" data-anchor-id="steps-for-creating-the-classifier-dataloaders-using-fastais-transforms">Steps for creating the classifier <code>DataLoaders</code> using fastai’s <code>Transforms</code>:</h3>
<section id="trainvalid-splitter" class="level4">
<h4 class="anchored" data-anchor-id="trainvalid-splitter">1. train/valid <code>splitter</code>:</h4>
<p>Okay, based on the <code>is_valid</code> column of our Dataframe, let’s create a splitter:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> splitter(df):</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>    train <span class="op">=</span> df.index[<span class="op">~</span>df[<span class="st">'is_valid'</span>]].tolist()</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>    valid <span class="op">=</span> df.index[df[<span class="st">'is_valid'</span>]].to_list()</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> train, valid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s check the train/valid split</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>splits <span class="op">=</span> [train, valid] <span class="op">=</span> splitter(df)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>L(splits[<span class="dv">0</span>]), L(splits[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>((#49354) [0,1,2,3,4,5,6,7,8,9...],
 (#3372) [1631,1632,1633,1634,1635,1636,1637,1638,1639,1640...])</code></pre>
</div>
</div>
</section>
<section id="making-the-datasets-object" class="level4">
<h4 class="anchored" data-anchor-id="making-the-datasets-object">2. Making the <code>Datasets</code> object:</h4>
<p><strong>Crucial:</strong> We need the vocab of the language model so that we can make sure we use the same correspondence of token to index. Otherwise, the embeddings we learned in our fine-tuned language model won’t make any sense to our classifier model, and the fine-tuning won’t be of any use. So we need to pass the <code>lm_vocab</code> to the <code>Numericalize</code> transform:</p>
<p>So let’s load the vocab of the language model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>lm_vocab <span class="op">=</span> torch.load(source<span class="op">/</span><span class="st">'mimic3-9k_dls_lm_vocab.pkl'</span>)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>lm_vocab_r <span class="op">=</span> torch.load(source<span class="op">/</span><span class="st">'mimic3-9k_dls_lm_vocab_r.pkl'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>all_equal(lm_vocab, lm_vocab_r)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>L(lm_vocab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(#57376) ['xxunk','xxpad','xxbos','xxeos','xxfld','xxrep','xxwrep','xxup','xxmaj','the'...]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>x_tfms <span class="op">=</span> [Tokenizer.from_df(<span class="st">'text'</span>), attrgetter(<span class="st">"text"</span>), Numericalize(vocab<span class="op">=</span>lm_vocab)]</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>x_tfms_r <span class="op">=</span> [Tokenizer.from_df(<span class="st">'text'</span>, ), attrgetter(<span class="st">"text"</span>), Numericalize(vocab<span class="op">=</span>lm_vocab), reverse_text]</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>y_tfms <span class="op">=</span> [ColReader(<span class="st">'labels'</span>, label_delim<span class="op">=</span><span class="st">';'</span>), MultiCategorize(vocab<span class="op">=</span>lbls), OneHotEncode()]</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>tfms <span class="op">=</span> [x_tfms, y_tfms]</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>tfms_r <span class="op">=</span> [x_tfms_r, y_tfms]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>dsets <span class="op">=</span> Datasets(df, tfms, splits<span class="op">=</span>splits)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 17.9 s, sys: 3.27 s, total: 21.2 s
Wall time: 2min 38s</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>dsets_r <span class="op">=</span> Datasets(df, tfms_r, splits<span class="op">=</span>splits)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 18.2 s, sys: 4.67 s, total: 22.9 s
Wall time: 2min 54s</code></pre>
</div>
</div>
<p>Let’s now check if our <code>Datasets</code> got created alright:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(dsets.train), <span class="bu">len</span>(dsets.valid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(49354, 3372)</code></pre>
</div>
</div>
<p>Let’s check a random data point:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> random.randint(<span class="dv">0</span>, <span class="bu">len</span>(dsets))</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> dsets.train[idx]</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">isinstance</span>(x, <span class="bu">tuple</span>) <span class="co"># tuple if independent and dependent variable</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>x_r <span class="op">=</span> dsets_r.train[idx]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>dsets.decode(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>('xxbos admission date discharge date date of birth sex f service medicine allergies nsaids aspirin influenza virus vaccine attending first name3 lf chief complaint hypotension resp distress major surgical or invasive procedure rij placement and removal last name un gastric tube placement and removal rectal tube placement and removal picc line placement and removal history of present illness ms known lastname is a 50f with cirrhosis of unproven etiology h o perforated duodenal ulcer who has had weakness and back pain with cough and shortness of breath for days she has chronic low back pain but this is in a different location she also reports fever and chills she reports increasing weakness and fatigue over the same amount of time she is followed by vna who saw her at home and secondary to hypotension and hypoxia requested she go to ed in the ed initial vs were afebrile and o2 sat unable to be read ct of torso showed pneumonia but no abdominal pathology she was seen by surgery she was found to be significantly hypoxic and started on nrb a right ij was placed she was started on levophed after a drop in her pressures in the micu she is conversant and able to tell her story past medical history asthma does not use inhalers htn off meds for several years rheumatoid arthritis seronegative chronic severe back pain s p c sections history of secondary syphilis treated polysubstance abuse notably cocaine but no drug or alcohol use for at least past months depression pulmonary hypertension severe on cardiac cath restrictive lung disease seizures in childhood cirrhosis by liver biopsy etiology as yet unknown duodenal ulcer s p surgical repair xxunk location un in summer social history lives with boyfriend who helps in her healthcare has children past h o cocaine abuse but not current denies any etoh drug or tobacco use since cirrhosis diagnosis in month only previously smoked up to pack per wk family history noncontributory physical exam on admission t hr bp r o2 sat on nrb general alert oriented moderate respiratory distress heent sclera anicteric drymm oropharynx clear neck supple jvp not elevated no lad lungs rhonchi and crackles in bases xxrep 3 l with egophany increased xxunk cv tachy rate and rhythm normal s1 s2 no murmurs rubs gallops abdomen soft diffusely tender non distended bowel sounds present healing midline ex lap wound dehiscence on caudal end but without erythema drainage ext warm well perfused pulses no clubbing cyanosis or edema pertinent results admission labs 13pm blood wbc rbc hgb hct mcv mch mchc rdw plt ct 13pm blood neuts bands lymphs monos eos baso 13pm blood pt ptt inr pt 13pm blood plt smr high plt ct 13pm blood glucose urean creat na k cl hco3 angap 13pm blood alt ast ld ldh alkphos amylase totbili 22am blood ck mb ctropnt 42pm blood probnp numeric identifier 13pm blood albumin calcium phos mg 22am blood cortsol 28pm blood type art o2 flow po2 pco2 ph caltco2 base xs intubat not intuba vent spontaneou comment non rebrea 20pm blood lactate discharge labs 58am blood wbc rbc hgb hct mcv mch mchc rdw plt ct 58am blood plt ct 58am blood pt ptt inr pt 58am blood glucose urean creat na k cl hco3 angap 58am blood alt ast ld ldh alkphos totbili 58am blood calcium phos mg imaging ct chest abd pelvis impression no etiology for abdominal pain identified no free air is noted within the abdomen interval increase in diffuse anasarca and bilateral pleural effusions small on the right and small to moderate on the left compressive atelectasis and new bilateral lower lobe pneumonias interval improvement in the degree of mediastinal lymphadenopathy interval development of small pericardial effusion no ct findings to suggest tamponade tte the left atrium is normal in size there is mild symmetric left ventricular hypertrophy with normal cavity size and regional global systolic function lvef the estimated cardiac index is borderline low 5l min m2 tissue doppler imaging suggests a normal left ventricular filling pressure pcwp 12mmhg the right ventricular free wall is hypertrophied the right ventricular cavity is markedly dilated with severe global free wall hypokinesis there is abnormal septal motion position consistent with right ventricular pressure volume overload the aortic valve leaflets appear structurally normal with good leaflet excursion and no aortic regurgitation the mitral valve leaflets are structurally normal mild mitral regurgitation is seen the tricuspid valve leaflets are mildly thickened there is mild moderate tricuspid xxunk there is severe pulmonary artery systolic hypertension there is a small circumferential pericardial effusion without echocardiographic signs of tamponade compared with the prior study images reviewed of the overall findings are similar ct abd pelvis impression anasarca increased bilateral pleural effusions small to moderate right greater than left trace pericardial fluid increased left lower lobe collapse consolidation right basilar atelectasis has also increased new ascites no free air dilated fluid filled colon and rectum no wall thickening to suggest colitis no evidence of small bowel obstruction bilat upper extremities venous ultrasound impression non occlusive right subclavian deep vein thrombosis cta chest impression no pulmonary embolism to the subsegmental level anasarca moderate to large left and moderate right pleural effusion small pericardial effusion unchanged right ventricle and right atrium enlargement since enlarged main pulmonary artery could be due to pulmonary hypertension complete collapse of the left lower lobe pneumonia can not be ruled out right basilar atelectasis kub impression unchanged borderline distended colon no evidence of small bowel obstruction or ileus brief hospital course this is a 50f with severe pulmonary hypertension h o duodenal perf s p surgical repair cirrhosis of unknown etiology and h o polysubstance abuse who presented with septic shock secondary pneumonia with respiratory distress septic shock pneumonia fever hypotension tachycardia hypoxia leukocytosis with xxrep 3 l infiltrate initially pt was treated for both health care associated pneumonia and possible c diff infection given wbc on admission however c diff treatment was stopped after patient tested negative x3 she completed a day course of vancomycin zosyn on for pneumonia she did initially require non rebreather in the icu but for the last week prior to discharge she has had stable o2 sats to mid s on nasal cannula she did also require pressors for the first several days of this hospitalization but was successfully weaned off pressors approximately wk prior to discharge at the time of discharge she is maintaining stable bp s 100s 110s doppler due to repeated ivf boluses for hypotension during this admission the pt developed anasarca and at the time of discharge is being slowly diuresed with lasix iv daily ogilvies pseudo obstruction the pt experience abd pain and distention with radiologic evidence of dilated loops of small bowel and large bowel during this hospitalization there was never any evidence of a transition point of stricture both a rectal and ngt were placed for decompression the pts symptoms and abd exam improved during the days prior to discharge and at the time of discharge she is tolerating a regular po diet and having normal bowel movements chronic back pain the pt has a long h o chronic back pain she was treated with iv morphine here for acute on chronic back pain likely exacerbated by bed rest and ileus at discharge she was transitioned to po morphine cirrhosis the etiology of this is unknown but the pt has biopsy proven cirrhosis from liver biopsy this likely explains her baseline coagulopathy and hypoalbuminemia here she needs to have outpt f u with hepatology she has no known complications of cirrhosis at this time rue dvt the pt has a rue dvt seen on u s associated with rij cvl which was placed in house she was started on a heparin gtt which was transitioned to coumadin prior to discharge at discharge her inr is she should have follow up lab work on friday of note at discharge the pt had several healing boils on her inner upper thighs thought to be trauma from her foley rubbing against the skin no further treatment was thought to be neccessary for these medications on admission clobetasol cream apply to affected area twice a day as needed gabapentin neurontin mg tablet tablet s by mouth three times a day metoprolol tartrate mg tablet tablet s by mouth twice a day omeprazole mg capsule delayed release e c capsule delayed release e c s by mouth once a day oxycodone mg capsule capsule s by mouth q hours physical therapy dx first name9 namepattern2 location un evaluation and management of motor skills tramadol mg tablet tablet s by mouth twice a day as needed for pain trazodone mg tablet tablet s by mouth hs medications otc docusate sodium mg ml liquid teaspoon by mouth twice a day as needed magnesium oxide mg tablet tablet s by mouth twice a day discharge medications ipratropium bromide solution sig one nebulizer inhalation q6h every hours clobetasol ointment sig one appl topical hospital1 times a day lidocaine mg patch adhesive patch medicated sig one adhesive patch medicated topical qday as needed for back pain please wear on skin hrs then have hrs with patch off hemorrhoidal suppository suppository sig one suppository rectal once a day as needed for pain pantoprazole mg tablet delayed release e c sig one tablet delayed release e c po twice a day outpatient lab work please have you inr checked saturday the results should be sent to your doctor at rehab multivitamin tablet sig one tablet po once a day morphine mg ml solution sig mg po every four hours as needed for pain warfarin mg tablet sig one tablet po once daily at pm discharge disposition extended care facility hospital3 hospital discharge diagnosis healthcare associated pneumonia colonic pseudo obstruction severe pulmonary hypertension cirrhosis htn chronic back pain right upper extremity dvt discharge condition good o2 sat high s on 3l nc bp stable 100s 110s doppler patient tolerating regular diet and having bowel movements not ambulatory discharge instructions you were admitted with a pneumonia which required a stay in our icu but did not require intubation or the use of a breathing tube you did need medications for a low blood pressure for the first several days of your hospitalization while you were here you also had problems with your intestines that caused them to stop working and food to get stuck in your intestines we treated you for this and you are now able to eat and move your bowels you got a blood clot in your arm while you were here we started you on iv medication for this initially but have now transitioned you to oral anticoagulants your doctor will need to monitor the levels of this medication at rehab you will likely need to remain on this medication for months please follow up as below you need to see a hepatologist liver doctor within the next month to follow up on your diagnosis of cirrhosis your list of medications is attached please call your doctor or return to the hospital if you have fevers shortness of breath chest pain abdominal pain vomitting inability to tolerate food or liquids by mouth dizziness or any other concerning symptoms followup instructions primary care first name11 name pattern1 last name namepattern4 md phone telephone fax date time dermatology name6 md name8 md md phone telephone fax date time you need to have your blood drawn to monitor your inr or coumadin level next on saturday the doctor at the rehab with change your coumadin dose accordingly please follow up with a hepatologist liver doctor within month if you would like to make an appointment at our liver center at hospital1 the number is telephone fax please follow up with a pulmonologist about your severe pulmonary hypertension within month if you do not have a pulmonologist and would like to follow up at hospital1 the number is telephone fax completed by',
 (#18) ['401.9','38.93','493.90','785.52','995.92','070.54','276.1','038.9','486','518.82'...])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>dsets.show(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>xxbos admission date discharge date date of birth sex f service medicine allergies nsaids aspirin influenza virus vaccine attending first name3 lf chief complaint hypotension resp distress major surgical or invasive procedure rij placement and removal last name un gastric tube placement and removal rectal tube placement and removal picc line placement and removal history of present illness ms known lastname is a 50f with cirrhosis of unproven etiology h o perforated duodenal ulcer who has had weakness and back pain with cough and shortness of breath for days she has chronic low back pain but this is in a different location she also reports fever and chills she reports increasing weakness and fatigue over the same amount of time she is followed by vna who saw her at home and secondary to hypotension and hypoxia requested she go to ed in the ed initial vs were afebrile and o2 sat unable to be read ct of torso showed pneumonia but no abdominal pathology she was seen by surgery she was found to be significantly hypoxic and started on nrb a right ij was placed she was started on levophed after a drop in her pressures in the micu she is conversant and able to tell her story past medical history asthma does not use inhalers htn off meds for several years rheumatoid arthritis seronegative chronic severe back pain s p c sections history of secondary syphilis treated polysubstance abuse notably cocaine but no drug or alcohol use for at least past months depression pulmonary hypertension severe on cardiac cath restrictive lung disease seizures in childhood cirrhosis by liver biopsy etiology as yet unknown duodenal ulcer s p surgical repair xxunk location un in summer social history lives with boyfriend who helps in her healthcare has children past h o cocaine abuse but not current denies any etoh drug or tobacco use since cirrhosis diagnosis in month only previously smoked up to pack per wk family history noncontributory physical exam on admission t hr bp r o2 sat on nrb general alert oriented moderate respiratory distress heent sclera anicteric drymm oropharynx clear neck supple jvp not elevated no lad lungs rhonchi and crackles in bases xxrep 3 l with egophany increased xxunk cv tachy rate and rhythm normal s1 s2 no murmurs rubs gallops abdomen soft diffusely tender non distended bowel sounds present healing midline ex lap wound dehiscence on caudal end but without erythema drainage ext warm well perfused pulses no clubbing cyanosis or edema pertinent results admission labs 13pm blood wbc rbc hgb hct mcv mch mchc rdw plt ct 13pm blood neuts bands lymphs monos eos baso 13pm blood pt ptt inr pt 13pm blood plt smr high plt ct 13pm blood glucose urean creat na k cl hco3 angap 13pm blood alt ast ld ldh alkphos amylase totbili 22am blood ck mb ctropnt 42pm blood probnp numeric identifier 13pm blood albumin calcium phos mg 22am blood cortsol 28pm blood type art o2 flow po2 pco2 ph caltco2 base xs intubat not intuba vent spontaneou comment non rebrea 20pm blood lactate discharge labs 58am blood wbc rbc hgb hct mcv mch mchc rdw plt ct 58am blood plt ct 58am blood pt ptt inr pt 58am blood glucose urean creat na k cl hco3 angap 58am blood alt ast ld ldh alkphos totbili 58am blood calcium phos mg imaging ct chest abd pelvis impression no etiology for abdominal pain identified no free air is noted within the abdomen interval increase in diffuse anasarca and bilateral pleural effusions small on the right and small to moderate on the left compressive atelectasis and new bilateral lower lobe pneumonias interval improvement in the degree of mediastinal lymphadenopathy interval development of small pericardial effusion no ct findings to suggest tamponade tte the left atrium is normal in size there is mild symmetric left ventricular hypertrophy with normal cavity size and regional global systolic function lvef the estimated cardiac index is borderline low 5l min m2 tissue doppler imaging suggests a normal left ventricular filling pressure pcwp 12mmhg the right ventricular free wall is hypertrophied the right ventricular cavity is markedly dilated with severe global free wall hypokinesis there is abnormal septal motion position consistent with right ventricular pressure volume overload the aortic valve leaflets appear structurally normal with good leaflet excursion and no aortic regurgitation the mitral valve leaflets are structurally normal mild mitral regurgitation is seen the tricuspid valve leaflets are mildly thickened there is mild moderate tricuspid xxunk there is severe pulmonary artery systolic hypertension there is a small circumferential pericardial effusion without echocardiographic signs of tamponade compared with the prior study images reviewed of the overall findings are similar ct abd pelvis impression anasarca increased bilateral pleural effusions small to moderate right greater than left trace pericardial fluid increased left lower lobe collapse consolidation right basilar atelectasis has also increased new ascites no free air dilated fluid filled colon and rectum no wall thickening to suggest colitis no evidence of small bowel obstruction bilat upper extremities venous ultrasound impression non occlusive right subclavian deep vein thrombosis cta chest impression no pulmonary embolism to the subsegmental level anasarca moderate to large left and moderate right pleural effusion small pericardial effusion unchanged right ventricle and right atrium enlargement since enlarged main pulmonary artery could be due to pulmonary hypertension complete collapse of the left lower lobe pneumonia can not be ruled out right basilar atelectasis kub impression unchanged borderline distended colon no evidence of small bowel obstruction or ileus brief hospital course this is a 50f with severe pulmonary hypertension h o duodenal perf s p surgical repair cirrhosis of unknown etiology and h o polysubstance abuse who presented with septic shock secondary pneumonia with respiratory distress septic shock pneumonia fever hypotension tachycardia hypoxia leukocytosis with xxrep 3 l infiltrate initially pt was treated for both health care associated pneumonia and possible c diff infection given wbc on admission however c diff treatment was stopped after patient tested negative x3 she completed a day course of vancomycin zosyn on for pneumonia she did initially require non rebreather in the icu but for the last week prior to discharge she has had stable o2 sats to mid s on nasal cannula she did also require pressors for the first several days of this hospitalization but was successfully weaned off pressors approximately wk prior to discharge at the time of discharge she is maintaining stable bp s 100s 110s doppler due to repeated ivf boluses for hypotension during this admission the pt developed anasarca and at the time of discharge is being slowly diuresed with lasix iv daily ogilvies pseudo obstruction the pt experience abd pain and distention with radiologic evidence of dilated loops of small bowel and large bowel during this hospitalization there was never any evidence of a transition point of stricture both a rectal and ngt were placed for decompression the pts symptoms and abd exam improved during the days prior to discharge and at the time of discharge she is tolerating a regular po diet and having normal bowel movements chronic back pain the pt has a long h o chronic back pain she was treated with iv morphine here for acute on chronic back pain likely exacerbated by bed rest and ileus at discharge she was transitioned to po morphine cirrhosis the etiology of this is unknown but the pt has biopsy proven cirrhosis from liver biopsy this likely explains her baseline coagulopathy and hypoalbuminemia here she needs to have outpt f u with hepatology she has no known complications of cirrhosis at this time rue dvt the pt has a rue dvt seen on u s associated with rij cvl which was placed in house she was started on a heparin gtt which was transitioned to coumadin prior to discharge at discharge her inr is she should have follow up lab work on friday of note at discharge the pt had several healing boils on her inner upper thighs thought to be trauma from her foley rubbing against the skin no further treatment was thought to be neccessary for these medications on admission clobetasol cream apply to affected area twice a day as needed gabapentin neurontin mg tablet tablet s by mouth three times a day metoprolol tartrate mg tablet tablet s by mouth twice a day omeprazole mg capsule delayed release e c capsule delayed release e c s by mouth once a day oxycodone mg capsule capsule s by mouth q hours physical therapy dx first name9 namepattern2 location un evaluation and management of motor skills tramadol mg tablet tablet s by mouth twice a day as needed for pain trazodone mg tablet tablet s by mouth hs medications otc docusate sodium mg ml liquid teaspoon by mouth twice a day as needed magnesium oxide mg tablet tablet s by mouth twice a day discharge medications ipratropium bromide solution sig one nebulizer inhalation q6h every hours clobetasol ointment sig one appl topical hospital1 times a day lidocaine mg patch adhesive patch medicated sig one adhesive patch medicated topical qday as needed for back pain please wear on skin hrs then have hrs with patch off hemorrhoidal suppository suppository sig one suppository rectal once a day as needed for pain pantoprazole mg tablet delayed release e c sig one tablet delayed release e c po twice a day outpatient lab work please have you inr checked saturday the results should be sent to your doctor at rehab multivitamin tablet sig one tablet po once a day morphine mg ml solution sig mg po every four hours as needed for pain warfarin mg tablet sig one tablet po once daily at pm discharge disposition extended care facility hospital3 hospital discharge diagnosis healthcare associated pneumonia colonic pseudo obstruction severe pulmonary hypertension cirrhosis htn chronic back pain right upper extremity dvt discharge condition good o2 sat high s on 3l nc bp stable 100s 110s doppler patient tolerating regular diet and having bowel movements not ambulatory discharge instructions you were admitted with a pneumonia which required a stay in our icu but did not require intubation or the use of a breathing tube you did need medications for a low blood pressure for the first several days of your hospitalization while you were here you also had problems with your intestines that caused them to stop working and food to get stuck in your intestines we treated you for this and you are now able to eat and move your bowels you got a blood clot in your arm while you were here we started you on iv medication for this initially but have now transitioned you to oral anticoagulants your doctor will need to monitor the levels of this medication at rehab you will likely need to remain on this medication for months please follow up as below you need to see a hepatologist liver doctor within the next month to follow up on your diagnosis of cirrhosis your list of medications is attached please call your doctor or return to the hospital if you have fevers shortness of breath chest pain abdominal pain vomitting inability to tolerate food or liquids by mouth dizziness or any other concerning symptoms followup instructions primary care first name11 name pattern1 last name namepattern4 md phone telephone fax date time dermatology name6 md name8 md md phone telephone fax date time you need to have your blood drawn to monitor your inr or coumadin level next on saturday the doctor at the rehab with change your coumadin dose accordingly please follow up with a hepatologist liver doctor within month if you would like to make an appointment at our liver center at hospital1 the number is telephone fax please follow up with a pulmonologist about your severe pulmonary hypertension within month if you do not have a pulmonologist and would like to follow up at hospital1 the number is telephone fax completed by
401.9;38.93;493.90;785.52;995.92;070.54;276.1;038.9;486;518.82;453.8;714.0;571.5;996.74;560.1;96.07;416.0;96.09</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">isinstance</span>(dsets.tfms[<span class="dv">0</span>], Pipeline) <span class="co"># `Pipeline` of the `x_tfms`</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">isinstance</span>(dsets.tfms[<span class="dv">0</span>][<span class="dv">0</span>], Tokenizer)</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">isinstance</span>(dsets.tfms[<span class="dv">0</span>][<span class="dv">1</span>], Transform)</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">isinstance</span>(dsets.tfms[<span class="dv">0</span>][<span class="dv">2</span>], Numericalize)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we just want to decode the one-hot encoded dependent variable:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>_ind, _dep <span class="op">=</span> x</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>_lbl <span class="op">=</span> dsets.tfms[<span class="dv">1</span>].decode(_dep)</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>test_eq(_lbl, array(lbls)[_dep.nonzero().flatten().<span class="bu">int</span>().numpy()])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s extract the <code>MultiCategorize</code> transform applied by <code>dsets</code> on the dependent variable so that we can apply it ourselves:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>tfm_cat <span class="op">=</span> dsets.tfms[<span class="dv">1</span>][<span class="dv">1</span>]</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>test_eq(<span class="bu">str</span>(tfm_cat.__class__), <span class="st">"&lt;class 'fastai.data.transforms.MultiCategorize'&gt;"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>vocab</code> attribute of the <code>MultiCategorize</code> transform stores the category vocabulary. If it was specified from outside (in this case it was) then the <code>MultiCategorize</code> transform will not sort the vocabulary otherwise it will.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>test_eq(lbls, tfm_cat.vocab)</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>test_ne(lbls, <span class="bu">sorted</span>(tfm_cat.vocab))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>test_eq(<span class="bu">str</span>(_lbl.__class__), <span class="st">"&lt;class 'fastai.data.transforms.MultiCategory'&gt;"</span>)</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>test_eq(tfm_cat(_lbl), TensorMultiCategory([lbls.index(o) <span class="cf">for</span> o <span class="kw">in</span> _lbl]))</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>test_eq(tfm_cat.decode(tfm_cat(_lbl)), _lbl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s check the reverse:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dsets_r.decode(x_r)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dsets_r.show(x_r)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Looks pretty good!</p>
</section>
<section id="making-the-dataloaders-object" class="level4">
<h4 class="anchored" data-anchor-id="making-the-dataloaders-object">3. Making the <code>DataLoaders</code> object:</h4>
<p>We need to pick the sequence length and the batch size (you might have to adjust this depending on you GPU size)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>bs, sl <span class="op">=</span> <span class="dv">16</span>, <span class="dv">72</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will use the <code>dl_type</code> argument of the <code>DataLoaders</code>. The purpose is to tell <code>DataLoaders</code> to use <code>SortedDL</code> class of the <code>DataLoader</code>, and not the usual one. <code>SortedDL</code> constructs batches by putting samples of roughly the same lengths into batches.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>dl_type <span class="op">=</span> partial(SortedDL, shuffle<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Crucial:</strong> - We will use <strong><code>pad_input_chunk</code></strong> because our encoder <code>AWD_LSTM</code> will be wrapped inside <a href="https://debjyotiSRoy.github.io/xcube/text.models.core.html#sentenceencoder"><code>SentenceEncoder</code></a>. - A <code>SenetenceEncoder</code> expects that all the documents are padded, - with most of the padding at the beginning of the document, with each sequence beginning at a round multiple of bptt - and the rest of the padding at the end.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>dls_clas <span class="op">=</span> dsets.dataloaders(bs<span class="op">=</span>bs, seq_len<span class="op">=</span>sl, </span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>                             dl_type<span class="op">=</span>dl_type,</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>                             before_batch<span class="op">=</span>pad_input_chunk)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For the reverse:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>dls_clas_r <span class="op">=</span> dsets_r.dataloaders(bs<span class="op">=</span>bs, seq_len<span class="op">=</span>sl,</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>                                 dl_type<span class="op">=</span>dl_type,</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>                                 before_batch<span class="op">=</span>pad_input_chunk)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Creating the <code>DataLoaders</code> object takes considerable amount of time, so do save it when working on your dataset. In this though, (as always) <a href="https://debjyotiSRoy.github.io/xcube/data.external.html#untar_xxx"><code>untar_xxx</code></a> downloaded it for you:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>tree <span class="op">-</span>shLD <span class="dv">1</span> {source} <span class="op">-</span>P <span class="op">*</span>clas<span class="op">*</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="co"># or using glob</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a><span class="co"># L(source.glob("**/*clas*"))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>/home/deb/.xcube/data/mimic3
├── [192M May  1  2022]  mimic3-9k_clas.pth
├── [758K Mar 27 17:59]  mimic3-9k_clas_full_vocab.pkl
├── [1.6G Apr 21 18:29]  mimic3-9k_dls_clas.pkl
├── [1.6G Apr  5 17:17]  mimic3-9k_dls_clas_old_remove_later.pkl
├── [1.6G Apr 21 18:30]  mimic3-9k_dls_clas_r.pkl
└── [1.6G Apr  5 17:18]  mimic3-9k_dls_clas_r_old_remove_later.pkl

0 directories, 6 files</code></pre>
</div>
</div>
<p>Aside: Some handy linux find tricks: 1. https://stackoverflow.com/questions/18312935/find-file-in-linux-then-report-the-size-of-file-searched 2. https://stackoverflow.com/questions/4210042/how-to-exclude-a-directory-in-find-command</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co"># !find -path ./models -prune -o -type f -name "*caml*" -exec du -sh {} \;</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="co"># !find -not -path "./data/*" -type f -name "*caml*" -exec du -sh {} \;</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a><span class="co"># !find {path_data} -type f -name "*caml*" | xargs du -sh</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you want to load the dls for the full dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>dls_clas <span class="op">=</span> torch.load(source<span class="op">/</span><span class="st">'mimic3-9k_dls_clas.pkl'</span>)</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>dls_clas_r <span class="op">=</span> torch.load(source<span class="op">/</span><span class="st">'mimic3-9k_dls_clas_r.pkl'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 13.1 s, sys: 3.16 s, total: 16.2 s
Wall time: 16.6 s</code></pre>
</div>
</div>
<p>Let’s take a look at the data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dls_clas.show_batch(max_n=3)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dls_clas_r.show_batch(max_n=3)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="optional-making-the-dataloaders-using-fastais-datablock-api" class="level4">
<h4 class="anchored" data-anchor-id="optional-making-the-dataloaders-using-fastais-datablock-api">4. (Optional) Making the <code>DataLoaders</code> using fastai’s <code>DataBlock</code> API:</h4>
<p>It’s worth mentioning here that all the steps we performed to create the <code>DataLoaders</code> can be packaged together using fastai’s <code>DataBlock</code> API.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>        blocks <span class="op">=</span> (TextBlock.from_df(<span class="st">'text'</span>, seq_len<span class="op">=</span>sl, vocab<span class="op">=</span>lm_vocab), MultiCategoryBlock(vocab<span class="op">=</span>lbls)),</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>        get_x <span class="op">=</span> ColReader(<span class="st">'text'</span>),</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>        get_y <span class="op">=</span> ColReader(<span class="st">'labels'</span>, label_delim<span class="op">=</span><span class="st">';'</span>),</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>        splitter <span class="op">=</span> splitter,</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>        dl_type <span class="op">=</span> dl_type,</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>dls_clas <span class="op">=</span> dblock.dataloaders(df, bs<span class="op">=</span>bs, before_batch<span class="op">=</span>pad_input_chunk)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>dls_clas.show_batch(max_n<span class="op">=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="learner-for-multi-label-classifier-fine-tuning" class="level2">
<h2 class="anchored" data-anchor-id="learner-for-multi-label-classifier-fine-tuning"><code>Learner</code> for Multi-Label Classifier Fine-Tuning</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set_seed(897997989, reproducible=True)</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a><span class="co"># set_seed(67, reproducible=True)</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>set_seed(<span class="dv">1</span>, reproducible<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is where we have <code>dls_clas</code>(for the full dataset) we made in the previous section:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>tree <span class="op">-</span>shDL <span class="dv">1</span> {source} <span class="op">-</span>P <span class="st">"*clas*"</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="co"># or using glob</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a><span class="co"># L(source.glob("**/*clas*"))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>/home/deb/.xcube/data/mimic3
├── [576M Jun  8 13:21]  mimic3-9k_clas_full.pth
├── [576M May 26 12:00]  mimic3-9k_clas_full_r.pth
├── [758K Mar 27 17:59]  mimic3-9k_clas_full_vocab.pkl
├── [1.6G Apr 21 18:29]  mimic3-9k_dls_clas.pkl
└── [1.6G Apr 21 18:30]  mimic3-9k_dls_clas_r.pkl

0 directories, 5 files</code></pre>
</div>
</div>
<p>And this is where we have the finetuned language model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>tree <span class="op">-</span>shDL <span class="dv">1</span> {source} <span class="op">-</span>P <span class="st">'*fine*'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>/home/deb/.xcube/data/mimic3
├── [165M Apr 30  2022]  mimic3-9k_lm_finetuned.pth
└── [165M May  7  2022]  mimic3-9k_lm_finetuned_r.pth

0 directories, 2 files</code></pre>
</div>
</div>
<p>And this is where we have the bootstrapped brain and the label biases:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>tree <span class="op">-</span>shDL <span class="dv">1</span> {source_l2r} <span class="op">-</span>P <span class="st">"*tok_lbl_info*|*p_L*"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>/home/deb/.xcube/data/mimic3_l2r
├── [3.8G Jun 24  2022]  mimic3-9k_tok_lbl_info.pkl
└── [ 70K Apr  3 18:35]  p_L.pkl

0 directories, 2 files</code></pre>
</div>
</div>
<p>Next we’ll create a tmp directory to store results. In order for our learner to have access to the finetuned language model we need to symlink to it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>tmp <span class="op">=</span> Path.cwd()<span class="op">/</span><span class="st">'tmp/models'</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>tmp.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>, parents<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>tmp <span class="op">=</span> tmp.parent</span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a><span class="co"># (tmp/'models'/'mimic3-9k_lm_decoder.pth').symlink_to(source/'mimic3-9k_lm_decoder.pth') # run this just once</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a><span class="co"># (tmp/'models'/'mimic3-9k_lm_decoder_r.pth').symlink_to(source/'mimic3-9k_lm_decoder_r.pth') # run this just once</span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a><span class="co"># (tmp/'models'/'mimic3-9k_lm_finetuned.pth').symlink_to(source/'mimic3-9k_lm_finetuned.pth') # run this just once</span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a><span class="co"># (tmp/'models'/'mimic3-9k_lm_finetuned_r.pth').symlink_to(source/'mimic3-9k_lm_finetuned_r.pth') # run this just once</span></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a><span class="co"># (tmp/'models'/'mimic3-9k_tok_lbl_info.pkl').symlink_to(join_path_file('mimic3-9k_tok_lbl_info', source_l2r, ext='.pkl')) #run this just once</span></span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a><span class="co"># (tmp/'models'/'p_L.pkl').symlink_to(join_path_file('p_L', source_l2r, ext='.pkl')) #run this just once</span></span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a><span class="co"># (tmp/'models'/'lin_lambdarank_full.pth').symlink_to(join_path_file('lin_lambdarank_full', source_l2r, ext='.pth')) #run this just once</span></span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a><span class="co"># list_files(tmp)</span></span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>tree <span class="op">-</span>shD {tmp}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>/home/deb/xcube/nbs/tmp
├── [ 23G Feb 21 13:27]  dls_full.pkl
├── [1.7M Feb 10 16:40]  dls_tiny.pkl
├── [152M Mar  8 00:28]  lin_lambdarank_full.pth
├── [1.0M Mar  7 16:52]  lin_lambdarank_tiny.pth
├── [ 10M Apr 21 17:48]  mimic3-9k_dls_clas_tiny.pkl
├── [ 10M Apr 21 17:48]  mimic3-9k_dls_clas_tiny_r.pkl
├── [4.0K Jun  7 17:39]  models
│&nbsp;&nbsp; ├── [  56 Apr 17 17:29]  lin_lambdarank_full.pth -&gt; /home/deb/.xcube/data/mimic3_l2r/lin_lambdarank_full.pth
│&nbsp;&nbsp; ├── [ 11K Apr 17 13:17]  log.csv
│&nbsp;&nbsp; ├── [576M Jun  8 02:04]  mimic3-9k_clas_full.pth
│&nbsp;&nbsp; ├── [5.4G May 10 18:21]  mimic3-9k_clas_full_predslog.pkl
│&nbsp;&nbsp; ├── [576M May 26 11:55]  mimic3-9k_clas_full_r.pth
│&nbsp;&nbsp; ├── [758K May 26 11:55]  mimic3-9k_clas_full_r_vocab.pkl
│&nbsp;&nbsp; ├── [264K May 10 18:35]  mimic3-9k_clas_full_rank.csv
│&nbsp;&nbsp; ├── [758K Jun  8 02:04]  mimic3-9k_clas_full_vocab.pkl
│&nbsp;&nbsp; ├── [196M Jun  3 13:21]  mimic3-9k_clas_tiny.pth
│&nbsp;&nbsp; ├── [273M Apr  3 13:19]  mimic3-9k_clas_tiny_r.pth
│&nbsp;&nbsp; ├── [635K Apr  3 13:19]  mimic3-9k_clas_tiny_r_vocab.pkl
│&nbsp;&nbsp; ├── [635K Jun  3 13:21]  mimic3-9k_clas_tiny_vocab.pkl
│&nbsp;&nbsp; ├── [  53 Jun  7 17:39]  mimic3-9k_lm_decoder.pth -&gt; /home/deb/.xcube/data/mimic3/mimic3-9k_lm_decoder.pth
│&nbsp;&nbsp; ├── [  55 Jun  7 17:39]  mimic3-9k_lm_decoder_r.pth -&gt; /home/deb/.xcube/data/mimic3/mimic3-9k_lm_decoder_r.pth
│&nbsp;&nbsp; ├── [  55 Mar  8 16:09]  mimic3-9k_lm_finetuned.pth -&gt; /home/deb/.xcube/data/mimic3/mimic3-9k_lm_finetuned.pth
│&nbsp;&nbsp; ├── [  57 Mar 19 19:27]  mimic3-9k_lm_finetuned_r.pth -&gt; /home/deb/.xcube/data/mimic3/mimic3-9k_lm_finetuned_r.pth
│&nbsp;&nbsp; ├── [  59 Mar 29 17:36]  mimic3-9k_tok_lbl_info.pkl -&gt; /home/deb/.xcube/data/mimic3_l2r/mimic3-9k_tok_lbl_info.pkl
│&nbsp;&nbsp; ├── [758K Apr 15 14:29]  mimic5_tmp_vocab.pkl
│&nbsp;&nbsp; └── [  40 Apr  3 20:03]  p_L.pkl -&gt; /home/deb/.xcube/data/mimic3_l2r/p_L.pkl
└── [1.2M Mar  7 16:46]  nn_lambdarank_tiny.pth

1 directory, 26 files</code></pre>
</div>
</div>
<p>Let’s now get the dataloaders for the classifier. We’ll also save classifier with <code>fname</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fname = 'mimic3-9k_clas_tiny'</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>fname <span class="op">=</span> <span class="st">'mimic3-9k_clas_full'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'tiny'</span> <span class="kw">in</span> fname:</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>    dls_clas <span class="op">=</span> torch.load(tmp<span class="op">/</span><span class="st">'mimic3-9k_dls_clas_tiny.pkl'</span>, map_location<span class="op">=</span>default_device())</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>    dls_clas_r <span class="op">=</span> torch.load(tmp<span class="op">/</span><span class="st">'mimic3-9k_dls_clas_tiny_r.pkl'</span>)</span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dls_clas.show_batch(max_n=5)</span></span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> <span class="st">'full'</span> <span class="kw">in</span> fname:</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>    dls_clas <span class="op">=</span> torch.load(source<span class="op">/</span><span class="st">'mimic3-9k_dls_clas.pkl'</span>)</span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>    dls_clas_r <span class="op">=</span> torch.load(source<span class="op">/</span><span class="st">'mimic3-9k_dls_clas_r.pkl'</span>)</span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dls_clas.show_batch(max_n=5)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s create the saving callback upfront:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>fname_r <span class="op">=</span> fname<span class="op">+</span><span class="st">'_r'</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>cbs<span class="op">=</span>SaveModelCallback(monitor<span class="op">=</span><span class="st">'valid_precision_at_k'</span>, fname<span class="op">=</span>fname, with_opt<span class="op">=</span><span class="va">True</span>, reset_on_fit<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>cbs_r<span class="op">=</span>SaveModelCallback(monitor<span class="op">=</span><span class="st">'valid_precision_at_k'</span>, fname<span class="op">=</span>fname_r, with_opt<span class="op">=</span><span class="va">True</span>, reset_on_fit<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will make the <a href="https://debjyotiSRoy.github.io/xcube/text.learner.html#textlearner"><code>TextLearner</code></a> (Here you can use <code>pretrained=False</code> to save time beacuse we are anyway going to <code>load_encoder</code> later which will replace the encoder wgts with the ones we that we have in the fine-tuned LM):</p>
<p>Todo(Deb): Implement TTA - make <code>max_len=None</code> during validation - magnify important tokens</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> xmltext_classifier_learner(dls_clas, AWD_LSTM, drop_mult<span class="op">=</span><span class="fl">0.1</span>, max_len<span class="op">=</span><span class="va">None</span>,<span class="co">#72*40, </span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>                                   metrics<span class="op">=</span>partial(precision_at_k, k<span class="op">=</span><span class="dv">15</span>), path<span class="op">=</span>tmp, cbs<span class="op">=</span>cbs,</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>                                   pretrained<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>                                   splitter<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>                                   running_decoder<span class="op">=</span><span class="va">True</span>).to_fp16()</span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>learn_r <span class="op">=</span> xmltext_classifier_learner(dls_clas_r, AWD_LSTM, drop_mult<span class="op">=</span><span class="fl">0.1</span>, max_len<span class="op">=</span><span class="va">None</span>,<span class="co">#72*40, </span></span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a>                                     metrics<span class="op">=</span>partial(precision_at_k, k<span class="op">=</span><span class="dv">15</span>), path<span class="op">=</span>tmp, cbs<span class="op">=</span>cbs_r,</span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a>                                     pretrained<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>                                     splitter<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>                                     running_decoder<span class="op">=</span><span class="va">True</span>).to_fp16()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="co"># for i,g in enumerate(awd_lstm_xclas_split(learn.model)):</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print(f"group: {i}, {g=}")</span></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print("****")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note: Don’t forget to check k in inattention</p>
<p>A few customizations into fastai’s callbacks:</p>
<p>To tracks metrics on training bactches during an epoch:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tell `Recorder` to track `train_metrics`</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> learn.cbs[<span class="dv">1</span>].__class__ <span class="kw">is</span> Recorder</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a><span class="bu">setattr</span>(learn.cbs[<span class="dv">1</span>], <span class="st">'train_metrics'</span>, <span class="va">True</span>)</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> learn_r.cbs[<span class="dv">1</span>].__class__ <span class="kw">is</span> Recorder</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a><span class="bu">setattr</span>(learn_r.cbs[<span class="dv">1</span>], <span class="st">'train_metrics'</span>, <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> copy</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>mets <span class="op">=</span> copy.deepcopy(learn.recorder._valid_mets)</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a><span class="co"># mets = L(AvgSmoothLoss(), AvgMetric(precision_at_k))</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>rv <span class="op">=</span> RunvalCallback(mets)</span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>learn.add_cbs(rv)</span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>learn.cbs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(#9) [TrainEvalCallback,Recorder,CastToTensor,ProgressCallback,SaveModelCallback,ModelResetter,RNNCallback,MixedPrecision,RunvalCallback]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> after_batch(<span class="va">self</span>: ProgressCallback):</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pbar.update(<span class="va">self</span>.<span class="bu">iter</span><span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>        mets <span class="op">=</span> (<span class="st">'_valid_mets'</span>, <span class="st">'_train_mets'</span>)[<span class="va">self</span>.training]</span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pbar.comment <span class="op">=</span> <span class="st">' '</span>.join([<span class="ss">f'</span><span class="sc">{</span>met<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> = </span><span class="sc">{</span>met<span class="sc">.</span>value<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss">'</span> <span class="cf">for</span> met <span class="kw">in</span> <span class="bu">getattr</span>(<span class="va">self</span>.recorder, mets)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The following line essentially captures the magic of <a href="https://arxiv.org/pdf/1801.06146.pdf">ULMFit’s</a> transfer learning:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> learn.load_encoder(<span class="st">'mimic3-9k_lm_finetuned'</span>)</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>learn_r <span class="op">=</span> learn_r.load_encoder(<span class="st">'mimic3-9k_lm_finetuned_r'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="co"># learn = learn.load_brain('mimic3-9k_tok_lbl_info', 'p_L')</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a><span class="co"># learn_r = learn_r.load_brain('mimic3-9k_tok_lbl_info')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>sv_idx <span class="op">=</span> learn.cbs.attrgot(<span class="st">'__class__'</span>).index(SaveModelCallback)</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>learn.cbs[sv_idx]</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> learn.removed_cbs(learn.cbs[sv_idx]):</span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>    learn.fit(<span class="dv">1</span>, lr<span class="op">=</span><span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.012547</td>
<td>0.403337</td>
<td>0.013126</td>
<td>0.470087</td>
<td>41:55</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="co"># os.getpid()</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.fit(3, lr=3e-2)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="2" class="" max="3" style="width:300px; height:20px; vertical-align: middle;"></progress>
      66.67% [2/3 40:17&lt;20:08]
    </div>
    

<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.010768</td>
<td>0.434745</td>
<td>0.011315</td>
<td>0.491044</td>
<td>20:15</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.010263</td>
<td>0.465117</td>
<td>0.011162</td>
<td>0.494939</td>
<td>20:01</td>
</tr>
</tbody>
</table>
<p>

    </p><div>
      <progress value="108" class="" max="3084" style="width:300px; height:20px; vertical-align: middle;"></progress>
      3.50% [108/3084 00:40&lt;18:25 avg_smooth_loss = 0.010285338386893272 precision_at_k = 0.46471962616822415 ]
    </div>
    
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 0 with valid_precision_at_k value: 0.4910438908659549.
Better model found at epoch 1 with valid_precision_at_k value: 0.4949387109529458.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> learn.load((learn.path<span class="op">/</span>learn.model_dir)<span class="op">/</span>fname)</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>validate(learn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="co"># os.getpid()</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a><span class="co"># sorted(learn.cbs.zipwith(learn.cbs.attrgot('order')), key=lambda tup: tup[1] )</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<div class="cell">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> _FakeLearner: </span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> to_detach(<span class="va">self</span>,b,cpu<span class="op">=</span><span class="va">True</span>,gather<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> to_detach(b,cpu,gather)</span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>_fake_l <span class="op">=</span> _FakeLearner()</span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cpupy(t): <span class="cf">return</span> t.cpu().numpy() <span class="cf">if</span> <span class="bu">isinstance</span>(t, Tensor) <span class="cf">else</span> t</span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a>learn.model <span class="op">=</span> learn.model.to(<span class="st">'cuda:0'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>TODO: - Also print avg text lengths</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import copy</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="co"># mets = L(AvgLoss(), AvgMetric(partial(precision_at_k, k=15)))</span></span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>mets <span class="op">=</span> L(F1ScoreMulti(thresh<span class="op">=</span><span class="fl">0.14</span>, average<span class="op">=</span><span class="st">'macro'</span>), F1ScoreMulti(thresh<span class="op">=</span><span class="fl">0.14</span>, average<span class="op">=</span><span class="st">'micro'</span>))  <span class="co">#(learn.recorder._valid_mets)</span></span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>learn.model.<span class="bu">eval</span>()</span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>mets.<span class="bu">map</span>(Self.reset())</span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>pbar <span class="op">=</span> progress_bar(learn.dls.valid)</span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>log_file <span class="op">=</span> join_path_file(<span class="st">'log'</span>, learn.path<span class="op">/</span>learn.model_dir, ext<span class="op">=</span><span class="st">'.csv'</span>)</span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(log_file, <span class="st">'w'</span>, newline<span class="op">=</span><span class="st">''</span>) <span class="im">as</span> csvfile:</span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a>    writer <span class="op">=</span> csv.writer(csvfile)</span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a>    header <span class="op">=</span> mets.attrgot(<span class="st">'name'</span>) <span class="op">+</span> L(<span class="st">'bs'</span>, <span class="st">'n_lbs'</span>, <span class="st">'mean_nlbs'</span>)</span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a>    writer.writerow(header)</span>
<span id="cb149-12"><a href="#cb149-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, (xb, yb) <span class="kw">in</span> <span class="bu">enumerate</span>(pbar):</span>
<span id="cb149-13"><a href="#cb149-13" aria-hidden="true" tabindex="-1"></a>        _fake_l.yb <span class="op">=</span> (yb,)</span>
<span id="cb149-14"><a href="#cb149-14" aria-hidden="true" tabindex="-1"></a>        _fake_l.y <span class="op">=</span> yb</span>
<span id="cb149-15"><a href="#cb149-15" aria-hidden="true" tabindex="-1"></a>        _fake_l.pred, <span class="op">*</span>_ <span class="op">=</span> learn.model(xb) </span>
<span id="cb149-16"><a href="#cb149-16" aria-hidden="true" tabindex="-1"></a>        _fake_l.loss <span class="op">=</span> Tensor(learn.loss_func(_fake_l.pred, yb))</span>
<span id="cb149-17"><a href="#cb149-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> met <span class="kw">in</span> mets: met.accumulate(_fake_l)</span>
<span id="cb149-18"><a href="#cb149-18" aria-hidden="true" tabindex="-1"></a>        pbar.comment <span class="op">=</span> <span class="st">' '</span>.join(mets.attrgot(<span class="st">'value'</span>).<span class="bu">map</span>(<span class="bu">str</span>))</span>
<span id="cb149-19"><a href="#cb149-19" aria-hidden="true" tabindex="-1"></a>        yb_nlbs <span class="op">=</span>  Tensor(yb.count_nonzero(dim<span class="op">=</span><span class="dv">1</span>)).<span class="bu">float</span>().cpu().numpy()</span>
<span id="cb149-20"><a href="#cb149-20" aria-hidden="true" tabindex="-1"></a>        writer.writerow(mets.attrgot(<span class="st">'value'</span>).<span class="bu">map</span>(cpupy) <span class="op">+</span> L(find_bs(yb), yb_nlbs, yb_nlbs.mean()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.max_rows'</span>, <span class="dv">100</span>)</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(log_file)</span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.model[1].label_bias.data.min(),  learn.model[1].label_bias.data.max()</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a><span class="co"># nn.init.kaiming_normal_(learn.model[1].label_bias.data.unsqueeze(-1))</span></span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a><span class="co"># # init_default??</span></span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a><span class="co"># with torch.no_grad(): </span></span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># learn.model[1].label_bias.data = learn.lbsbias</span></span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.model[1].label_bias.data.min(),  learn.model[1].label_bias.data.max()</span></span>
<span id="cb151-7"><a href="#cb151-7" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.model[1].pay_attn.attn.func.f#, learn_r.model[1].pay_attn.attn.func.f</span></span>
<span id="cb151-8"><a href="#cb151-8" aria-hidden="true" tabindex="-1"></a><span class="co"># set_seed(1, reproducible=True)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="dev-ignore" class="level2">
<h2 class="anchored" data-anchor-id="dev-ignore">Dev (Ignore)</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>df_des <span class="op">=</span> pd.read_csv(source<span class="op">/</span><span class="st">'code_descriptions.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> learn.load_brain(<span class="st">'mimic3-9k_tok_lbl_info'</span>)</span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>learn.brain.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Performing brainsplant...
Successfull!</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([57376, 1271])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>L(learn.dls.vocab[<span class="dv">0</span>]), L(learn.dls.vocab[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>((#57376) ['xxunk','xxpad','xxbos','xxeos','xxfld','xxrep','xxwrep','xxup','xxmaj','the'...],
 (#1271) ['431','507.0','518.81','112.0','287.4','401.9','427.89','600.00','272.4','300.4'...])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>rnd_code <span class="op">=</span> <span class="st">'733.00'</span> <span class="co">#random.choice(learn.dls.vocab[1]) # '96.04'</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>des <span class="op">=</span> load_pickle(join_path_file(<span class="st">'code_desc'</span>, source, ext<span class="op">=</span><span class="st">'.pkl'</span>))</span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>k<span class="op">=</span><span class="dv">20</span></span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>idx, <span class="op">*</span>_ <span class="op">=</span> dls_clas.vocab[<span class="dv">1</span>].map_objs([rnd_code])</span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"For the icd code </span><span class="sc">{</span>rnd_code<span class="sc">}</span><span class="ss"> which means </span><span class="sc">{</span>des[rnd_code]<span class="sc">}</span><span class="ss">, the top </span><span class="sc">{</span>k<span class="sc">}</span><span class="ss"> tokens in the brain are:"</span>)</span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join(L(array(learn.dls.vocab[<span class="dv">0</span>])[learn.brain[:, idx].topk(k<span class="op">=</span>k).indices.cpu()], use_list<span class="op">=</span><span class="va">True</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>For the icd code 733.00 which means Osteoporosis, unspecified, the top 20 tokens in the brain are:
osteoporosis
fosamax
alendronate
d3
carbonate
cholecalciferol
70
osteoperosis
actonel
she
her
he
his
vitamin
risedronate
qweek
compression
raloxifene
ms
male</code></pre>
</div>
</div>
<p>Let’s pull out a text from the batch and take a look at the text and its codes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>xb, yb <span class="op">=</span> dls_clas.one_batch()</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>i <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> <span class="st">' '</span>.join([dls_clas.vocab[<span class="dv">0</span>][o] <span class="cf">for</span> o <span class="kw">in</span> xb[<span class="dv">3</span>] <span class="cf">if</span> o <span class="op">!=</span><span class="dv">1</span>])</span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>codes <span class="op">=</span> dls_clas.tfms[<span class="dv">1</span>].decode(yb[<span class="dv">3</span>])</span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"The text is </span><span class="sc">{</span><span class="bu">len</span>(text)<span class="sc">}</span><span class="ss"> words long and has </span><span class="sc">{</span><span class="bu">len</span>(codes)<span class="sc">}</span><span class="ss"> codes"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The text is 25411 words long and has 36 codes</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>df_codes <span class="op">=</span> pd.DataFrame(columns<span class="op">=</span>[<span class="st">'code'</span>, <span class="st">'description'</span>, <span class="st">'freq'</span>, <span class="st">'top_toks'</span>])</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>df_codes[<span class="st">'code'</span>] <span class="op">=</span> codes</span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>df_codes[<span class="st">'description'</span>] <span class="op">=</span> mapt(des.get, codes)</span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a>df_codes[<span class="st">'freq'</span>] <span class="op">=</span> mapt(lbl_freqs.get, codes)</span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>idxs <span class="op">=</span> learn.dls.vocab[<span class="dv">1</span>].map_objs(codes)</span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a>top_toks <span class="op">=</span> array(learn.dls.vocab[<span class="dv">0</span>])[learn.brain[:, idxs].topk(k<span class="op">=</span>k, dim<span class="op">=</span><span class="dv">0</span>).indices.cpu()].T</span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a>top_vals <span class="op">=</span> learn.brain[:, idxs].topk(k<span class="op">=</span>k, dim<span class="op">=</span><span class="dv">0</span>).values.cpu().T</span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a>df_codes[<span class="st">'top_toks'</span>] <span class="op">=</span> L(top_toks, use_list<span class="op">=</span><span class="va">True</span>).<span class="bu">map</span>(<span class="bu">list</span>)</span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a>df_codes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">code</th>
<th data-quarto-table-cell-role="th">description</th>
<th data-quarto-table-cell-role="th">freq</th>
<th data-quarto-table-cell-role="th">top_toks</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>507.0</td>
<td>Pneumonitis due to inhalation of food or vomitus</td>
<td>15</td>
<td>[aspiration, pneumonia, pneumonitis, pna, flagyl, swallow, peg, sputum, intubation, secretions, levofloxacin, aspirated, suctioning, video, hypoxic, opacities, tube, zosyn, hypoxia, vancomycin]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>518.81</td>
<td>Acute respiratory failure</td>
<td>42</td>
<td>[intubation, intubated, peep, failure, respiratory, fio2, hypoxic, extubation, sputum, pneumonia, sedated, abg, endotracheal, hypercarbic, expired, vent, hypoxia, pco2, aspiration, vancomycin]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>96.04</td>
<td>Insertion of endotracheal tube</td>
<td>48</td>
<td>[intubated, intubation, extubation, surfactant, extubated, endotracheal, respiratory, peep, sedated, airway, ventilator, ventilation, protection, fio2, reintubated, tube, expired, vent, feeds, et]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>96.72</td>
<td>Continuous mechanical ventilation for 96 consecutive hours or more</td>
<td>35</td>
<td>[intubated, tracheostomy, ventilator, trach, vent, intubation, tube, sputum, peg, peep, extubation, ventilation, wean, feeds, secretions, bal, sedated, weaning, fio2, reintubated]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>99.15</td>
<td>Parenteral infusion of concentrated nutritional substances</td>
<td>22</td>
<td>[tpn, nutrition, parenteral, prematurity, phototherapy, feeds, hyperbilirubinemia, immunizations, preterm, circumference, enteral, newborn, pediatrician, infant, caffeine, prenatal, infants, rubella, surfactant, percentile]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>38.93</td>
<td>Venous catheterization, not elsewhere classified</td>
<td>77</td>
<td>[picc, line, vancomycin, central, zosyn, cultures, grew, placement, flagyl, vanco, tpn, septic, recon, placed, flush, levophed, bacteremia, intubated, ij, soln]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>785.52</td>
<td>Septic shock</td>
<td>17</td>
<td>[septic, shock, levophed, pressors, sepsis, hypotension, zosyn, vasopressin, hypotensive, myelos, meropenem, broad, metas, atyps, expired, pressor, spectrum, urosepsis, vancomycin, vanc]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>995.92</td>
<td>Severe sepsis</td>
<td>23</td>
<td>[septic, shock, sepsis, levophed, pressors, hypotension, zosyn, meropenem, expired, vancomycin, myelos, metas, atyps, vanco, bacteremia, vanc, broad, hypotensive, cefepime, spectrum]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>518.0</td>
<td>Pulmonary collapse</td>
<td>9</td>
<td>[collapse, atelectasis, bronchoscopy, bronchus, plugging, plug, lobe, collapsed, bronch, pleural, secretions, spirometry, thoracentesis, incentive, newborn, rubella, infant, immunizations, hemithorax, pediatrician]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>584.9</td>
<td>Acute renal failure, unspecified</td>
<td>49</td>
<td>[renal, arf, failure, cr, prerenal, baseline, creatinine, kidney, medicine, acute, likely, setting, elevated, held, urine, cxr, ed, infant, chf, improved]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>799.02</td>
<td>Hypoxemia</td>
<td>8</td>
<td>[hypoxia, hypoxemia, hypoxic, nrb, cxr, medquist36, invasive, 4l, major, attending, job, brief, medicine, chief, dictated, complaint, 6l, legionella, probnp, procedure]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>427.31</td>
<td>Atrial fibrillation</td>
<td>56</td>
<td>[fibrillation, atrial, afib, amiodarone, coumadin, rvr, fib, warfarin, digoxin, irregular, irregularly, diltiazem, converted, cardioversion, af, anticoagulation, paroxysmal, metoprolol, paf, irreg]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>599.0</td>
<td>Urinary tract infection, site not specified</td>
<td>33</td>
<td>[uti, tract, urinary, nitrofurantoin, coli, ciprofloxacin, urosepsis, urine, sensitivities, ua, tobramycin, organisms, sulbactam, sensitive, meropenem, infection, mic, cipro, ceftazidime, piperacillin]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>285.9</td>
<td>Anemia, unspecified</td>
<td>32</td>
<td>[anemia, newborn, infant, immunizations, rubella, pediatrician, prenatal, circumference, allergies, phototherapy, prematurity, gestation, normocytic, seat, medical, infants, medquist36, invasive, nonreactive, apgars]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>486</td>
<td>Pneumonia, organism unspecified</td>
<td>25</td>
<td>[pneumonia, acquired, pna, levofloxacin, azithromycin, legionella, community, sputum, lobe, infiltrate, opacity, consolidation, productive, rll, opacities, cxr, multifocal, hcap, ceftriaxone, vancomycin]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>038.42</td>
<td>Septicemia due to escherichia coli [E. coli]</td>
<td>6</td>
<td>[coli, escherichia, urosepsis, sulbactam, ecoli, tazo, gnr, tobramycin, septicemia, pyelonephritis, cefazolin, piperacillin, cefuroxime, ceftazidime, interpretative, meropenem, bacteremia, sensitivities, mic, 57]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>733.00</td>
<td>Osteoporosis, unspecified</td>
<td>20</td>
<td>[osteoporosis, fosamax, alendronate, d3, carbonate, cholecalciferol, 70, osteoperosis, actonel, she, her, he, his, vitamin, risedronate, qweek, compression, raloxifene, ms, male]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>591</td>
<td>Hydronephrosis</td>
<td>3</td>
<td>[nephrostomy, ureter, ureteral, hydroureter, hydronephrosis, urology, hydroureteronephrosis, obstructing, pyelonephritis, uropathy, collecting, nephrostogram, urosepsis, upj, ureteropelvic, calculus, perinephric, uvj, stone, hydro]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>276.1</td>
<td>Hyposmolality and/or hyponatremia</td>
<td>17</td>
<td>[hyponatremia, hyponatremic, osmolal, hypovolemic, siadh, restriction, paracentesis, hypervolemic, ascites, cirrhosis, rifaximin, spironolactone, meld, ns, portal, icteric, likely, medicine, encephalopathy, hypovolemia]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>560.1</td>
<td>Paralytic ileus</td>
<td>5</td>
<td>[ileus, kub, loops, flatus, tpn, ngt, distension, illeus, obstruction, sbo, exploratory, laparotomy, clears, decompression, distention, sips, adhesions, npo, ng, passing]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>E849.7</td>
<td>Accidents occurring in residential institution</td>
<td>9</td>
<td>[major, medquist36, attending, brief, invasive, job, surgical, procedure, chief, complaint, diagnosis, instructions, followup, pertinent, allergies, 8cm2, daily, dictated, disposition, results]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21</td>
<td>E870.8</td>
<td>Accidental cut, puncture, perforation or hemorrhage during other specified medical care</td>
<td>3</td>
<td>[recannulate, suboptimald, whistle, trickle, insom, tumeric, erythematosis, advertisement, choledochotomy, disaese, xfusions, ameniable, patrial, intrasinus, reproduceable, adamsts, valgan, interscalene, duodenorrhaphy, strattice]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22</td>
<td>788.30</td>
<td>Urinary incontinence, unspecified</td>
<td>2</td>
<td>[incontinence, incontinent, detrol, oxybutynin, urinary, aledronate, incontinance, tolterodine, t34, vesicare, condom, tenders, urinal, thyrodectomy, arthritides, urge, solifenacin, hospitalize, oxybutinin, sparc]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">23</td>
<td>562.10</td>
<td>Diverticulosis of colon (without mention of hemorrhage)</td>
<td>4</td>
<td>[diverticulosis, sigmoid, cecum, diverticulitis, colonoscopy, diverticula, diverticular, hemorrhoids, diverticuli, polypectomy, colon, colonic, polyp, prep, colonscopy, tagged, lgib, maroon, brbpr, polyps]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>E879.6</td>
<td>Urinary catheterization as the cause of abnormal reaction of patient, or of later complication, without mention of misadventure at time of procedure</td>
<td>2</td>
<td>[indwelling, urethra, insufficicency, hyposensitive, nonambulating, urology, methenamine, suprapubic, fosfomycin, neurogenic, utis, mirabilis, sporogenes, mdr, pyuria, urologist, urosepsis, policeman, uti, vse]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25</td>
<td>401.1</td>
<td>Benign essential hypertension</td>
<td>4</td>
<td>[diarhea, medquist36, job, feline, ronchi, osteosclerotic, invasive, major, attending, septicemia, brief, dictated, benzodiazepene, unprovoked, caox3, rhinorrhea, metbolic, lak, lext, procedure]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">26</td>
<td>250.22</td>
<td>Diabetes mellitustype II [non-insulin dependent type] [NIDDM type] [adult-onset type] or unspecified type with hyperosmolarity, uncontrolled</td>
<td>2</td>
<td>[hyperosmolar, nonketotic, hhs, hhnk, ketotic, hyperosmotic, honk, honc, hyperglycemic, flatbush, sniffs, pelvocaliectasis, pseudohyponatremia, ha1c, furosemdie, 25gx1, nistatin, hypersomolar, 05u, guaaic]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">27</td>
<td>345.80</td>
<td>Other forms of epilepsy, without mention of intractable epilepsy</td>
<td>1</td>
<td>[forefinger, indentified, emu, overshunting, midac, gliosarcoma, foscarnate, signifcantly, mirroring, jamacia, 4tab, t34, fibrinolytic, 3tab, majestic, persecutory, uncomfirmed, polyspike, seperated, hoffmans]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">28</td>
<td>996.76</td>
<td>Other complications due to genitourinary device, implant, and graft</td>
<td>1</td>
<td>[paraphrasias, reinstuted, tonics, qoday, choreoathetosis, infilterates, extravesical, acetoacetate, uteral, hematuric, patell, clipboard, peform, cytomorphology, pirbuterol, athetosis, suborbital, axon, stumbles, summetric]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">29</td>
<td>560.39</td>
<td>Other impaction of intestine</td>
<td>1</td>
<td>[disimpaction, disimpacted, impaction, disimpact, suds, disempacted, cathartics, biscodyl, mebaral, enemas, divigel, addisonian, colocolostomy, fecal, manually, ileosigmoid, obstipation, periappendiceal, somatropin, liquied]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">30</td>
<td>550.10</td>
<td>Unilateral or unspecified inguinal hernia with obstruction, without mention of gangrene (not specified as recurrent)</td>
<td>1</td>
<td>[dwarfism, toilets, irreducible, nonreducible, intenal, diseection, reduceable, purp, lee, cerfactin, extravesical, stimata, hemiscrotal, pleuraleffusions, diversions, desireable, incarcerated, bogata, txplnt, plce]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">31</td>
<td>595.9</td>
<td>Cystitis, unspecified</td>
<td>1</td>
<td>[bulsulfan, trabeculae, cystitis, heliotrope, roscea, ileous, intertitial, 66yrs, extravesical, dentention, cephalasporin, thyrodectomy, rangin, musculotendinous, valcade, postcricoid, replacemet, pericystic, pyocystitis, cylosporine]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">32</td>
<td>319</td>
<td>Unspecified mental retardation</td>
<td>1</td>
<td>[retardation, zonegran, hemispherectomy, gastaut, guardian, retarded, zonisamide, epilepsy, phenoba, hypoid, mentral, epileptologist, phenobarbital, valproic, crichoid, neurodermatitis, stimulator, aeds, tracheobroncomalacia, developmental]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">33</td>
<td>542</td>
<td>Other appendicitis</td>
<td>1</td>
<td>[atmospheric, vioptics, comedo, apriso, extravesical, revisional, osteoporsis, plce, resuscited, retrocecal, improvemed, impre, tubule, periappendiceal, castor, paratubal, nebullizer, pleomorphism, feamle, mebaral]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">34</td>
<td>596.8</td>
<td>Other specified disorders of bladder</td>
<td>1</td>
<td>[presbylaryngis, spout, urothelial, satellitosis, anascarca, melanophages, hemartoma, amplicillin, refexes, glassess, hypogammaglobulinemic, senstitve, pseuduomonas, deificts, chux, superpubic, adenoviremia, curator, valvulopathies, tristar]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">35</td>
<td>87.77</td>
<td>Other cystogram</td>
<td>1</td>
<td>[cystogram, hematurea, pupuric, movmement, pyocystitis, malencot, subperitoneal, mlc, divericuli, ould, hepaticojej, bilatearally, elluting, extravesical, remmained, replacemet, fluzone, ureterotomy, fulgaration, q3hour]</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join(L(<span class="bu">zip</span>(top_toks[<span class="dv">16</span>], top_vals[<span class="dv">16</span>])).<span class="bu">map</span>(<span class="bu">str</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>('osteoporosis', tensor(0.3675))
('fosamax', tensor(0.0482))
('alendronate', tensor(0.0479))
('d3', tensor(0.0223))
('carbonate', tensor(0.0183))
('cholecalciferol', tensor(0.0181))
('70', tensor(0.0147))
('osteoperosis', tensor(0.0137))
('actonel', tensor(0.0132))
('she', tensor(0.0128))
('her', tensor(0.0127))
('he', tensor(0.0109))
('his', tensor(0.0095))
('vitamin', tensor(0.0092))
('risedronate', tensor(0.0078))
('qweek', tensor(0.0077))
('compression', tensor(0.0076))
('raloxifene', tensor(0.0070))
('ms', tensor(0.0069))
('male', tensor(0.0067))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>tok_list <span class="op">=</span> top_toks[<span class="dv">16</span>]</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>L(tok <span class="cf">for</span> tok <span class="kw">in</span> tok_list <span class="cf">if</span> tok <span class="kw">in</span> text.split())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(#5) ['osteoporosis','he','his','vitamin','male']</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>pattern <span class="op">=</span> <span class="vs">r'\b(</span><span class="sc">{0}</span><span class="vs">)\b'</span>.<span class="bu">format</span>(<span class="st">'|'</span>.join(<span class="bu">list</span>(tok_list)))</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>pattern <span class="op">=</span> re.<span class="bu">compile</span>(pattern)</span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i,match <span class="kw">in</span> <span class="bu">enumerate</span>(pattern.finditer(text)):</span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(i, match.group())</span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="bu">len</span>(match.group()))</span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(text[match.start()<span class="op">-</span><span class="dv">100</span>: match.end()<span class="op">+</span><span class="dv">100</span>], end<span class="op">=</span><span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0 diabetes
--------
vement in numbers no episodes of bleeding dic labs negative he subsequent had platelets in 60s 100s diabetes the patient was placed on ssi in house and lantus due to persistent hypoglycemia in the morning he 

1 insulin
-------
mnia oxycodone mg tablet sig one tablet po q6h every hours as needed for pain disp tablet s refills insulin glargine unit ml solution sig twelve units subcutaneous at bedtime heparin flush units ml ml iv prn

2 diabetes
--------
 failure atrial fibrillation with rapid ventricular response portal gastropathy secondary cirrhosis diabetes mellitus discharge condition mental status clear and coherent level of consciousness alert and inte

3 mellitus
--------
atrial fibrillation with rapid ventricular response portal gastropathy secondary cirrhosis diabetes mellitus discharge condition mental status clear and coherent level of consciousness alert and interactive a
</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>tst_model <span class="op">=</span> get_xmltext_classifier2(AWD_LSTM, <span class="dv">60000</span>, <span class="dv">1271</span>, seq_len<span class="op">=</span><span class="dv">72</span>, config<span class="op">=</span>awd_lstm_clas_config, </span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>                               drop_mult<span class="op">=</span><span class="fl">0.1</span>, max_len<span class="op">=</span><span class="dv">72</span><span class="op">*</span><span class="dv">40</span>).to(default_device())</span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>xb, yb <span class="op">=</span> dls_clas.one_batch()</span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>L(xb, yb).<span class="bu">map</span>(<span class="kw">lambda</span> o: (o.shape, o.device))</span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a>sent_enc <span class="op">=</span> learn.model[<span class="dv">0</span>].to(default_device())</span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a>attn_clas <span class="op">=</span> learn.model[<span class="dv">1</span>].to(default_device())</span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-11"><a href="#cb169-11" aria-hidden="true" tabindex="-1"></a>preds_by_sent_enc, mask <span class="op">=</span> sent_enc(xb)</span>
<span id="cb169-12"><a href="#cb169-12" aria-hidden="true" tabindex="-1"></a>preds_by_sent_enc.shape, mask.shape</span>
<span id="cb169-13"><a href="#cb169-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-14"><a href="#cb169-14" aria-hidden="true" tabindex="-1"></a>o <span class="op">=</span> tst_model(xb)</span>
<span id="cb169-15"><a href="#cb169-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-16"><a href="#cb169-16" aria-hidden="true" tabindex="-1"></a>o[<span class="dv">0</span>].shape</span>
<span id="cb169-17"><a href="#cb169-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-18"><a href="#cb169-18" aria-hidden="true" tabindex="-1"></a>tst_model[<span class="dv">1</span>].hl.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fine-tuning-the-classifier" class="level2">
<h2 class="anchored" data-anchor-id="fine-tuning-the-classifier">Fine-Tuning the Classifier</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">2</span>, lr<span class="op">=</span><span class="fl">3e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.006671</td>
<td>0.427560</td>
<td>0.007373</td>
<td>0.501760</td>
<td>18:52</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.006010</td>
<td>0.486638</td>
<td>0.007033</td>
<td>0.518841</td>
<td>19:13</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">9</span>, lr<span class="op">=</span><span class="fl">3e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.006171</td>
<td>0.496154</td>
<td>0.006873</td>
<td>0.524792</td>
<td>19:04</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.006296</td>
<td>0.499897</td>
<td>0.006786</td>
<td>0.526097</td>
<td>19:07</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.006071</td>
<td>0.501944</td>
<td>0.006728</td>
<td>0.529656</td>
<td>21:40</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.005868</td>
<td>0.503599</td>
<td>0.006685</td>
<td>0.529261</td>
<td>19:53</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.005772</td>
<td>0.504341</td>
<td>0.006666</td>
<td>0.530565</td>
<td>18:51</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.005700</td>
<td>0.504796</td>
<td>0.006648</td>
<td>0.529201</td>
<td>19:29</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.005662</td>
<td>0.504856</td>
<td>0.006632</td>
<td>0.530625</td>
<td>18:40</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.006080</td>
<td>0.505080</td>
<td>0.006594</td>
<td>0.531870</td>
<td>19:07</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.005849</td>
<td>0.505091</td>
<td>0.006607</td>
<td>0.532543</td>
<td>18:40</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<pre><code>Path('/home/deb/xcube/nbs/tmp/models/mimic_tmp.pth')</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a>learn.freeze_to(<span class="op">-</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">10</span>, lr<span class="op">=</span><span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.004908</td>
<td>0.520075</td>
<td>0.005996</td>
<td>0.554903</td>
<td>22:30</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.005100</td>
<td>0.524777</td>
<td>0.005895</td>
<td>0.557651</td>
<td>22:42</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.004864</td>
<td>0.525998</td>
<td>0.005869</td>
<td>0.555219</td>
<td>23:00</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.004873</td>
<td>0.527586</td>
<td>0.005766</td>
<td>0.561507</td>
<td>22:30</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.004755</td>
<td>0.530503</td>
<td>0.005780</td>
<td>0.558323</td>
<td>22:37</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.004760</td>
<td>0.532162</td>
<td>0.005718</td>
<td>0.562060</td>
<td>22:37</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.004906</td>
<td>0.533651</td>
<td>0.005617</td>
<td>0.569632</td>
<td>22:28</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.004725</td>
<td>0.535399</td>
<td>0.005622</td>
<td>0.569553</td>
<td>23:41</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.004727</td>
<td>0.536854</td>
<td>0.005613</td>
<td>0.569968</td>
<td>22:40</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.004670</td>
<td>0.538211</td>
<td>0.005558</td>
<td>0.571372</td>
<td>23:04</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<pre><code>Path('/home/deb/xcube/nbs/tmp/models/mimic2_tmp.pth')</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">10</span>, lr<span class="op">=</span><span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.004632</td>
<td>0.539177</td>
<td>0.005528</td>
<td>0.571847</td>
<td>22:36</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.004653</td>
<td>0.540667</td>
<td>0.005551</td>
<td>0.568802</td>
<td>22:27</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.004833</td>
<td>0.541256</td>
<td>0.005607</td>
<td>0.566588</td>
<td>24:31</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.004460</td>
<td>0.541850</td>
<td>0.005555</td>
<td>0.573665</td>
<td>26:17</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.004692</td>
<td>0.540970</td>
<td>0.005530</td>
<td>0.570522</td>
<td>23:43</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.004859</td>
<td>0.541696</td>
<td>0.005493</td>
<td>0.574812</td>
<td>22:50</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.004495</td>
<td>0.543965</td>
<td>0.005538</td>
<td>0.570364</td>
<td>22:46</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.004517</td>
<td>0.544347</td>
<td>0.005493</td>
<td>0.572875</td>
<td>23:18</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.004755</td>
<td>0.543222</td>
<td>0.005501</td>
<td>0.572578</td>
<td>23:29</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.004687</td>
<td>0.544784</td>
<td>0.005483</td>
<td>0.571076</td>
<td>22:44</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<pre><code>Path('/home/deb/xcube/nbs/tmp/models/mimic3_tmp.pth')</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a>learn.freeze_to(<span class="op">-</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">2</span>, lr<span class="op">=</span><span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.004854</td>
<td>0.550886</td>
<td>0.005433</td>
<td>0.578094</td>
<td>1:09:40</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.004290</td>
<td>0.554642</td>
<td>0.005335</td>
<td>0.582720</td>
<td>1:13:00</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<pre><code>Path('/home/deb/xcube/nbs/tmp/models/mimic4_tmp.pth')</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a>learn.freeze_to(<span class="op">-</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">5</span>, lr<span class="op">=</span><span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.004555</td>
<td>0.558910</td>
<td>0.005358</td>
<td>0.583887</td>
<td>1:08:32</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.004249</td>
<td>0.559825</td>
<td>0.005338</td>
<td>0.582068</td>
<td>1:06:38</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.004497</td>
<td>0.557554</td>
<td>0.005273</td>
<td>0.588711</td>
<td>1:08:03</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.004690</td>
<td>0.557821</td>
<td>0.005338</td>
<td>0.582444</td>
<td>1:04:41</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.004420</td>
<td>0.559116</td>
<td>0.005297</td>
<td>0.585923</td>
<td>1:04:19</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 0 with valid_precision_at_k value: 0.5838869118228547.
Better model found at epoch 2 with valid_precision_at_k value: 0.5887109529458283.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>learn.unfreeze()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">12</span>, lr<span class="op">=</span><span class="fl">1e-6</span>, wd<span class="op">=</span><span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.004274</td>
<td>0.571029</td>
<td>0.005253</td>
<td>0.589897</td>
<td>1:22:37</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.003970</td>
<td>0.573214</td>
<td>0.005237</td>
<td>0.590826</td>
<td>1:35:24</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.003580</td>
<td>0.576061</td>
<td>0.005224</td>
<td>0.592210</td>
<td>1:28:15</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.004398</td>
<td>0.573131</td>
<td>0.005213</td>
<td>0.592764</td>
<td>1:21:15</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.004146</td>
<td>0.573926</td>
<td>0.005203</td>
<td>0.593634</td>
<td>1:21:23</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.004096</td>
<td>0.575295</td>
<td>0.005194</td>
<td>0.594227</td>
<td>1:20:27</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.004011</td>
<td>0.575432</td>
<td>0.005185</td>
<td>0.594879</td>
<td>1:20:34</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.003997</td>
<td>0.576225</td>
<td>0.005178</td>
<td>0.595789</td>
<td>1:23:31</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.003942</td>
<td>0.577274</td>
<td>0.005171</td>
<td>0.596362</td>
<td>1:21:20</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.004266</td>
<td>0.577674</td>
<td>0.005164</td>
<td>0.596659</td>
<td>1:21:25</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.004115</td>
<td>0.578049</td>
<td>0.005158</td>
<td>0.597113</td>
<td>1:21:17</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.003978</td>
<td>0.578710</td>
<td>0.005152</td>
<td>0.597232</td>
<td>1:21:51</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 0 with valid_precision_at_k value: 0.5898971925662319.
Better model found at epoch 1 with valid_precision_at_k value: 0.5908264136022148.
Better model found at epoch 2 with valid_precision_at_k value: 0.5922103598260184.
Better model found at epoch 3 with valid_precision_at_k value: 0.59276393831554.
Better model found at epoch 4 with valid_precision_at_k value: 0.5936338473705026.
Better model found at epoch 5 with valid_precision_at_k value: 0.594226967180704.
Better model found at epoch 6 with valid_precision_at_k value: 0.5948793989719259.
Better model found at epoch 7 with valid_precision_at_k value: 0.5957888493475683.
Better model found at epoch 8 with valid_precision_at_k value: 0.59636219849743.
Better model found at epoch 9 with valid_precision_at_k value: 0.5966587584025307.
Better model found at epoch 10 with valid_precision_at_k value: 0.5971134835903521.
Better model found at epoch 11 with valid_precision_at_k value: 0.5972321075523922.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">12</span>, lr<span class="op">=</span><span class="fl">1e-6</span>, wd<span class="op">=</span><span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.004173</td>
<td>0.580595</td>
<td>0.005147</td>
<td>0.597628</td>
<td>1:27:59</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.003887</td>
<td>0.581874</td>
<td>0.005142</td>
<td>0.598082</td>
<td>1:26:58</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.003538</td>
<td>0.584128</td>
<td>0.005137</td>
<td>0.598280</td>
<td>1:25:40</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.004319</td>
<td>0.580220</td>
<td>0.005133</td>
<td>0.598557</td>
<td>1:22:04</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.004077</td>
<td>0.580681</td>
<td>0.005128</td>
<td>0.598754</td>
<td>1:29:05</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.004035</td>
<td>0.581153</td>
<td>0.005124</td>
<td>0.599229</td>
<td>1:23:48</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.003955</td>
<td>0.581074</td>
<td>0.005120</td>
<td>0.599644</td>
<td>1:27:02</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.003943</td>
<td>0.581586</td>
<td>0.005117</td>
<td>0.599960</td>
<td>1:25:09</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.003891</td>
<td>0.582050</td>
<td>0.005113</td>
<td>0.600138</td>
<td>1:25:04</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.004217</td>
<td>0.582461</td>
<td>0.005110</td>
<td>0.600178</td>
<td>1:32:48</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.004067</td>
<td>0.582578</td>
<td>0.005106</td>
<td>0.600811</td>
<td>1:34:01</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.003936</td>
<td>0.583004</td>
<td>0.005103</td>
<td>0.601008</td>
<td>1:27:10</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 0 with valid_precision_at_k value: 0.5976275207591935.
Better model found at epoch 1 with valid_precision_at_k value: 0.5980822459470149.
Better model found at epoch 2 with valid_precision_at_k value: 0.5982799525504153.
Better model found at epoch 3 with valid_precision_at_k value: 0.5985567417951758.
Better model found at epoch 4 with valid_precision_at_k value: 0.5987544483985765.
Better model found at epoch 5 with valid_precision_at_k value: 0.5992289442467379.
Better model found at epoch 6 with valid_precision_at_k value: 0.5996441281138793.
Better model found at epoch 7 with valid_precision_at_k value: 0.5999604586793202.
Better model found at epoch 8 with valid_precision_at_k value: 0.6001383946223807.
Better model found at epoch 9 with valid_precision_at_k value: 0.6001779359430608.
Better model found at epoch 10 with valid_precision_at_k value: 0.6008105970739425.
Better model found at epoch 11 with valid_precision_at_k value: 0.601008303677343.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">12</span>, lr<span class="op">=</span><span class="fl">1e-6</span>, wd<span class="op">=</span><span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.004131</td>
<td>0.584655</td>
<td>0.005100</td>
<td>0.601364</td>
<td>1:27:13</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.003851</td>
<td>0.585673</td>
<td>0.005098</td>
<td>0.601522</td>
<td>1:27:38</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.003534</td>
<td>0.587853</td>
<td>0.005095</td>
<td>0.601839</td>
<td>1:27:55</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.004281</td>
<td>0.583691</td>
<td>0.005092</td>
<td>0.602096</td>
<td>1:26:51</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.004044</td>
<td>0.584044</td>
<td>0.005090</td>
<td>0.602135</td>
<td>1:23:44</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.004004</td>
<td>0.584326</td>
<td>0.005088</td>
<td>0.602550</td>
<td>1:25:08</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.003927</td>
<td>0.584212</td>
<td>0.005085</td>
<td>0.602669</td>
<td>1:28:46</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.003916</td>
<td>0.584371</td>
<td>0.005083</td>
<td>0.602748</td>
<td>1:35:59</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.003863</td>
<td>0.584690</td>
<td>0.005081</td>
<td>0.603005</td>
<td>1:32:43</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.004190</td>
<td>0.585073</td>
<td>0.005079</td>
<td>0.603203</td>
<td>1:35:33</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.004041</td>
<td>0.584967</td>
<td>0.005077</td>
<td>0.603401</td>
<td>1:27:33</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.003914</td>
<td>0.585363</td>
<td>0.005075</td>
<td>0.603816</td>
<td>1:29:02</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 0 with valid_precision_at_k value: 0.601364175563464.
Better model found at epoch 1 with valid_precision_at_k value: 0.6015223408461846.
Better model found at epoch 2 with valid_precision_at_k value: 0.6018386714116253.
Better model found at epoch 3 with valid_precision_at_k value: 0.6020956899960457.
Better model found at epoch 4 with valid_precision_at_k value: 0.6021352313167257.
Better model found at epoch 5 with valid_precision_at_k value: 0.6025504151838669.
Better model found at epoch 6 with valid_precision_at_k value: 0.6026690391459072.
Better model found at epoch 7 with valid_precision_at_k value: 0.6027481217872676.
Better model found at epoch 8 with valid_precision_at_k value: 0.6030051403716885.
Better model found at epoch 9 with valid_precision_at_k value: 0.603202846975089.
Better model found at epoch 10 with valid_precision_at_k value: 0.6034005535784894.
Better model found at epoch 11 with valid_precision_at_k value: 0.6038157374456307.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">17</span>, lr<span class="op">=</span><span class="fl">1e-6</span>, wd<span class="op">=</span><span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.004109</td>
<td>0.586924</td>
<td>0.005073</td>
<td>0.603934</td>
<td>1:30:05</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.003831</td>
<td>0.587917</td>
<td>0.005072</td>
<td>0.604053</td>
<td>1:27:47</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.003542</td>
<td>0.589895</td>
<td>0.005070</td>
<td>0.604013</td>
<td>1:27:51</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.004260</td>
<td>0.585822</td>
<td>0.005069</td>
<td>0.603895</td>
<td>1:28:24</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.004025</td>
<td>0.586037</td>
<td>0.005067</td>
<td>0.603855</td>
<td>1:28:43</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.003987</td>
<td>0.586026</td>
<td>0.005066</td>
<td>0.604172</td>
<td>1:27:41</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.003912</td>
<td>0.586035</td>
<td>0.005064</td>
<td>0.604290</td>
<td>1:25:56</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.003901</td>
<td>0.586076</td>
<td>0.005063</td>
<td>0.604409</td>
<td>1:27:44</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.003848</td>
<td>0.586360</td>
<td>0.005061</td>
<td>0.604389</td>
<td>1:25:51</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.004176</td>
<td>0.586516</td>
<td>0.005060</td>
<td>0.604350</td>
<td>1:25:42</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.004026</td>
<td>0.586483</td>
<td>0.005059</td>
<td>0.604369</td>
<td>1:33:33</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.003901</td>
<td>0.586768</td>
<td>0.005058</td>
<td>0.604508</td>
<td>1:24:20</td>
</tr>
<tr class="odd">
<td>12</td>
<td>0.004077</td>
<td>0.586777</td>
<td>0.005057</td>
<td>0.604745</td>
<td>1:26:26</td>
</tr>
<tr class="even">
<td>13</td>
<td>0.003919</td>
<td>0.586842</td>
<td>0.005056</td>
<td>0.604923</td>
<td>1:25:43</td>
</tr>
<tr class="odd">
<td>14</td>
<td>0.003948</td>
<td>0.586588</td>
<td>0.005055</td>
<td>0.605081</td>
<td>1:23:59</td>
</tr>
<tr class="even">
<td>15</td>
<td>0.003915</td>
<td>0.586954</td>
<td>0.005054</td>
<td>0.605042</td>
<td>1:28:20</td>
</tr>
<tr class="odd">
<td>16</td>
<td>0.003949</td>
<td>0.587083</td>
<td>0.005053</td>
<td>0.605042</td>
<td>1:32:08</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 0 with valid_precision_at_k value: 0.603934361407671.
Better model found at epoch 1 with valid_precision_at_k value: 0.6040529853697115.
Better model found at epoch 5 with valid_precision_at_k value: 0.6041716093317517.
Better model found at epoch 6 with valid_precision_at_k value: 0.6042902332937922.
Better model found at epoch 7 with valid_precision_at_k value: 0.6044088572558325.
Better model found at epoch 11 with valid_precision_at_k value: 0.6045077105575327.
Better model found at epoch 12 with valid_precision_at_k value: 0.6047449584816134.
Better model found at epoch 13 with valid_precision_at_k value: 0.6049228944246741.
Better model found at epoch 14 with valid_precision_at_k value: 0.6050810597073943.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">12</span>, lr<span class="op">=</span><span class="fl">1e-6</span>, wd<span class="op">=</span><span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.004095</td>
<td>0.588552</td>
<td>0.005054</td>
<td>0.604982</td>
<td>1:27:02</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.003819</td>
<td>0.589632</td>
<td>0.005053</td>
<td>0.605081</td>
<td>1:23:54</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.003560</td>
<td>0.591372</td>
<td>0.005052</td>
<td>0.605397</td>
<td>1:23:37</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.004247</td>
<td>0.587154</td>
<td>0.005051</td>
<td>0.605417</td>
<td>1:24:47</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.004014</td>
<td>0.587362</td>
<td>0.005050</td>
<td>0.605575</td>
<td>1:25:40</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.003976</td>
<td>0.587346</td>
<td>0.005050</td>
<td>0.605595</td>
<td>1:25:16</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.003904</td>
<td>0.587354</td>
<td>0.005049</td>
<td>0.605516</td>
<td>1:30:16</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.003893</td>
<td>0.587376</td>
<td>0.005048</td>
<td>0.605575</td>
<td>1:23:22</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.003840</td>
<td>0.587661</td>
<td>0.005048</td>
<td>0.605556</td>
<td>1:27:31</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.004168</td>
<td>0.587554</td>
<td>0.005047</td>
<td>0.605753</td>
<td>1:27:43</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.004018</td>
<td>0.587563</td>
<td>0.005046</td>
<td>0.605793</td>
<td>1:27:50</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.003895</td>
<td>0.587731</td>
<td>0.005046</td>
<td>0.605931</td>
<td>1:22:51</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 1 with valid_precision_at_k value: 0.6050810597073941.
Better model found at epoch 2 with valid_precision_at_k value: 0.6053973902728351.
Better model found at epoch 3 with valid_precision_at_k value: 0.6054171609331752.
Better model found at epoch 4 with valid_precision_at_k value: 0.6055753262158957.
Better model found at epoch 5 with valid_precision_at_k value: 0.6055950968762357.
Better model found at epoch 9 with valid_precision_at_k value: 0.6057532621589561.
Better model found at epoch 10 with valid_precision_at_k value: 0.6057928034796363.
Better model found at epoch 11 with valid_precision_at_k value: 0.6059311981020166.</code></pre>
</div>
</div>
<p>start here:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(learn.save_model.fname)</span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a>learn.save_model.reset_on_fit<span class="op">=</span><span class="va">False</span></span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="kw">not</span> learn.save_model.reset_on_fit</span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> learn.load(learn.save_model.fname)</span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a>validate(learn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>mimic3-9k_clas_full
best so far = None
[0.00504577299579978, 0.6059311981020166]
best so far = None</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>learn.save_model.best <span class="op">=</span> <span class="fl">0.605931198</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now unfreeze and train more if you want:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>learn.unfreeze()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">12</span>, lr<span class="op">=</span><span class="fl">1e-6</span>, wd<span class="op">=</span><span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.004091</td>
<td>0.589346</td>
<td>0.005045</td>
<td>0.605832</td>
<td>1:26:58</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.003816</td>
<td>0.590275</td>
<td>0.005045</td>
<td>0.605872</td>
<td>1:39:14</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.003580</td>
<td>0.591960</td>
<td>0.005044</td>
<td>0.605971</td>
<td>1:24:25</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.004243</td>
<td>0.587718</td>
<td>0.005044</td>
<td>0.606030</td>
<td>1:29:50</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.004012</td>
<td>0.587808</td>
<td>0.005044</td>
<td>0.606168</td>
<td>1:26:04</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.003974</td>
<td>0.587973</td>
<td>0.005043</td>
<td>0.606070</td>
<td>1:25:14</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.003903</td>
<td>0.587727</td>
<td>0.005043</td>
<td>0.605991</td>
<td>1:25:52</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.003892</td>
<td>0.587734</td>
<td>0.005043</td>
<td>0.606010</td>
<td>1:30:01</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.003839</td>
<td>0.588023</td>
<td>0.005042</td>
<td>0.606010</td>
<td>1:27:09</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.004167</td>
<td>0.588038</td>
<td>0.005042</td>
<td>0.606070</td>
<td>1:27:05</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.004016</td>
<td>0.587855</td>
<td>0.005042</td>
<td>0.606070</td>
<td>1:33:34</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.003895</td>
<td>0.588136</td>
<td>0.005041</td>
<td>0.606089</td>
<td>1:35:38</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 2 with valid_precision_at_k value: 0.6059707394226967.
Better model found at epoch 3 with valid_precision_at_k value: 0.6060300514037169.
Better model found at epoch 4 with valid_precision_at_k value: 0.6061684460260972.</code></pre>
</div>
</div>
<hr>
<p>The last step (yes, the madness will end soon) is to train with: - <em>discriminative learning rates</em>: define here - <em>gradual unfreezing</em>: define here</p>
<p>as defined here in <a href="https://arxiv.org/pdf/1801.06146.pdf">ULMFit</a></p>
<p>If we are using the <a href="https://debjyotiSRoy.github.io/xcube/text.callbacks.html#labelforcing"><code>LabelForcing</code></a> callback, then the loss will spike after certain number of epochs. So we need to remove this callback before doing <code>lr_find</code>. This is because <code>lr_find</code> aborts if things go south with regard to loss.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>lbl_fcr <span class="op">=</span> <span class="va">None</span></span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> suppress(<span class="pp">ValueError</span>): lbl_fcr <span class="op">=</span> learn.cbs[learn.cbs.<span class="bu">map</span>(<span class="bu">type</span>).index(LabelForcing)]</span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> learn.removed_cbs(lbl_fcr):</span>
<span id="cb201-4"><a href="#cb201-4" aria-hidden="true" tabindex="-1"></a>    lr_min, lr_steep, lr_valley, lr_slide <span class="op">=</span> learn.lr_find(suggest_funcs<span class="op">=</span>(minimum, steep, valley, slide), num_it<span class="op">=</span><span class="dv">5000</span>)</span>
<span id="cb201-5"><a href="#cb201-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>lr_min<span class="op">=</span><span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>lr_steep<span class="op">=</span><span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>lr_valley<span class="op">=</span><span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>lr_slide<span class="op">=</span><span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>lr_min=0.03156457841396332, lr_steep=6.867521165077051e-07, lr_valley=0.016935577616095543, lr_slide=9.255502700805664</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="18_tutorial.train_mimic3_files/figure-html/cell-149-output-4.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.opt.hypers.map(lambda d: d['lr'])</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb204"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a>[<span class="fl">0.14</span><span class="op">*</span>i<span class="op">/</span><span class="dv">4</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>)], [<span class="fl">0.14</span><span class="op">*</span>i <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>)],</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>([0.14, 0.10500000000000001, 0.07, 0.035],
 [0.56, 0.42000000000000004, 0.28, 0.14])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb206"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a>learn.cbs[<span class="op">-</span><span class="dv">4</span>].reset_on_fit <span class="op">=</span> <span class="va">False</span></span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(learn.cbs[<span class="op">-</span><span class="dv">4</span>].reset_on_fit)</span>
<span id="cb206-3"><a href="#cb206-3" aria-hidden="true" tabindex="-1"></a><span class="co"># for i in range(4, 0, -1):</span></span>
<span id="cb206-4"><a href="#cb206-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     learn.fit_one_cycle(1, lr_max=0.14*i, moms=(0.8,0.7,0.8), wd=0.1)</span></span>
<span id="cb206-5"><a href="#cb206-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     learn.fit_one_cycle(5, lr_max=0.14*i, moms=(0.8,0.7,0.8), wd=0.1)</span></span>
<span id="cb206-6"><a href="#cb206-6" aria-hidden="true" tabindex="-1"></a>learn.fit_sgdr(<span class="dv">4</span>, <span class="dv">1</span>, lr_max<span class="op">=</span><span class="fl">0.2</span>, wd<span class="op">=</span><span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>False
Better model found at epoch 0 with valid_precision_at_k value: 0.26.
Better model found at epoch 1 with valid_precision_at_k value: 0.3433333333333333.
Better model found at epoch 2 with valid_precision_at_k value: 0.39.
Better model found at epoch 3 with valid_precision_at_k value: 0.41000000000000003.
Better model found at epoch 4 with valid_precision_at_k value: 0.43.
Better model found at epoch 5 with valid_precision_at_k value: 0.4366666666666667.
Better model found at epoch 6 with valid_precision_at_k value: 0.44000000000000006.
Better model found at epoch 8 with valid_precision_at_k value: 0.4533333333333333.
Better model found at epoch 10 with valid_precision_at_k value: 0.4666666666666667.
Better model found at epoch 11 with valid_precision_at_k value: 0.4733333333333333.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.354789</td>
<td>0.174444</td>
<td>0.234256</td>
<td>0.260000</td>
<td>00:17</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.234948</td>
<td>0.373611</td>
<td>0.124908</td>
<td>0.343333</td>
<td>00:20</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.172152</td>
<td>0.488333</td>
<td>0.116975</td>
<td>0.390000</td>
<td>00:19</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.139922</td>
<td>0.495000</td>
<td>0.103215</td>
<td>0.410000</td>
<td>00:19</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.118237</td>
<td>0.547778</td>
<td>0.095149</td>
<td>0.430000</td>
<td>00:19</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.102651</td>
<td>0.587500</td>
<td>0.093051</td>
<td>0.436667</td>
<td>00:19</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.091334</td>
<td>0.613611</td>
<td>0.092191</td>
<td>0.440000</td>
<td>00:19</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.084536</td>
<td>0.586389</td>
<td>0.085612</td>
<td>0.440000</td>
<td>00:18</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.078545</td>
<td>0.589722</td>
<td>0.082743</td>
<td>0.453333</td>
<td>00:18</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.072898</td>
<td>0.593889</td>
<td>0.085372</td>
<td>0.420000</td>
<td>00:18</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.068474</td>
<td>0.606944</td>
<td>0.079234</td>
<td>0.466667</td>
<td>00:19</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.064556</td>
<td>0.627222</td>
<td>0.077119</td>
<td>0.473333</td>
<td>00:20</td>
</tr>
<tr class="odd">
<td>12</td>
<td>0.060896</td>
<td>0.641389</td>
<td>0.076804</td>
<td>0.453333</td>
<td>00:19</td>
</tr>
<tr class="even">
<td>13</td>
<td>0.058002</td>
<td>0.651389</td>
<td>0.075883</td>
<td>0.470000</td>
<td>00:19</td>
</tr>
<tr class="odd">
<td>14</td>
<td>0.055731</td>
<td>0.655000</td>
<td>0.075790</td>
<td>0.470000</td>
<td>00:18</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a>validate(learn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>best so far = 0.4733333333333333
[0.07711941003799438, 0.4733333333333333]
best so far = 0.4733333333333333</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb210"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a>learn.opt.hypers.<span class="bu">map</span>(<span class="kw">lambda</span> d: d[<span class="st">'lr'</span>])</span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a><span class="co"># L(apply(d.get, ['wd', 'lr']))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(#5) [0.06416322019620913,0.06416322019620913,0.06416322019620913,0.06416322019620913,0.06416322019620913]</code></pre>
</div>
</div>
<p>This was the result after just three epochs. Now let’s unfreeze the last two layers and do discriminative training:</p>
<p>Now we will pass -2 to <code>freeze_to</code> to freeze all except the last two parameter groups:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb212"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a>learn.freeze_to(<span class="op">-</span><span class="dv">2</span>)</span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.freeze_to(-4)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.fit_one_cycle(1, lr_max=1e-3*i, moms=(0.8,0.7,0.8), wd=0.2)</span></span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.fit_one_cycle(4, lr_max=1e-3*i, moms=(0.8,0.7,0.8), wd=0.2)</span></span>
<span id="cb213-3"><a href="#cb213-3" aria-hidden="true" tabindex="-1"></a>learn.fit_sgdr(<span class="dv">3</span>, <span class="dv">1</span>, lr_max<span class="op">=</span><span class="fl">0.02</span>, wd<span class="op">=</span><span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.053839</td>
<td>0.078058</td>
<td>0.453333</td>
<td>00:07</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.050421</td>
<td>0.077731</td>
<td>0.453333</td>
<td>00:06</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.047472</td>
<td>0.077222</td>
<td>0.436667</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.045848</td>
<td>0.073436</td>
<td>0.436667</td>
<td>00:06</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.044292</td>
<td>0.074997</td>
<td>0.413333</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.042457</td>
<td>0.076048</td>
<td>0.423333</td>
<td>00:06</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.040752</td>
<td>0.076921</td>
<td>0.430000</td>
<td>00:06</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a>learn.opt.hypers.<span class="bu">map</span>(<span class="kw">lambda</span> d: d[<span class="st">'lr'</span>])</span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a><span class="co"># L(apply(d.get, ['wd', 'lr']))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(#5) [0.06416322019620913,0.06416322019620913,0.06416322019620913,0.06416322019620913,0.06416322019620913]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb216"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a>validate(learn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>best so far = 0.47333333333333333
[0.07113126665353775, 0.47333333333333333]
best so far = 0.47333333333333333</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<p>Now we will unfreeze a bit more, recompute learning rate and continue training:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb218"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a>learn.freeze_to(<span class="op">-</span><span class="dv">3</span>)</span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.freeze_to(-5)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb219"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">1</span>, lr_max<span class="op">=</span><span class="fl">1e-3</span>, moms<span class="op">=</span>(<span class="fl">0.8</span>,<span class="fl">0.7</span>,<span class="fl">0.8</span>), wd<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb219-2"><a href="#cb219-2" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">4</span>, lr_max<span class="op">=</span><span class="fl">1e-3</span>, moms<span class="op">=</span>(<span class="fl">0.8</span>,<span class="fl">0.7</span>,<span class="fl">0.8</span>), wd<span class="op">=</span><span class="fl">0.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.043529</td>
<td>0.071279</td>
<td>0.473333</td>
<td>00:10</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.043608</td>
<td>0.071249</td>
<td>0.476667</td>
<td>00:09</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.043263</td>
<td>0.071772</td>
<td>0.463333</td>
<td>00:09</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.042877</td>
<td>0.071997</td>
<td>0.456667</td>
<td>00:09</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.042536</td>
<td>0.072053</td>
<td>0.456667</td>
<td>00:09</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 0 with precision_at_k value: 0.4766666666666667.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb221"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a>learn.opt.hypers.<span class="bu">map</span>(<span class="kw">lambda</span> d: d[<span class="st">'lr'</span>])</span>
<span id="cb221-2"><a href="#cb221-2" aria-hidden="true" tabindex="-1"></a><span class="co"># L(apply(d.get, ['wd', 'lr']))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(#5) [0.000989510849598057,0.000989510849598057,0.000989510849598057,0.000989510849598057,0.000989510849598057]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb223"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a>validate(learn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>best so far = 0.4766666666666667
[0.07124889642000198, 0.4766666666666667]
best so far = 0.4766666666666667</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<p>Finally, we will unfreeze the whole model and perform training: (Caution: Check if you got enough memory left!)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb225"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a>cudamem()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>GPU: Quadro RTX 8000
You are using 16.390625 GB
Total GPU memory = 44.99969482421875 GB</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb227"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a>learn.unfreeze()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>At this point, it starts overfitting too soon so either progressively increase <code>bs</code> or increase <code>wd</code> or decrease <code>lr_max</code>. Another way would be to drop out label embeddings, but for this one needs to carefully adjust the dropout prob. Same concept regarding dropping out the seqs nh.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb228"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a>lr_min, lr_steep, lr_valley, lr_slide <span class="op">=</span> learn.lr_find(suggest_funcs<span class="op">=</span>(minimum,steep,valley,slide), num_it<span class="op">=</span><span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<p><img src="18_tutorial.train_mimic3_files/figure-html/cell-165-output-3.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb229"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a>lr_min, lr_steep, lr_valley, lr_slide</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(0.00043651582673192023,
 0.00015848931798245758,
 0.0002290867705596611,
 0.0010000000474974513)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb231"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.fit_one_cycle(1, lr_max=1e-3, moms=(0.8,0.7,0.8), wd=0.2)</span></span>
<span id="cb231-2"><a href="#cb231-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb231-3"><a href="#cb231-3" aria-hidden="true" tabindex="-1"></a>    learn.fit_one_cycle(<span class="dv">1</span>, lr_max<span class="op">=</span><span class="fl">1e-3</span><span class="op">*</span>i, moms<span class="op">=</span>(<span class="fl">0.8</span>,<span class="fl">0.7</span>,<span class="fl">0.8</span>), wd<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb231-4"><a href="#cb231-4" aria-hidden="true" tabindex="-1"></a>    learn.fit_one_cycle(<span class="dv">5</span>, lr_max<span class="op">=</span><span class="fl">1e-3</span><span class="op">*</span>i, moms<span class="op">=</span>(<span class="fl">0.8</span>,<span class="fl">0.7</span>,<span class="fl">0.8</span>), wd<span class="op">=</span><span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.042745</td>
<td>0.072136</td>
<td>0.446667</td>
<td>00:12</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.042994</td>
<td>0.071712</td>
<td>0.453333</td>
<td>00:11</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.042261</td>
<td>0.075044</td>
<td>0.450000</td>
<td>00:11</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.041705</td>
<td>0.074658</td>
<td>0.456667</td>
<td>00:11</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.040608</td>
<td>0.075577</td>
<td>0.446667</td>
<td>00:11</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.039769</td>
<td>0.075746</td>
<td>0.446667</td>
<td>00:13</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.042843</td>
<td>0.071680</td>
<td>0.460000</td>
<td>00:12</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.043052</td>
<td>0.071593</td>
<td>0.470000</td>
<td>00:12</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.042404</td>
<td>0.072811</td>
<td>0.460000</td>
<td>00:12</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.041661</td>
<td>0.073665</td>
<td>0.463333</td>
<td>00:12</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.040861</td>
<td>0.074412</td>
<td>0.456667</td>
<td>00:12</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.040264</td>
<td>0.074554</td>
<td>0.456667</td>
<td>00:11</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.043041</td>
<td>0.071457</td>
<td>0.466667</td>
<td>00:11</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.043180</td>
<td>0.071420</td>
<td>0.466667</td>
<td>00:13</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.042783</td>
<td>0.071878</td>
<td>0.456667</td>
<td>00:11</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.042280</td>
<td>0.072338</td>
<td>0.453333</td>
<td>00:12</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.041820</td>
<td>0.072718</td>
<td>0.460000</td>
<td>00:11</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.041488</td>
<td>0.072763</td>
<td>0.460000</td>
<td>00:11</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb232"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a>learn.opt.hypers.<span class="bu">map</span>(<span class="kw">lambda</span> d: d[<span class="st">'lr'</span>])</span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a><span class="co"># L(apply(d.get, ['wd', 'lr']))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(#5) [3.588356645241649e-05,3.588356645241649e-05,3.588356645241649e-05,3.588356645241649e-05,3.588356645241649e-05]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb234"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a>validate(learn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>best so far = 0.29333333333333333
[0.07909457385540009, 0.29333333333333333]
best so far = 0.29333333333333333</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
</section>
<section id="fine-tune-the-fwd-dev" class="level2">
<h2 class="anchored" data-anchor-id="fine-tune-the-fwd-dev">Fine-Tune the Fwd (Dev)</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb236"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> learn.load(learn.save_model.fname)</span>
<span id="cb236-2"><a href="#cb236-2" aria-hidden="true" tabindex="-1"></a>validate(learn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb237"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a>learn.save_model.reset_on_fit <span class="op">=</span> <span class="va">False</span></span>
<span id="cb237-2"><a href="#cb237-2" aria-hidden="true" tabindex="-1"></a>learn.save_model.fname</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'mimic3-9k_clas_tiny'</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb239"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">10</span>, lr<span class="op">=</span><span class="fl">3e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.196740</td>
<td>0.152500</td>
<td>0.072112</td>
<td>0.243333</td>
<td>00:18</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.116046</td>
<td>0.264167</td>
<td>0.076217</td>
<td>0.280000</td>
<td>00:14</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.086854</td>
<td>0.334722</td>
<td>0.074655</td>
<td>0.283333</td>
<td>00:13</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.070159</td>
<td>0.407222</td>
<td>0.073141</td>
<td>0.320000</td>
<td>00:13</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.058983</td>
<td>0.467500</td>
<td>0.071807</td>
<td>0.313333</td>
<td>00:14</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.050570</td>
<td>0.530556</td>
<td>0.071735</td>
<td>0.333333</td>
<td>00:14</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.043707</td>
<td>0.590833</td>
<td>0.074884</td>
<td>0.306667</td>
<td>00:20</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.037904</td>
<td>0.650833</td>
<td>0.074323</td>
<td>0.306667</td>
<td>00:14</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.032732</td>
<td>0.701667</td>
<td>0.076984</td>
<td>0.303333</td>
<td>00:17</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.028173</td>
<td>0.736111</td>
<td>0.081250</td>
<td>0.296667</td>
<td>00:13</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 0 with valid_precision_at_k value: 0.24333333333333335.
Better model found at epoch 1 with valid_precision_at_k value: 0.27999999999999997.
Better model found at epoch 2 with valid_precision_at_k value: 0.2833333333333333.
Better model found at epoch 3 with valid_precision_at_k value: 0.31999999999999995.
Better model found at epoch 5 with valid_precision_at_k value: 0.33333333333333337.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb241"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a>learn.freeze_to(<span class="op">-</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb242"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">10</span>, lr<span class="op">=</span><span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.032477</td>
<td>0.546111</td>
<td>0.077029</td>
<td>0.316667</td>
<td>00:19</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.026895</td>
<td>0.631667</td>
<td>0.082825</td>
<td>0.336667</td>
<td>00:19</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.022810</td>
<td>0.695000</td>
<td>0.088930</td>
<td>0.306667</td>
<td>00:19</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.019261</td>
<td>0.748333</td>
<td>0.094657</td>
<td>0.290000</td>
<td>00:20</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.016189</td>
<td>0.776667</td>
<td>0.102535</td>
<td>0.306667</td>
<td>00:19</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.013916</td>
<td>0.785278</td>
<td>0.109710</td>
<td>0.260000</td>
<td>00:19</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.011869</td>
<td>0.796944</td>
<td>0.111829</td>
<td>0.293333</td>
<td>00:19</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.010106</td>
<td>0.799722</td>
<td>0.120422</td>
<td>0.293333</td>
<td>00:21</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.008519</td>
<td>0.803611</td>
<td>0.120180</td>
<td>0.290000</td>
<td>00:19</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.007059</td>
<td>0.810000</td>
<td>0.124685</td>
<td>0.300000</td>
<td>00:20</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 1 with valid_precision_at_k value: 0.33666666666666667.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb244"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a>learn.freeze_to(<span class="op">-</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb245"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">10</span>, lr<span class="op">=</span><span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.022163</td>
<td>0.624444</td>
<td>0.086960</td>
<td>0.316667</td>
<td>00:28</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.017831</td>
<td>0.728889</td>
<td>0.093251</td>
<td>0.320000</td>
<td>00:25</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.014486</td>
<td>0.773889</td>
<td>0.098625</td>
<td>0.303333</td>
<td>00:30</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.011709</td>
<td>0.795833</td>
<td>0.106103</td>
<td>0.280000</td>
<td>00:24</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.009461</td>
<td>0.802778</td>
<td>0.115305</td>
<td>0.300000</td>
<td>00:24</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.007549</td>
<td>0.808056</td>
<td>0.118747</td>
<td>0.293333</td>
<td>00:24</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.006116</td>
<td>0.808611</td>
<td>0.123826</td>
<td>0.303333</td>
<td>00:25</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.005031</td>
<td>0.808333</td>
<td>0.121675</td>
<td>0.286667</td>
<td>00:25</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.004195</td>
<td>0.809444</td>
<td>0.124114</td>
<td>0.303333</td>
<td>00:25</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.003598</td>
<td>0.809167</td>
<td>0.122602</td>
<td>0.293333</td>
<td>00:26</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb246"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a>learn.unfreeze()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb247"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">25</span>, lr<span class="op">=</span><span class="fl">1e-6</span>, wd<span class="op">=</span><span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.017937</td>
<td>0.685833</td>
<td>0.082829</td>
<td>0.336667</td>
<td>00:33</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.017736</td>
<td>0.686667</td>
<td>0.082837</td>
<td>0.333333</td>
<td>00:32</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.017744</td>
<td>0.687500</td>
<td>0.082840</td>
<td>0.333333</td>
<td>00:32</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.017788</td>
<td>0.688889</td>
<td>0.082847</td>
<td>0.333333</td>
<td>00:33</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.017752</td>
<td>0.689444</td>
<td>0.082856</td>
<td>0.333333</td>
<td>00:33</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.017747</td>
<td>0.686111</td>
<td>0.082861</td>
<td>0.333333</td>
<td>00:31</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.017696</td>
<td>0.687778</td>
<td>0.082863</td>
<td>0.333333</td>
<td>00:32</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.017713</td>
<td>0.688056</td>
<td>0.082867</td>
<td>0.333333</td>
<td>00:33</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.017615</td>
<td>0.687778</td>
<td>0.082875</td>
<td>0.333333</td>
<td>00:29</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.017625</td>
<td>0.688889</td>
<td>0.082881</td>
<td>0.336667</td>
<td>00:34</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.017603</td>
<td>0.689444</td>
<td>0.082886</td>
<td>0.333333</td>
<td>00:28</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.017586</td>
<td>0.686667</td>
<td>0.082890</td>
<td>0.333333</td>
<td>00:28</td>
</tr>
<tr class="odd">
<td>12</td>
<td>0.017585</td>
<td>0.689444</td>
<td>0.082897</td>
<td>0.333333</td>
<td>00:28</td>
</tr>
<tr class="even">
<td>13</td>
<td>0.017607</td>
<td>0.688611</td>
<td>0.082901</td>
<td>0.333333</td>
<td>00:29</td>
</tr>
<tr class="odd">
<td>14</td>
<td>0.017584</td>
<td>0.687222</td>
<td>0.082910</td>
<td>0.333333</td>
<td>00:29</td>
</tr>
<tr class="even">
<td>15</td>
<td>0.017577</td>
<td>0.689722</td>
<td>0.082915</td>
<td>0.333333</td>
<td>00:28</td>
</tr>
<tr class="odd">
<td>16</td>
<td>0.017550</td>
<td>0.689722</td>
<td>0.082920</td>
<td>0.333333</td>
<td>00:30</td>
</tr>
<tr class="even">
<td>17</td>
<td>0.017587</td>
<td>0.687778</td>
<td>0.082926</td>
<td>0.333333</td>
<td>00:31</td>
</tr>
<tr class="odd">
<td>18</td>
<td>0.017601</td>
<td>0.688611</td>
<td>0.082934</td>
<td>0.333333</td>
<td>00:27</td>
</tr>
<tr class="even">
<td>19</td>
<td>0.017594</td>
<td>0.688333</td>
<td>0.082938</td>
<td>0.333333</td>
<td>00:28</td>
</tr>
<tr class="odd">
<td>20</td>
<td>0.017609</td>
<td>0.688611</td>
<td>0.082942</td>
<td>0.333333</td>
<td>00:28</td>
</tr>
<tr class="even">
<td>21</td>
<td>0.017589</td>
<td>0.687500</td>
<td>0.082949</td>
<td>0.333333</td>
<td>00:28</td>
</tr>
<tr class="odd">
<td>22</td>
<td>0.017558</td>
<td>0.687778</td>
<td>0.082952</td>
<td>0.333333</td>
<td>00:28</td>
</tr>
<tr class="even">
<td>23</td>
<td>0.017565</td>
<td>0.692500</td>
<td>0.082960</td>
<td>0.333333</td>
<td>00:28</td>
</tr>
<tr class="odd">
<td>24</td>
<td>0.017519</td>
<td>0.689722</td>
<td>0.082966</td>
<td>0.333333</td>
<td>00:28</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="checking-how-to-avoid-overfitting" class="level2">
<h2 class="anchored" data-anchor-id="checking-how-to-avoid-overfitting">Checking how to avoid overfitting:</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb248"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a>learn.save_model.reset_on_fit<span class="op">=</span><span class="va">False</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb249"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">10</span>, lr<span class="op">=</span><span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.391221</td>
<td>0.074167</td>
<td>0.197629</td>
<td>0.196667</td>
<td>00:13</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.218384</td>
<td>0.225556</td>
<td>0.080403</td>
<td>0.253333</td>
<td>00:13</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.147795</td>
<td>0.256389</td>
<td>0.068796</td>
<td>0.270000</td>
<td>00:12</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.111931</td>
<td>0.277778</td>
<td>0.067111</td>
<td>0.276667</td>
<td>00:12</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.090809</td>
<td>0.308333</td>
<td>0.066692</td>
<td>0.276667</td>
<td>00:12</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.077108</td>
<td>0.332222</td>
<td>0.066395</td>
<td>0.286667</td>
<td>00:13</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.067511</td>
<td>0.354722</td>
<td>0.066039</td>
<td>0.280000</td>
<td>00:14</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.060452</td>
<td>0.377500</td>
<td>0.065895</td>
<td>0.296667</td>
<td>00:12</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.054908</td>
<td>0.410556</td>
<td>0.065720</td>
<td>0.310000</td>
<td>00:12</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.050470</td>
<td>0.431944</td>
<td>0.065801</td>
<td>0.316667</td>
<td>00:12</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 0 with valid_precision_at_k value: 0.19666666666666666.
Better model found at epoch 1 with valid_precision_at_k value: 0.2533333333333333.
Better model found at epoch 2 with valid_precision_at_k value: 0.27.
Better model found at epoch 3 with valid_precision_at_k value: 0.2766666666666667.
Better model found at epoch 5 with valid_precision_at_k value: 0.2866666666666667.
Better model found at epoch 7 with valid_precision_at_k value: 0.29666666666666675.
Better model found at epoch 8 with valid_precision_at_k value: 0.31.
Better model found at epoch 9 with valid_precision_at_k value: 0.31666666666666665.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb251"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a>learn.freeze_to(<span class="op">-</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb252"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">5</span>, lr<span class="op">=</span><span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.042890</td>
<td>0.413056</td>
<td>0.069452</td>
<td>0.303333</td>
<td>00:16</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.037558</td>
<td>0.481111</td>
<td>0.068302</td>
<td>0.340000</td>
<td>00:17</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.033383</td>
<td>0.543333</td>
<td>0.073505</td>
<td>0.313333</td>
<td>00:16</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.029333</td>
<td>0.617500</td>
<td>0.076961</td>
<td>0.306667</td>
<td>00:16</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.025810</td>
<td>0.668889</td>
<td>0.083302</td>
<td>0.286667</td>
<td>00:16</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 1 with valid_precision_at_k value: 0.34.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb254"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a>learn.freeze_to(<span class="op">-</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb255"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">5</span>, lr<span class="op">=</span><span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.032361</td>
<td>0.489444</td>
<td>0.072848</td>
<td>0.313333</td>
<td>00:20</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.027504</td>
<td>0.595278</td>
<td>0.077162</td>
<td>0.286667</td>
<td>00:21</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.023695</td>
<td>0.679722</td>
<td>0.082962</td>
<td>0.290000</td>
<td>00:22</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.019833</td>
<td>0.746389</td>
<td>0.091231</td>
<td>0.306667</td>
<td>00:22</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.016458</td>
<td>0.782500</td>
<td>0.097963</td>
<td>0.300000</td>
<td>00:23</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb256"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a>learn.opt.hypers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(#5) [{'wd': 0.01, 'sqr_mom': 0.99, 'lr': 0.01, 'mom': 0.9, 'eps': 1e-05},{'wd': 0.01, 'sqr_mom': 0.99, 'lr': 0.01, 'mom': 0.9, 'eps': 1e-05},{'wd': 0.01, 'sqr_mom': 0.99, 'lr': 0.01, 'mom': 0.9, 'eps': 1e-05},{'wd': 0.01, 'sqr_mom': 0.99, 'lr': 0.01, 'mom': 0.9, 'eps': 1e-05},{'wd': 0.01, 'sqr_mom': 0.99, 'lr': 0.01, 'mom': 0.9, 'eps': 1e-05}]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb258"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> xmltext_classifier_learner(dls_clas, AWD_LSTM, max_len<span class="op">=</span><span class="dv">72</span><span class="op">*</span><span class="dv">40</span>, </span>
<span id="cb258-2"><a href="#cb258-2" aria-hidden="true" tabindex="-1"></a>                                   metrics<span class="op">=</span>partial(precision_at_k, k<span class="op">=</span><span class="dv">15</span>), path<span class="op">=</span>tmp, cbs<span class="op">=</span>cbs, </span>
<span id="cb258-3"><a href="#cb258-3" aria-hidden="true" tabindex="-1"></a>                                   drop_mult<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb258-4"><a href="#cb258-4" aria-hidden="true" tabindex="-1"></a>                                   pretrained<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb258-5"><a href="#cb258-5" aria-hidden="true" tabindex="-1"></a>                                   splitter<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb258-6"><a href="#cb258-6" aria-hidden="true" tabindex="-1"></a>                                   running_decoder<span class="op">=</span><span class="va">True</span>).to_fp16()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb259"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tell `Recorder` to track `train_metrics`</span></span>
<span id="cb259-2"><a href="#cb259-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> learn.cbs[<span class="dv">1</span>].__class__ <span class="kw">is</span> Recorder</span>
<span id="cb259-3"><a href="#cb259-3" aria-hidden="true" tabindex="-1"></a><span class="bu">setattr</span>(learn.cbs[<span class="dv">1</span>], <span class="st">'train_metrics'</span>, <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb260"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb260-2"><a href="#cb260-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> after_batch(<span class="va">self</span>: ProgressCallback):</span>
<span id="cb260-3"><a href="#cb260-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pbar.update(<span class="va">self</span>.<span class="bu">iter</span><span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb260-4"><a href="#cb260-4" aria-hidden="true" tabindex="-1"></a>        mets <span class="op">=</span> (<span class="st">'_valid_mets'</span>, <span class="st">'_train_mets'</span>)[<span class="va">self</span>.training]</span>
<span id="cb260-5"><a href="#cb260-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pbar.comment <span class="op">=</span> <span class="st">' '</span>.join([<span class="ss">f'</span><span class="sc">{</span>met<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> = </span><span class="sc">{</span>met<span class="sc">.</span>value<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss">'</span> <span class="cf">for</span> met <span class="kw">in</span> <span class="bu">getattr</span>(<span class="va">self</span>.recorder, mets)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb261"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> learn.load(learn.save_model.fname)</span>
<span id="cb261-2"><a href="#cb261-2" aria-hidden="true" tabindex="-1"></a>validate(learn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>best so far = 0.3433333333333334
[0.06831542402505875, 0.3433333333333334]
best so far = 0.3433333333333334</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb263"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a>learn.save_model.best<span class="op">=</span><span class="fl">0.34333</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb264"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a>learn.unfreeze()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb265"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a><span class="co"># %%debug</span></span>
<span id="cb265-2"><a href="#cb265-2" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">10</span>, lr<span class="op">=</span><span class="fl">1e-6</span>, wd<span class="op">=</span><span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb266"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb266-1"><a href="#cb266-1" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.opt.hypers, learn.wd, learn.lr</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fine-tuning-the-bwd-classifier" class="level2">
<h2 class="anchored" data-anchor-id="fine-tuning-the-bwd-classifier">Fine-Tuning the Bwd Classifier</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb267"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a><span class="co"># learn_r.opt.hypers#.map(lambda d: d['lr'])</span></span>
<span id="cb267-2"><a href="#cb267-2" aria-hidden="true" tabindex="-1"></a><span class="co"># L(apply(d.get, ['wd', 'lr']))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb268"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb268-1"><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a>learn_r.fit(<span class="dv">2</span>, lr<span class="op">=</span><span class="fl">3e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.007564</td>
<td>0.384488</td>
<td>0.008315</td>
<td>0.454982</td>
<td>39:42</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.006742</td>
<td>0.458227</td>
<td>0.007797</td>
<td>0.481930</td>
<td>38:37</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 0 with valid_precision_at_k value: 0.45498220640569376.
Better model found at epoch 1 with valid_precision_at_k value: 0.48192961644918897.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb270"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a>learn_r.fit(<span class="dv">9</span>, lr<span class="op">=</span><span class="fl">3e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.006838</td>
<td>0.473014</td>
<td>0.007535</td>
<td>0.494899</td>
<td>39:47</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.007002</td>
<td>0.479700</td>
<td>0.007376</td>
<td>0.503084</td>
<td>40:23</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.006739</td>
<td>0.482954</td>
<td>0.007317</td>
<td>0.506702</td>
<td>40:47</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.006478</td>
<td>0.485122</td>
<td>0.007257</td>
<td>0.506445</td>
<td>40:42</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.006433</td>
<td>0.486549</td>
<td>0.007218</td>
<td>0.511052</td>
<td>39:54</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.006414</td>
<td>0.487762</td>
<td>0.007178</td>
<td>0.510320</td>
<td>40:14</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.006309</td>
<td>0.489128</td>
<td>0.007146</td>
<td>0.514353</td>
<td>40:14</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.006853</td>
<td>0.489367</td>
<td>0.007107</td>
<td>0.514334</td>
<td>40:19</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.006412</td>
<td>0.489717</td>
<td>0.007141</td>
<td>0.513741</td>
<td>39:47</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 0 with valid_precision_at_k value: 0.49489916963226593.
Better model found at epoch 1 with valid_precision_at_k value: 0.5030842230130488.
Better model found at epoch 2 with valid_precision_at_k value: 0.506702253855279.
Better model found at epoch 4 with valid_precision_at_k value: 0.511051799130091.
Better model found at epoch 6 with valid_precision_at_k value: 0.5143534994068806.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb272"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a>learn_r.freeze_to(<span class="op">-</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb273"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb273-1"><a href="#cb273-1" aria-hidden="true" tabindex="-1"></a>learn_r.fit(<span class="dv">14</span>, lr<span class="op">=</span><span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="9" class="" max="14" style="width:300px; height:20px; vertical-align: middle;"></progress>
      64.29% [9/14 7:53:40&lt;4:23:09]
    </div>
    

<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.005077</td>
<td>0.504411</td>
<td>0.006206</td>
<td>0.537722</td>
<td>52:54</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.005185</td>
<td>0.512415</td>
<td>0.006007</td>
<td>0.545275</td>
<td>50:30</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.004890</td>
<td>0.516533</td>
<td>0.005913</td>
<td>0.547687</td>
<td>52:12</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.004909</td>
<td>0.520331</td>
<td>0.005819</td>
<td>0.553341</td>
<td>51:44</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.004789</td>
<td>0.522809</td>
<td>0.005807</td>
<td>0.551839</td>
<td>52:14</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.004796</td>
<td>0.526800</td>
<td>0.005746</td>
<td>0.557750</td>
<td>54:06</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.004978</td>
<td>0.529563</td>
<td>0.005712</td>
<td>0.562772</td>
<td>51:44</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.004752</td>
<td>0.531859</td>
<td>0.005678</td>
<td>0.562060</td>
<td>54:39</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.004784</td>
<td>0.533404</td>
<td>0.005707</td>
<td>0.559035</td>
<td>53:30</td>
</tr>
</tbody>
</table>
<p>

    </p><div>
      <progress value="478" class="" max="3084" style="width:300px; height:20px; vertical-align: middle;"></progress>
      15.50% [478/3084 08:43&lt;47:31 avg_smooth_loss = 0.0045 precision_at_k = 0.5358]
    </div>
    
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 0 with valid_precision_at_k value: 0.5377224199288257.
Better model found at epoch 1 with valid_precision_at_k value: 0.5452748121787271.
Better model found at epoch 2 with valid_precision_at_k value: 0.5476868327402139.
Better model found at epoch 3 with valid_precision_at_k value: 0.5533412415974692.
Better model found at epoch 5 with valid_precision_at_k value: 0.5577500988533018.
Better model found at epoch 6 with valid_precision_at_k value: 0.5627718465796757.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb275"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb275-1"><a href="#cb275-1" aria-hidden="true" tabindex="-1"></a>learn_r.fit(<span class="dv">5</span>, lr<span class="op">=</span><span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.004934</td>
<td>0.530920</td>
<td>0.005644</td>
<td>0.562396</td>
<td>53:13</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.004600</td>
<td>0.533206</td>
<td>0.005640</td>
<td>0.562119</td>
<td>53:24</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.004838</td>
<td>0.534152</td>
<td>0.005616</td>
<td>0.564591</td>
<td>53:26</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.004992</td>
<td>0.535571</td>
<td>0.005625</td>
<td>0.563721</td>
<td>56:08</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.004729</td>
<td>0.537246</td>
<td>0.005623</td>
<td>0.564690</td>
<td>52:13</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 2 with valid_precision_at_k value: 0.5645907473309606.
Better model found at epoch 4 with valid_precision_at_k value: 0.5646896006326609.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb277"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb277-1"><a href="#cb277-1" aria-hidden="true" tabindex="-1"></a>learn_r.freeze_to(<span class="op">-</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb278"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a>learn_r.fit(<span class="dv">5</span>, lr<span class="op">=</span><span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.004512</td>
<td>0.542960</td>
<td>0.005425</td>
<td>0.574812</td>
<td>1:08:34</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.004399</td>
<td>0.549391</td>
<td>0.005388</td>
<td>0.580803</td>
<td>1:07:03</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.004393</td>
<td>0.551346</td>
<td>0.005378</td>
<td>0.580269</td>
<td>1:11:35</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.004305</td>
<td>0.552264</td>
<td>0.005399</td>
<td>0.580249</td>
<td>1:07:49</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.004638</td>
<td>0.552713</td>
<td>0.005320</td>
<td>0.582780</td>
<td>1:10:15</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 0 with valid_precision_at_k value: 0.5748121787267698.
Better model found at epoch 1 with valid_precision_at_k value: 0.5808026888098061.
Better model found at epoch 4 with valid_precision_at_k value: 0.5827797548438116.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb280"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a>learn_r.unfreeze()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb281"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb281-1"><a href="#cb281-1" aria-hidden="true" tabindex="-1"></a>learn_r.fit(<span class="dv">8</span>, lr<span class="op">=</span><span class="fl">1e-6</span>, wd<span class="op">=</span><span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.004360</td>
<td>0.564825</td>
<td>0.005301</td>
<td>0.584322</td>
<td>1:21:00</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.004090</td>
<td>0.566434</td>
<td>0.005286</td>
<td>0.585765</td>
<td>1:23:50</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.004282</td>
<td>0.567989</td>
<td>0.005273</td>
<td>0.587050</td>
<td>1:22:50</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.004444</td>
<td>0.569103</td>
<td>0.005261</td>
<td>0.588078</td>
<td>1:23:37</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.004214</td>
<td>0.570427</td>
<td>0.005251</td>
<td>0.588790</td>
<td>1:22:28</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.004118</td>
<td>0.571420</td>
<td>0.005242</td>
<td>0.589522</td>
<td>1:21:29</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.004051</td>
<td>0.572369</td>
<td>0.005234</td>
<td>0.590134</td>
<td>1:39:58</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.004023</td>
<td>0.573819</td>
<td>0.005226</td>
<td>0.590589</td>
<td>1:23:11</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 0 with valid_precision_at_k value: 0.5843218663503366.
Better model found at epoch 1 with valid_precision_at_k value: 0.58576512455516.
Better model found at epoch 2 with valid_precision_at_k value: 0.5870502174772637.
Better model found at epoch 3 with valid_precision_at_k value: 0.5880782918149465.
Better model found at epoch 4 with valid_precision_at_k value: 0.5887900355871885.
Better model found at epoch 5 with valid_precision_at_k value: 0.5895215500197706.
Better model found at epoch 6 with valid_precision_at_k value: 0.5901344404903124.
Better model found at epoch 7 with valid_precision_at_k value: 0.5905891656781339.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb283"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb283-1"><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a>learn_r.fit(<span class="dv">2</span>, lr<span class="op">=</span><span class="fl">1e-6</span>, wd<span class="op">=</span><span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.003961</td>
<td>0.575112</td>
<td>0.005219</td>
<td>0.591182</td>
<td>1:21:12</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.003683</td>
<td>0.577906</td>
<td>0.005213</td>
<td>0.591894</td>
<td>1:20:49</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 0 with valid_precision_at_k value: 0.5911822854883352.
Better model found at epoch 1 with valid_precision_at_k value: 0.591894029260577.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb285"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb285-1"><a href="#cb285-1" aria-hidden="true" tabindex="-1"></a>learn_r.fit(<span class="dv">10</span>, lr<span class="op">=</span><span class="fl">1e-6</span>, wd<span class="op">=</span><span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.004261</td>
<td>0.574649</td>
<td>0.005207</td>
<td>0.592329</td>
<td>1:24:13</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.004006</td>
<td>0.575258</td>
<td>0.005201</td>
<td>0.592724</td>
<td>1:21:54</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.004200</td>
<td>0.575567</td>
<td>0.005196</td>
<td>0.592803</td>
<td>1:24:06</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.004367</td>
<td>0.576012</td>
<td>0.005191</td>
<td>0.593041</td>
<td>1:25:26</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.004151</td>
<td>0.576616</td>
<td>0.005186</td>
<td>0.593575</td>
<td>1:27:14</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.004059</td>
<td>0.577233</td>
<td>0.005182</td>
<td>0.594089</td>
<td>1:26:12</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.003996</td>
<td>0.577824</td>
<td>0.005178</td>
<td>0.594365</td>
<td>1:28:34</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.003973</td>
<td>0.578928</td>
<td>0.005174</td>
<td>0.594504</td>
<td>1:24:08</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.003915</td>
<td>0.579819</td>
<td>0.005170</td>
<td>0.594919</td>
<td>1:25:19</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.003663</td>
<td>0.582147</td>
<td>0.005166</td>
<td>0.595275</td>
<td>1:24:36</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 0 with valid_precision_at_k value: 0.5923289837880584.
Better model found at epoch 1 with valid_precision_at_k value: 0.5927243969948597.
Better model found at epoch 2 with valid_precision_at_k value: 0.5928034796362198.
Better model found at epoch 3 with valid_precision_at_k value: 0.593040727560301.
Better model found at epoch 4 with valid_precision_at_k value: 0.5935745353894823.
Better model found at epoch 5 with valid_precision_at_k value: 0.5940885725583238.
Better model found at epoch 6 with valid_precision_at_k value: 0.5943653618030844.
Better model found at epoch 7 with valid_precision_at_k value: 0.5945037564254647.
Better model found at epoch 8 with valid_precision_at_k value: 0.5949189402926058.
Better model found at epoch 9 with valid_precision_at_k value: 0.5952748121787272.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb287"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb287-1"><a href="#cb287-1" aria-hidden="true" tabindex="-1"></a>learn_r.fit(<span class="dv">12</span>, lr<span class="op">=</span><span class="fl">1e-6</span>, wd<span class="op">=</span><span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.004219</td>
<td>0.578651</td>
<td>0.005163</td>
<td>0.595888</td>
<td>1:29:03</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.003969</td>
<td>0.578949</td>
<td>0.005159</td>
<td>0.596303</td>
<td>1:33:03</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.004162</td>
<td>0.579253</td>
<td>0.005156</td>
<td>0.596718</td>
<td>1:28:22</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.004331</td>
<td>0.579554</td>
<td>0.005153</td>
<td>0.596758</td>
<td>1:25:06</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.004119</td>
<td>0.580130</td>
<td>0.005150</td>
<td>0.597133</td>
<td>1:27:07</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.004029</td>
<td>0.580469</td>
<td>0.005148</td>
<td>0.597351</td>
<td>1:25:24</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.003968</td>
<td>0.580746</td>
<td>0.005145</td>
<td>0.597568</td>
<td>1:28:07</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.003946</td>
<td>0.581680</td>
<td>0.005142</td>
<td>0.597786</td>
<td>1:24:29</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.003890</td>
<td>0.582365</td>
<td>0.005140</td>
<td>0.597924</td>
<td>1:25:56</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.003661</td>
<td>0.584672</td>
<td>0.005138</td>
<td>0.598062</td>
<td>1:24:18</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.004071</td>
<td>0.581008</td>
<td>0.005135</td>
<td>0.598181</td>
<td>1:30:41</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.003967</td>
<td>0.581212</td>
<td>0.005133</td>
<td>0.598399</td>
<td>1:26:47</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 0 with valid_precision_at_k value: 0.5958877026492689.
Better model found at epoch 1 with valid_precision_at_k value: 0.5963028865164102.
Better model found at epoch 2 with valid_precision_at_k value: 0.5967180703835511.
Better model found at epoch 3 with valid_precision_at_k value: 0.5967576117042313.
Better model found at epoch 4 with valid_precision_at_k value: 0.5971332542506922.
Better model found at epoch 5 with valid_precision_at_k value: 0.597350731514433.
Better model found at epoch 6 with valid_precision_at_k value: 0.5975682087781735.
Better model found at epoch 7 with valid_precision_at_k value: 0.5977856860419142.
Better model found at epoch 8 with valid_precision_at_k value: 0.5979240806642946.
Better model found at epoch 9 with valid_precision_at_k value: 0.598062475286675.
Better model found at epoch 10 with valid_precision_at_k value: 0.5981810992487153.
Better model found at epoch 11 with valid_precision_at_k value: 0.5983985765124561.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb289"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb289-1"><a href="#cb289-1" aria-hidden="true" tabindex="-1"></a>learn_r.fit(<span class="dv">12</span>, lr<span class="op">=</span><span class="fl">1e-6</span>, wd<span class="op">=</span><span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.004192</td>
<td>0.581391</td>
<td>0.005131</td>
<td>0.598517</td>
<td>1:29:22</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.003944</td>
<td>0.581576</td>
<td>0.005129</td>
<td>0.598715</td>
<td>1:25:02</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.004137</td>
<td>0.581732</td>
<td>0.005127</td>
<td>0.598952</td>
<td>1:25:53</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.004306</td>
<td>0.581890</td>
<td>0.005125</td>
<td>0.599091</td>
<td>1:26:09</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.004097</td>
<td>0.582328</td>
<td>0.005123</td>
<td>0.599308</td>
<td>1:25:22</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.004008</td>
<td>0.582727</td>
<td>0.005122</td>
<td>0.599387</td>
<td>1:25:37</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.003949</td>
<td>0.582932</td>
<td>0.005120</td>
<td>0.599249</td>
<td>1:27:32</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.003927</td>
<td>0.583663</td>
<td>0.005119</td>
<td>0.599585</td>
<td>1:30:06</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.003872</td>
<td>0.584260</td>
<td>0.005117</td>
<td>0.599703</td>
<td>1:26:04</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.003669</td>
<td>0.586653</td>
<td>0.005116</td>
<td>0.599941</td>
<td>1:28:20</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.004054</td>
<td>0.582681</td>
<td>0.005114</td>
<td>0.599901</td>
<td>1:25:49</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.003952</td>
<td>0.583013</td>
<td>0.005113</td>
<td>0.600217</td>
<td>1:30:22</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 0 with valid_precision_at_k value: 0.5985172004744963.
Better model found at epoch 1 with valid_precision_at_k value: 0.5987149070778969.
Better model found at epoch 2 with valid_precision_at_k value: 0.5989521550019774.
Better model found at epoch 3 with valid_precision_at_k value: 0.5990905496243577.
Better model found at epoch 4 with valid_precision_at_k value: 0.5993080268880984.
Better model found at epoch 5 with valid_precision_at_k value: 0.5993871095294585.
Better model found at epoch 7 with valid_precision_at_k value: 0.5995848161328591.
Better model found at epoch 8 with valid_precision_at_k value: 0.5997034400948994.
Better model found at epoch 9 with valid_precision_at_k value: 0.5999406880189802.
Better model found at epoch 11 with valid_precision_at_k value: 0.600217477263741.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb291"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb291-1"><a href="#cb291-1" aria-hidden="true" tabindex="-1"></a>learn_r.fit(<span class="dv">12</span>, lr<span class="op">=</span><span class="fl">1e-6</span>, wd<span class="op">=</span><span class="fl">0.4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.004177</td>
<td>0.583113</td>
<td>0.005111</td>
<td>0.600356</td>
<td>1:25:28</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.003931</td>
<td>0.583075</td>
<td>0.005110</td>
<td>0.600336</td>
<td>1:29:16</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.004125</td>
<td>0.583175</td>
<td>0.005109</td>
<td>0.600395</td>
<td>1:25:16</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.004296</td>
<td>0.583358</td>
<td>0.005109</td>
<td>0.600455</td>
<td>1:29:21</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.004089</td>
<td>0.583721</td>
<td>0.005108</td>
<td>0.600316</td>
<td>1:31:31</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.004001</td>
<td>0.583767</td>
<td>0.005107</td>
<td>0.600435</td>
<td>1:21:54</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.003945</td>
<td>0.583991</td>
<td>0.005107</td>
<td>0.600593</td>
<td>1:25:02</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.003924</td>
<td>0.584695</td>
<td>0.005107</td>
<td>0.600672</td>
<td>1:26:36</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.003871</td>
<td>0.585206</td>
<td>0.005106</td>
<td>0.601008</td>
<td>1:24:04</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.003696</td>
<td>0.587589</td>
<td>0.005106</td>
<td>0.600989</td>
<td>1:30:52</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.004054</td>
<td>0.583418</td>
<td>0.005106</td>
<td>0.601186</td>
<td>1:30:08</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.003954</td>
<td>0.583651</td>
<td>0.005105</td>
<td>0.601147</td>
<td>1:26:53</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 2 with valid_precision_at_k value: 0.6003954132068013.
Better model found at epoch 3 with valid_precision_at_k value: 0.6004547251878214.
Better model found at epoch 6 with valid_precision_at_k value: 0.6005931198102016.
Better model found at epoch 7 with valid_precision_at_k value: 0.6006722024515617.
Better model found at epoch 8 with valid_precision_at_k value: 0.6010083036773427.
Better model found at epoch 10 with valid_precision_at_k value: 0.6011862396204035.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb293"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb293-1"><a href="#cb293-1" aria-hidden="true" tabindex="-1"></a>learn_r.fit(<span class="dv">10</span>, lr<span class="op">=</span><span class="fl">1e-6</span>, wd<span class="op">=</span><span class="fl">0.4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">train_precision_at_k</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">valid_precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.004128</td>
<td>0.583594</td>
<td>0.005105</td>
<td>0.601186</td>
<td>1:24:23</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.004299</td>
<td>0.583698</td>
<td>0.005105</td>
<td>0.601305</td>
<td>1:25:33</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.004092</td>
<td>0.584118</td>
<td>0.005105</td>
<td>0.601423</td>
<td>1:27:00</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.004005</td>
<td>0.584058</td>
<td>0.005105</td>
<td>0.601463</td>
<td>1:25:26</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.003949</td>
<td>0.584217</td>
<td>0.005105</td>
<td>0.601522</td>
<td>1:24:53</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.003928</td>
<td>0.584968</td>
<td>0.005105</td>
<td>0.601404</td>
<td>1:27:26</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.003875</td>
<td>0.585415</td>
<td>0.005105</td>
<td>0.601661</td>
<td>1:22:49</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.003719</td>
<td>0.587758</td>
<td>0.005105</td>
<td>0.601779</td>
<td>1:24:33</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.004059</td>
<td>0.583728</td>
<td>0.005105</td>
<td>0.601700</td>
<td>1:23:08</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.003960</td>
<td>0.583779</td>
<td>0.005105</td>
<td>0.601799</td>
<td>1:26:34</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 0 with valid_precision_at_k value: 0.6011862396204033.
Better model found at epoch 1 with valid_precision_at_k value: 0.6013048635824436.
Better model found at epoch 2 with valid_precision_at_k value: 0.6014234875444842.
Better model found at epoch 3 with valid_precision_at_k value: 0.6014630288651643.
Better model found at epoch 4 with valid_precision_at_k value: 0.6015223408461846.
Better model found at epoch 6 with valid_precision_at_k value: 0.6016607354685648.
Better model found at epoch 7 with valid_precision_at_k value: 0.6017793594306049.
Better model found at epoch 9 with valid_precision_at_k value: 0.6017991300909451.</code></pre>
</div>
</div>
<p>Start here:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb295"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb295-1"><a href="#cb295-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(learn_r.save_model.fname)</span>
<span id="cb295-2"><a href="#cb295-2" aria-hidden="true" tabindex="-1"></a>learn_r.save_model.reset_on_fit <span class="op">=</span> <span class="va">False</span></span>
<span id="cb295-3"><a href="#cb295-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> learn_r.save_model.reset_on_fit <span class="kw">is</span> <span class="va">False</span></span>
<span id="cb295-4"><a href="#cb295-4" aria-hidden="true" tabindex="-1"></a>learn_r <span class="op">=</span> learn_r.load(learn_r.save_model.fname)</span>
<span id="cb295-5"><a href="#cb295-5" aria-hidden="true" tabindex="-1"></a>validate(learn_r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>mimic3-9k_clas_full_r
best so far = None
[0.005104772746562958, 0.6017991300909451]
best so far = None</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb297"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb297-1"><a href="#cb297-1" aria-hidden="true" tabindex="-1"></a>learn_r.save_model.best <span class="op">=</span> <span class="fl">0.60179913</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now you can unfreeze and train more if you want:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb298"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb298-1"><a href="#cb298-1" aria-hidden="true" tabindex="-1"></a>learn_r.unfreeze()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ensemble:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb299"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb299-1"><a href="#cb299-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> learn.load(learn.save_model.fname)</span>
<span id="cb299-2"><a href="#cb299-2" aria-hidden="true" tabindex="-1"></a>learn_r <span class="op">=</span> learn_r.load(learn_r.save_model.fname)</span>
<span id="cb299-3"><a href="#cb299-3" aria-hidden="true" tabindex="-1"></a>preds, targs <span class="op">=</span> learn.get_preds()</span>
<span id="cb299-4"><a href="#cb299-4" aria-hidden="true" tabindex="-1"></a>preds_r, targs <span class="op">=</span> learn_r.get_preds()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb300"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb300-1"><a href="#cb300-1" aria-hidden="true" tabindex="-1"></a>precision_at_k(preds.add(preds_r), targs, k<span class="op">=</span><span class="dv">15</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>0.6167457493080268</code></pre>
</div>
</div>
<hr>
<div class="cell">
<div class="sourceCode cell-code" id="cb302"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb302-1"><a href="#cb302-1" aria-hidden="true" tabindex="-1"></a>set_seed(<span class="dv">1</span>, reproducible<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb303"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb303-1"><a href="#cb303-1" aria-hidden="true" tabindex="-1"></a>lr_min, lr_steep, lr_valley, lr_slide <span class="op">=</span> learn_r.lr_find(suggest_funcs<span class="op">=</span>(minimum, steep, valley, slide))</span>
<span id="cb303-2"><a href="#cb303-2" aria-hidden="true" tabindex="-1"></a>lr_min, lr_steep, lr_valley, lr_slide</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<pre><code>(0.2754228591918945,
 0.033113110810518265,
 0.002511886414140463,
 0.033113110810518265)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="18_tutorial.train_mimic3_files/figure-html/cell-218-output-4.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb305"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb305-1"><a href="#cb305-1" aria-hidden="true" tabindex="-1"></a>learn_r.fit_one_cycle(<span class="dv">1</span>, lr_max<span class="op">=</span><span class="fl">0.14</span>, moms<span class="op">=</span>(<span class="fl">0.8</span>,<span class="fl">0.7</span>,<span class="fl">0.8</span>), wd<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb305-2"><a href="#cb305-2" aria-hidden="true" tabindex="-1"></a>learn_r.fit_one_cycle(<span class="dv">5</span>, lr_max<span class="op">=</span><span class="fl">0.14</span>, moms<span class="op">=</span>(<span class="fl">0.8</span>,<span class="fl">0.7</span>,<span class="fl">0.8</span>), wd<span class="op">=</span><span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.396181</td>
<td>0.218404</td>
<td>0.223333</td>
<td>00:05</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 0 with precision_at_k value: 0.22333333333333333.
Better model found at epoch 0 with precision_at_k value: 0.2533333333333333.
Better model found at epoch 2 with precision_at_k value: 0.35333333333333333.
Better model found at epoch 3 with precision_at_k value: 0.37333333333333335.
Better model found at epoch 4 with precision_at_k value: 0.37666666666666665.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.196439</td>
<td>0.160080</td>
<td>0.253333</td>
<td>00:04</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.164353</td>
<td>0.133897</td>
<td>0.240000</td>
<td>00:04</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.140529</td>
<td>0.114523</td>
<td>0.353333</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.119238</td>
<td>0.105214</td>
<td>0.373333</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.102833</td>
<td>0.103365</td>
<td>0.376667</td>
<td>00:05</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb307"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb307-1"><a href="#cb307-1" aria-hidden="true" tabindex="-1"></a>validate(learn_r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>best so far = 0.3166666666666667
[0.06839973479509354, 0.3166666666666667]
best so far = 0.3166666666666667</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<p>This was the result after just three epochs. Now let’s unfreeze the last two layers and do discriminative training:</p>
<p>Now we will pass -2 to <code>freeze_to</code> to freeze all except the last two parameter groups:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb309"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb309-1"><a href="#cb309-1" aria-hidden="true" tabindex="-1"></a>learn_r.freeze_to(<span class="op">-</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb310"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb310-1"><a href="#cb310-1" aria-hidden="true" tabindex="-1"></a>learn_r.fit_one_cycle(<span class="dv">1</span>, lr_max<span class="op">=</span><span class="fl">1e-3</span>, moms<span class="op">=</span>(<span class="fl">0.8</span>,<span class="fl">0.7</span>,<span class="fl">0.8</span>), wd<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb310-2"><a href="#cb310-2" aria-hidden="true" tabindex="-1"></a>learn_r.fit_one_cycle(<span class="dv">4</span>, lr_max<span class="op">=</span><span class="fl">1e-3</span>, moms<span class="op">=</span>(<span class="fl">0.8</span>,<span class="fl">0.7</span>,<span class="fl">0.8</span>), wd<span class="op">=</span><span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.066128</td>
<td>0.101364</td>
<td>0.363333</td>
<td>00:06</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 0 with precision_at_k value: 0.36333333333333334.
Better model found at epoch 0 with precision_at_k value: 0.37333333333333335.
Better model found at epoch 3 with precision_at_k value: 0.37666666666666665.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.063144</td>
<td>0.099782</td>
<td>0.373333</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.060468</td>
<td>0.100892</td>
<td>0.320000</td>
<td>00:06</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.058185</td>
<td>0.098354</td>
<td>0.353333</td>
<td>00:07</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.056312</td>
<td>0.096989</td>
<td>0.376667</td>
<td>00:05</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb312"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb312-1"><a href="#cb312-1" aria-hidden="true" tabindex="-1"></a>validate(learn_r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>best so far = 0.29000000000000004
[0.08007880300283432, 0.29000000000000004]
best so far = 0.29000000000000004</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<p>Now we will unfreeze a bit more, recompute learning rate and continue training:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb314"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb314-1"><a href="#cb314-1" aria-hidden="true" tabindex="-1"></a>learn_r.freeze_to(<span class="op">-</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb315"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb315-1"><a href="#cb315-1" aria-hidden="true" tabindex="-1"></a>learn_r.fit_one_cycle(<span class="dv">5</span>, lr_max<span class="op">=</span><span class="fl">1e-3</span>, moms<span class="op">=</span>(<span class="fl">0.8</span>,<span class="fl">0.7</span>,<span class="fl">0.8</span>), wd<span class="op">=</span><span class="fl">0.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.052942</td>
<td>0.098026</td>
<td>0.373333</td>
<td>00:08</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.053420</td>
<td>0.097696</td>
<td>0.373333</td>
<td>00:07</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.051679</td>
<td>0.097380</td>
<td>0.380000</td>
<td>00:07</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.049411</td>
<td>0.098192</td>
<td>0.370000</td>
<td>00:07</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.047627</td>
<td>0.097431</td>
<td>0.376667</td>
<td>00:08</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 0 with precision_at_k value: 0.37333333333333335.
Better model found at epoch 2 with precision_at_k value: 0.38.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb317"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb317-1"><a href="#cb317-1" aria-hidden="true" tabindex="-1"></a>validate(learn_r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>best so far = 0.2966666666666667
[0.08150946348905563, 0.2966666666666667]
best so far = 0.2966666666666667</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<p>Finally, we will unfreeze the whole model and perform training: (Caution: Check if you got enough memory left!)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb319"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb319-1"><a href="#cb319-1" aria-hidden="true" tabindex="-1"></a>cudamem()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>GPU: Quadro RTX 8000
You are using 9.798828125 GB
Total GPU memory = 44.99969482421875 GB</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb321"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb321-1"><a href="#cb321-1" aria-hidden="true" tabindex="-1"></a>learn_r.unfreeze()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>At this point, it starts overfitting too soon so either progressively increase <code>bs</code> or increase <code>wd</code> or decrease <code>lr_max</code>. Another way would be to drop out label embeddings, but for this one needs to carefully adjust the dropout prob. Same concept regarding dropping out the seqs nh.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb322"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb322-1"><a href="#cb322-1" aria-hidden="true" tabindex="-1"></a>lr_min, lr_steep, lr_valley, lr_slide <span class="op">=</span> learn_r.lr_find(suggest_funcs<span class="op">=</span>(minimum,steep,valley,slide), num_it<span class="op">=</span><span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<p><img src="18_tutorial.train_mimic3_files/figure-html/cell-229-output-3.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb323"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb323-1"><a href="#cb323-1" aria-hidden="true" tabindex="-1"></a>lr_min, lr_steep, lr_valley, lr_slide</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(0.0003019951749593019,
 6.309573450380412e-07,
 0.0003981071640737355,
 0.009120108559727669)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb325"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb325-1"><a href="#cb325-1" aria-hidden="true" tabindex="-1"></a>learn_r.fit_one_cycle(<span class="dv">10</span>, lr_max<span class="op">=</span><span class="fl">1e-4</span>, moms<span class="op">=</span>(<span class="fl">0.8</span>,<span class="fl">0.7</span>,<span class="fl">0.8</span>), wd<span class="op">=</span><span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">precision_at_k</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.064373</td>
<td>0.087895</td>
<td>0.296667</td>
<td>00:11</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.064310</td>
<td>0.087949</td>
<td>0.296667</td>
<td>00:10</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.063739</td>
<td>0.089096</td>
<td>0.293333</td>
<td>00:10</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.062852</td>
<td>0.090236</td>
<td>0.293333</td>
<td>00:10</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.062443</td>
<td>0.091487</td>
<td>0.293333</td>
<td>00:10</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.062105</td>
<td>0.091792</td>
<td>0.290000</td>
<td>00:10</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.061126</td>
<td>0.091894</td>
<td>0.286667</td>
<td>00:10</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.060621</td>
<td>0.092186</td>
<td>0.283333</td>
<td>00:10</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.060148</td>
<td>0.092261</td>
<td>0.283333</td>
<td>00:10</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.059983</td>
<td>0.092269</td>
<td>0.283333</td>
<td>00:10</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Better model found at epoch 0 with precision_at_k value: 0.29666666666666675.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb327"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb327-1"><a href="#cb327-1" aria-hidden="true" tabindex="-1"></a>validate(learn_r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>best so far = 0.2866666666666667
[0.08382819592952728, 0.2866666666666667]
best so far = 0.2866666666666667</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<p>Ensemble of fwd+bwd:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb329"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb329-1"><a href="#cb329-1" aria-hidden="true" tabindex="-1"></a>preds, targs <span class="op">=</span> learn.get_preds()</span>
<span id="cb329-2"><a href="#cb329-2" aria-hidden="true" tabindex="-1"></a>preds_r, targs <span class="op">=</span> learn_r.get_preds()</span>
<span id="cb329-3"><a href="#cb329-3" aria-hidden="true" tabindex="-1"></a>precision_at_k(preds<span class="op">+</span>preds_r, targs, k<span class="op">=</span><span class="dv">15</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<pre><code>0.3933333333333333</code></pre>
</div>
</div>
</section>
<section id="tta" class="level2">
<h2 class="anchored" data-anchor-id="tta">TTA</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb331"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb331-1"><a href="#cb331-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> xmltext_classifier_learner(dls_clas, AWD_LSTM, drop_mult<span class="op">=</span><span class="fl">0.1</span>, max_len<span class="op">=</span><span class="va">None</span>, </span>
<span id="cb331-2"><a href="#cb331-2" aria-hidden="true" tabindex="-1"></a>                                   metrics<span class="op">=</span>partial(precision_at_k, k<span class="op">=</span><span class="dv">15</span>), path<span class="op">=</span>tmp, cbs<span class="op">=</span>cbs,</span>
<span id="cb331-3"><a href="#cb331-3" aria-hidden="true" tabindex="-1"></a>                                   pretrained<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb331-4"><a href="#cb331-4" aria-hidden="true" tabindex="-1"></a>                                   splitter<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb331-5"><a href="#cb331-5" aria-hidden="true" tabindex="-1"></a>                                   running_decoder<span class="op">=</span><span class="va">True</span>).to_fp16()</span>
<span id="cb331-6"><a href="#cb331-6" aria-hidden="true" tabindex="-1"></a>learn_r <span class="op">=</span> xmltext_classifier_learner(dls_clas_r, AWD_LSTM, drop_mult<span class="op">=</span><span class="fl">0.1</span>, max_len<span class="op">=</span><span class="va">None</span>, </span>
<span id="cb331-7"><a href="#cb331-7" aria-hidden="true" tabindex="-1"></a>                                     metrics<span class="op">=</span>partial(precision_at_k, k<span class="op">=</span><span class="dv">15</span>), path<span class="op">=</span>tmp, cbs<span class="op">=</span>cbs,</span>
<span id="cb331-8"><a href="#cb331-8" aria-hidden="true" tabindex="-1"></a>                                     pretrained<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb331-9"><a href="#cb331-9" aria-hidden="true" tabindex="-1"></a>                                     splitter<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb331-10"><a href="#cb331-10" aria-hidden="true" tabindex="-1"></a>                                     running_decoder<span class="op">=</span><span class="va">True</span>).to_fp16()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb332"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb332-1"><a href="#cb332-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> learn.load(learn.save_model.fname)</span>
<span id="cb332-2"><a href="#cb332-2" aria-hidden="true" tabindex="-1"></a><span class="co"># learn = learn.load((learn.path/learn.model_dir)/'mimic3-9k_clas_tiny')</span></span>
<span id="cb332-3"><a href="#cb332-3" aria-hidden="true" tabindex="-1"></a>learn_r <span class="op">=</span> learn_r.load(learn_r.save_model.fname)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb333"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb333-1"><a href="#cb333-1" aria-hidden="true" tabindex="-1"></a>validate(learn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>best so far = -inf
[0.005114026367664337, 0.5988730723606168]
best so far = -inf</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb335"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb335-1"><a href="#cb335-1" aria-hidden="true" tabindex="-1"></a>validate(learn_r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>best so far = -inf
[0.0051385280676186085, 0.5965005931198106]
best so far = -inf</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb337"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb337-1"><a href="#cb337-1" aria-hidden="true" tabindex="-1"></a>L(learn, learn_r).attrgot(<span class="st">'model'</span>).itemgot(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(#2) [LabelAttentionClassifier(
  (pay_attn): XMLAttention(
    (lbs): Embedding(8922, 400)
    (attn): fastai.layers.Lambda(func=&lt;xcube.layers._Pay_Attention object&gt;)
  )
  (boost_attn): ElemWiseLin(
    (lin): Linear(in_features=400, out_features=8922, bias=True)
  )
),LabelAttentionClassifier(
  (pay_attn): XMLAttention(
    (lbs): Embedding(8922, 400)
    (attn): fastai.layers.Lambda(func=&lt;xcube.layers._Pay_Attention object&gt;)
  )
  (boost_attn): ElemWiseLin(
    (lin): Linear(in_features=400, out_features=8922, bias=True)
  )
)]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb339"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb339-1"><a href="#cb339-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xcube.layers <span class="im">import</span> <span class="op">*</span></span>
<span id="cb339-2"><a href="#cb339-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xcube.layers <span class="im">import</span> _linear_attention, _planted_attention</span>
<span id="cb339-3"><a href="#cb339-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xcube.text.learner <span class="im">import</span> _get_text_vocab, _get_label_vocab</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb340"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb340-1"><a href="#cb340-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span> </span>
<span id="cb340-2"><a href="#cb340-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_brain(<span class="va">self</span>:TextLearner,</span>
<span id="cb340-3"><a href="#cb340-3" aria-hidden="true" tabindex="-1"></a>    file_wgts: <span class="bu">str</span>, <span class="co"># Filename of the saved attention wgts</span></span>
<span id="cb340-4"><a href="#cb340-4" aria-hidden="true" tabindex="-1"></a>    file_bias: <span class="bu">str</span>, <span class="co"># Filename of the saved label bias</span></span>
<span id="cb340-5"><a href="#cb340-5" aria-hidden="true" tabindex="-1"></a>    device:(<span class="bu">int</span>,<span class="bu">str</span>,torch.device)<span class="op">=</span><span class="va">None</span> <span class="co"># Device used to load, defaults to `dls` device</span></span>
<span id="cb340-6"><a href="#cb340-6" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb340-7"><a href="#cb340-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Load the pre-learnt label specific attention weights for each token from `file` located in the </span></span>
<span id="cb340-8"><a href="#cb340-8" aria-hidden="true" tabindex="-1"></a><span class="co">    model directory, optionally ensuring it's one `device`</span></span>
<span id="cb340-9"><a href="#cb340-9" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb340-10"><a href="#cb340-10" aria-hidden="true" tabindex="-1"></a>    brain_path <span class="op">=</span> join_path_file(file_wgts, <span class="va">self</span>.path<span class="op">/</span><span class="va">self</span>.model_dir, ext<span class="op">=</span><span class="st">'.pkl'</span>)</span>
<span id="cb340-11"><a href="#cb340-11" aria-hidden="true" tabindex="-1"></a>    bias_path <span class="op">=</span> join_path_file(file_bias, <span class="va">self</span>.path<span class="op">/</span><span class="va">self</span>.model_dir, ext<span class="op">=</span><span class="st">'.pkl'</span>)</span>
<span id="cb340-12"><a href="#cb340-12" aria-hidden="true" tabindex="-1"></a>    brain_bootstrap <span class="op">=</span> torch.load(brain_path, map_location<span class="op">=</span>default_device() <span class="cf">if</span> device <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> device)</span>
<span id="cb340-13"><a href="#cb340-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>brain_vocab, brain <span class="op">=</span> mapt(brain_bootstrap.get, [<span class="st">'toks'</span>, <span class="st">'lbs'</span>, <span class="st">'mutual_info_jaccard'</span>])</span>
<span id="cb340-14"><a href="#cb340-14" aria-hidden="true" tabindex="-1"></a>    brain_vocab <span class="op">=</span> L(brain_vocab).<span class="bu">map</span>(listify)</span>
<span id="cb340-15"><a href="#cb340-15" aria-hidden="true" tabindex="-1"></a>    vocab <span class="op">=</span> L(_get_text_vocab(<span class="va">self</span>.dls), _get_label_vocab(<span class="va">self</span>.dls)).<span class="bu">map</span>(listify)</span>
<span id="cb340-16"><a href="#cb340-16" aria-hidden="true" tabindex="-1"></a>    brain_bias <span class="op">=</span> torch.load(bias_path, map_location<span class="op">=</span>default_device() <span class="cf">if</span> device <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> device)</span>
<span id="cb340-17"><a href="#cb340-17" aria-hidden="true" tabindex="-1"></a>    brain_bias <span class="op">=</span> brain_bias[:, :, <span class="dv">0</span>].squeeze(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb340-18"><a href="#cb340-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Performing brainsplant..."</span>)</span>
<span id="cb340-19"><a href="#cb340-19" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.brain, <span class="va">self</span>.lbsbias, <span class="op">*</span>_ <span class="op">=</span> brainsplant(vocab, brain_vocab, brain, brain_bias)</span>
<span id="cb340-20"><a href="#cb340-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Successfull!"</span>)</span>
<span id="cb340-21"><a href="#cb340-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># import pdb; pdb.set_trace()</span></span>
<span id="cb340-22"><a href="#cb340-22" aria-hidden="true" tabindex="-1"></a>    plant_attn_layer <span class="op">=</span> Lambda(Planted_Attention(<span class="va">self</span>.brain))</span>
<span id="cb340-23"><a href="#cb340-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">setattr</span>(<span class="va">self</span>.model[<span class="dv">1</span>].pay_attn, <span class="st">'plant_attn'</span>, plant_attn_layer)</span>
<span id="cb340-24"><a href="#cb340-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="va">self</span>.model[<span class="dv">1</span>].pay_attn.plant_attn.func.f <span class="kw">is</span> _planted_attention</span>
<span id="cb340-25"><a href="#cb340-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb341"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb341-1"><a href="#cb341-1" aria-hidden="true" tabindex="-1"></a><span class="co"># learn = learn.load_brain('mimic3-9k_tok_lbl_info', 'p_L')</span></span>
<span id="cb341-2"><a href="#cb341-2" aria-hidden="true" tabindex="-1"></a>learn_r <span class="op">=</span> learn_r.load_brain(<span class="st">'mimic3-9k_tok_lbl_info'</span>, <span class="st">'p_L'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Performing brainsplant...
Successfull!</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb343"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb343-1"><a href="#cb343-1" aria-hidden="true" tabindex="-1"></a>L(learn, learn_r).attrgot(<span class="st">'model'</span>).itemgot(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(#2) [LabelAttentionClassifier(
  (pay_attn): XMLAttention(
    (lbs): Embedding(8922, 400)
    (attn): fastai.layers.Lambda(func=&lt;xcube.layers._Pay_Attention object&gt;)
  )
  (boost_attn): ElemWiseLin(
    (lin): Linear(in_features=400, out_features=8922, bias=True)
  )
),LabelAttentionClassifier(
  (pay_attn): XMLAttention(
    (lbs): Embedding(8922, 400)
    (attn): fastai.layers.Lambda(func=&lt;xcube.layers._Pay_Attention object&gt;)
    (plant_attn): fastai.layers.Lambda(func=&lt;xcube.layers._Pay_Attention object&gt;)
  )
  (boost_attn): ElemWiseLin(
    (lin): Linear(in_features=400, out_features=8922, bias=True)
  )
)]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb345"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb345-1"><a href="#cb345-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb345-2"><a href="#cb345-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> forward(<span class="va">self</span>:XMLAttention, inp, sentc, mask):</span>
<span id="cb345-3"><a href="#cb345-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sent is the ouput of SentenceEncoder i.e., (bs, max_len tokens, nh)</span></span>
<span id="cb345-4"><a href="#cb345-4" aria-hidden="true" tabindex="-1"></a>    test_eqs(inp.shape, sentc.shape[:<span class="op">-</span><span class="dv">1</span>], mask.shape)</span>
<span id="cb345-5"><a href="#cb345-5" aria-hidden="true" tabindex="-1"></a>    top_tok_attn_wgts <span class="op">=</span> F.softmax(<span class="va">self</span>.attn(sentc), dim<span class="op">=</span><span class="dv">1</span>).masked_fill(mask[:,:,<span class="va">None</span>], <span class="dv">0</span>) <span class="co"># lbl specific wts for each token (bs, max_len, n_lbs)</span></span>
<span id="cb345-6"><a href="#cb345-6" aria-hidden="true" tabindex="-1"></a>    attn_wgts <span class="op">=</span> <span class="va">self</span>.plant_attn(inp).masked_fill(mask[:,:,<span class="va">None</span>], <span class="dv">0</span>) <span class="co">#shape (bs, bptt, n_lbs)</span></span>
<span id="cb345-7"><a href="#cb345-7" aria-hidden="true" tabindex="-1"></a>    top_lbs_attn_wgts <span class="op">=</span> attn_wgts.inattention(k<span class="op">=</span><span class="dv">1</span>, sort_dim<span class="op">=-</span><span class="dv">1</span>, sp_dim<span class="op">=</span><span class="dv">1</span>) <span class="co"># applying `inattention` across the lbs dim</span></span>
<span id="cb345-8"><a href="#cb345-8" aria-hidden="true" tabindex="-1"></a>    lbs_cf <span class="op">=</span> top_lbs_attn_wgts.<span class="bu">sum</span>(dim<span class="op">=</span><span class="dv">1</span>) <span class="co">#shape (bs, n_lbs)</span></span>
<span id="cb345-9"><a href="#cb345-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pdb.set_trace()</span></span>
<span id="cb345-10"><a href="#cb345-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> lincomb(sentc, wgts<span class="op">=</span>top_tok_attn_wgts.transpose(<span class="dv">1</span>,<span class="dv">2</span>)), top_tok_attn_wgts, lbs_cf <span class="co"># for each lbl do a linear combi of all the tokens based on attn_wgts (bs, num_lbs, nh)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb346"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb346-1"><a href="#cb346-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xcube.text.models.core <span class="im">import</span> _pad_tensor</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb347"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb347-1"><a href="#cb347-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb347-2"><a href="#cb347-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> forward(<span class="va">self</span>:LabelAttentionClassifier, sentc):</span>
<span id="cb347-3"><a href="#cb347-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(sentc, <span class="bu">tuple</span>): inp, sentc, mask <span class="op">=</span> sentc <span class="co"># sentc is the stuff coming outta SentenceEncoder i.e., shape (bs, max_len, nh) in other words the concatenated output of the AWD_LSTM</span></span>
<span id="cb347-4"><a href="#cb347-4" aria-hidden="true" tabindex="-1"></a>    test_eqs(inp.shape, sentc.shape[:<span class="op">-</span><span class="dv">1</span>], mask.shape)</span>
<span id="cb347-5"><a href="#cb347-5" aria-hidden="true" tabindex="-1"></a>    sentc <span class="op">=</span> sentc.masked_fill(mask[:, :, <span class="va">None</span>], <span class="dv">0</span>)</span>
<span id="cb347-6"><a href="#cb347-6" aria-hidden="true" tabindex="-1"></a>    attn, wgts, lbs_cf <span class="op">=</span> <span class="va">self</span>.pay_attn(inp, sentc, mask) <span class="co">#shape attn: (bs, n_lbs, n_hidden), wgts: (bs, max_len, n_lbs), lbs_cf : (bs, n_lbs)</span></span>
<span id="cb347-7"><a href="#cb347-7" aria-hidden="true" tabindex="-1"></a>    attn <span class="op">=</span> <span class="va">self</span>.boost_attn(attn) <span class="co"># shape (bs, n_lbs, n_hidden)</span></span>
<span id="cb347-8"><a href="#cb347-8" aria-hidden="true" tabindex="-1"></a>    bs <span class="op">=</span> <span class="va">self</span>.hl.size(<span class="dv">0</span>)</span>
<span id="cb347-9"><a href="#cb347-9" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.hl <span class="op">=</span> <span class="va">self</span>.hl.to(sentc.device)</span>
<span id="cb347-10"><a href="#cb347-10" aria-hidden="true" tabindex="-1"></a>    pred <span class="op">=</span> <span class="va">self</span>.hl <span class="op">+</span> _pad_tensor(attn.<span class="bu">sum</span>(dim<span class="op">=</span><span class="dv">2</span>), bs) <span class="op">+</span> <span class="va">self</span>.label_bias  <span class="co"># shape (bs, n_lbs)</span></span>
<span id="cb347-11"><a href="#cb347-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-12"><a href="#cb347-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">self</span>.y_range <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>: pred <span class="op">=</span> sigmoid_range(pred, <span class="op">*</span><span class="va">self</span>.y_range)</span>
<span id="cb347-13"><a href="#cb347-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pred, attn, wgts, lbs_cf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb348"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb348-1"><a href="#cb348-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb348-2"><a href="#cb348-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> after_pred(<span class="va">self</span>:RNNCallback): <span class="va">self</span>.learn.pred,<span class="va">self</span>.raw_out,<span class="va">self</span>.out, _ <span class="op">=</span> [o[<span class="op">-</span><span class="dv">1</span>] <span class="cf">if</span> is_listy(o) <span class="cf">else</span> o <span class="cf">for</span> o <span class="kw">in</span> <span class="va">self</span>.pred]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb349"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb349-1"><a href="#cb349-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xcube.layers <span class="im">import</span> inattention</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb350"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb350-1"><a href="#cb350-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FetchCallback(Callback):</span>
<span id="cb350-2"><a href="#cb350-2" aria-hidden="true" tabindex="-1"></a>    order<span class="op">=</span>RNNCallback.order<span class="op">-</span><span class="dv">1</span></span>
<span id="cb350-3"><a href="#cb350-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Save the preds, attention wgts and labels confidence outputs"</span></span>
<span id="cb350-4"><a href="#cb350-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb350-5"><a href="#cb350-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, predslog, rank): store_attr()</span>
<span id="cb350-6"><a href="#cb350-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb350-7"><a href="#cb350-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> before_validate(<span class="va">self</span>):</span>
<span id="cb350-8"><a href="#cb350-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.predslog <span class="op">=</span>  <span class="bu">open</span>(<span class="va">self</span>.predslog, <span class="st">'wb'</span>)</span>
<span id="cb350-9"><a href="#cb350-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.csv_rank <span class="op">=</span>  <span class="bu">open</span>(<span class="va">self</span>.rank, <span class="st">'w'</span>, newline<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb350-10"><a href="#cb350-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.writer_rank <span class="op">=</span> csv.writer(<span class="va">self</span>.csv_rank)</span>
<span id="cb350-11"><a href="#cb350-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.writer_rank.writerow(L(<span class="st">'subset'</span>, <span class="st">'#true (t)'</span>, <span class="st">'#true^subset (ts)'</span>, <span class="st">'% (ts/t)'</span>, <span class="st">'#top_preds'</span>, <span class="st">'#top_preds^subset'</span>, <span class="st">'#true^top_preds (ttp)'</span>, <span class="st">'#top_preds^subset^true'</span>, <span class="st">'precision (ttp/15)'</span>, <span class="st">'#true^topk (ttk)'</span>, <span class="st">'prec (ttk/15)'</span>))</span>
<span id="cb350-12"><a href="#cb350-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb350-13"><a href="#cb350-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb350-14"><a href="#cb350-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_stat(y, cf, preds):</span>
<span id="cb350-15"><a href="#cb350-15" aria-hidden="true" tabindex="-1"></a>        subset <span class="op">=</span> cf<span class="op">&gt;</span><span class="dv">0</span></span>
<span id="cb350-16"><a href="#cb350-16" aria-hidden="true" tabindex="-1"></a>        truth <span class="op">=</span> y.<span class="bu">sum</span>()</span>
<span id="cb350-17"><a href="#cb350-17" aria-hidden="true" tabindex="-1"></a>        num_true_subset <span class="op">=</span> torch.logical_and(y <span class="op">==</span> <span class="dv">1</span>, subset).<span class="bu">sum</span>()</span>
<span id="cb350-18"><a href="#cb350-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> preds.logical_and(tensor(<span class="dv">1</span>)).<span class="bu">all</span>() <span class="co"># check preds does not have any zeros</span></span>
<span id="cb350-19"><a href="#cb350-19" aria-hidden="true" tabindex="-1"></a>        top_preds <span class="op">=</span> preds.inattention(k<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb350-20"><a href="#cb350-20" aria-hidden="true" tabindex="-1"></a>        num_top_preds <span class="op">=</span> torch.as_tensor(top_preds.nonzero().flatten().numel())</span>
<span id="cb350-21"><a href="#cb350-21" aria-hidden="true" tabindex="-1"></a>        num_top_preds_subset <span class="op">=</span> torch.logical_and(top_preds, subset).<span class="bu">sum</span>() <span class="co">#</span></span>
<span id="cb350-22"><a href="#cb350-22" aria-hidden="true" tabindex="-1"></a>        num_true_top_preds <span class="op">=</span> torch.logical_and(y<span class="op">==</span><span class="dv">1</span>, top_preds).<span class="bu">sum</span>()</span>
<span id="cb350-23"><a href="#cb350-23" aria-hidden="true" tabindex="-1"></a>        num_top_preds_subset_true <span class="op">=</span> torch.logical_and(top_preds, subset).logical_and(y<span class="op">==</span><span class="dv">1</span>).<span class="bu">sum</span>()<span class="co">#</span></span>
<span id="cb350-24"><a href="#cb350-24" aria-hidden="true" tabindex="-1"></a>        topk <span class="op">=</span> preds.topk(k<span class="op">=</span><span class="dv">15</span>).indices</span>
<span id="cb350-25"><a href="#cb350-25" aria-hidden="true" tabindex="-1"></a>        num_true_topk <span class="op">=</span> y[topk].<span class="bu">sum</span>()</span>
<span id="cb350-26"><a href="#cb350-26" aria-hidden="true" tabindex="-1"></a>        _d <span class="op">=</span> <span class="bu">dict</span>(subsum <span class="op">=</span> subset.<span class="bu">sum</span>(), num_truth <span class="op">=</span> truth, num_true_subset <span class="op">=</span> num_true_subset, pct_true_subset <span class="op">=</span> num_true_subset.div(truth).mul(<span class="dv">100</span>), </span>
<span id="cb350-27"><a href="#cb350-27" aria-hidden="true" tabindex="-1"></a>                    num_top_preds <span class="op">=</span> num_top_preds, num_top_preds_subset <span class="op">=</span> num_top_preds_subset, true_top_preds <span class="op">=</span> num_true_top_preds, </span>
<span id="cb350-28"><a href="#cb350-28" aria-hidden="true" tabindex="-1"></a>                    num_top_preds_subset_also_true <span class="op">=</span>  num_top_preds_subset_true, </span>
<span id="cb350-29"><a href="#cb350-29" aria-hidden="true" tabindex="-1"></a>                    prec_shdbe <span class="op">=</span> torch.<span class="bu">min</span>(num_true_top_preds.div(<span class="fl">15.0</span>), torch.tensor(<span class="dv">1</span>)), </span>
<span id="cb350-30"><a href="#cb350-30" aria-hidden="true" tabindex="-1"></a>                    num_true_top_k<span class="op">=</span>num_true_topk, prec<span class="op">=</span>num_true_topk.div(<span class="dv">15</span>))</span>
<span id="cb350-31"><a href="#cb350-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># pdb.set_trace()</span></span>
<span id="cb350-32"><a href="#cb350-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> L(_d.values()).<span class="bu">map</span>(Self.item())</span>
<span id="cb350-33"><a href="#cb350-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb350-34"><a href="#cb350-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> after_pred(<span class="va">self</span>): </span>
<span id="cb350-35"><a href="#cb350-35" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.actual_pred, <span class="va">self</span>.attn, <span class="va">self</span>.wgts, <span class="va">self</span>.lbs_cf <span class="op">=</span> [o[<span class="op">-</span><span class="dv">1</span>] <span class="cf">if</span> is_listy(o) <span class="cf">else</span> o <span class="cf">for</span> o <span class="kw">in</span> <span class="va">self</span>.pred]</span>
<span id="cb350-36"><a href="#cb350-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> y,cf, preds <span class="kw">in</span> <span class="bu">zip</span>(<span class="va">self</span>.y, <span class="va">self</span>.lbs_cf, <span class="va">self</span>.actual_pred):</span>
<span id="cb350-37"><a href="#cb350-37" aria-hidden="true" tabindex="-1"></a>            <span class="co"># self.writer_predslog.writerow(L(y, cf, preds).map(cpupy))</span></span>
<span id="cb350-38"><a href="#cb350-38" aria-hidden="true" tabindex="-1"></a>            <span class="co"># self.csv_predslog.flush()</span></span>
<span id="cb350-39"><a href="#cb350-39" aria-hidden="true" tabindex="-1"></a>            pickle.dump((y,cf,preds), <span class="va">self</span>.predslog)</span>
<span id="cb350-40"><a href="#cb350-40" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.writer_rank.writerow(FetchCallback._get_stat(y, cf, preds))</span>
<span id="cb350-41"><a href="#cb350-41" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.csv_rank.flush()</span>
<span id="cb350-42"><a href="#cb350-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb350-43"><a href="#cb350-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> after_validate(<span class="va">self</span>): </span>
<span id="cb350-44"><a href="#cb350-44" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.predslog.close()<span class="op">;</span> </span>
<span id="cb350-45"><a href="#cb350-45" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.csv_rank.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb351"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb351-1"><a href="#cb351-1" aria-hidden="true" tabindex="-1"></a>validate(learn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>best so far = None
[0.005114026367664337, 0.5988730723606168]
best so far = None</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb353"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb353-1"><a href="#cb353-1" aria-hidden="true" tabindex="-1"></a>validate(learn_r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>best so far = -inf
[0.0051385280676186085, 0.5965005931198106]
best so far = -inf</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb355"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb355-1"><a href="#cb355-1" aria-hidden="true" tabindex="-1"></a>predslog <span class="op">=</span> join_path_file(fname<span class="op">+</span><span class="st">'_predslog'</span>, learn.path<span class="op">/</span>learn.model_dir, ext<span class="op">=</span><span class="st">'.pkl'</span>)</span>
<span id="cb355-2"><a href="#cb355-2" aria-hidden="true" tabindex="-1"></a>rank <span class="op">=</span> join_path_file(fname<span class="op">+</span><span class="st">'_rank'</span>, learn.path<span class="op">/</span>learn.model_dir, ext<span class="op">=</span><span class="st">'.csv'</span>)</span>
<span id="cb355-3"><a href="#cb355-3" aria-hidden="true" tabindex="-1"></a>fc <span class="op">=</span> FetchCallback(predslog, rank)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb356"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb356-1"><a href="#cb356-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"pid = </span><span class="sc">{</span>os<span class="sc">.</span>getpid()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb356-2"><a href="#cb356-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> learn.added_cbs([fc]):</span>
<span id="cb356-3"><a href="#cb356-3" aria-hidden="true" tabindex="-1"></a>    validate(learn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>pid = 1791
[0.0052354661747813225, 0.5901542111506525]</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb358"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb358-1"><a href="#cb358-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(Path.cwd()<span class="op">/</span><span class="st">'tmp.pkl'</span>, <span class="st">'wb'</span>) <span class="im">as</span> pf:</span>
<span id="cb358-2"><a href="#cb358-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">7</span>):</span>
<span id="cb358-3"><a href="#cb358-3" aria-hidden="true" tabindex="-1"></a>        tl <span class="op">=</span> [torch.randn(<span class="dv">5</span>) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>)]</span>
<span id="cb358-4"><a href="#cb358-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(tl)</span>
<span id="cb358-5"><a href="#cb358-5" aria-hidden="true" tabindex="-1"></a>        pickle.dump(tl, pf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb359"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb359-1"><a href="#cb359-1" aria-hidden="true" tabindex="-1"></a><span class="co"># with open(Path.cwd()/'tmp.pkl', 'rb') as f:</span></span>
<span id="cb359-2"><a href="#cb359-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(predslog, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb359-3"><a href="#cb359-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb359-4"><a href="#cb359-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb359-5"><a href="#cb359-5" aria-hidden="true" tabindex="-1"></a>            obj <span class="op">=</span> pickle.load(f)</span>
<span id="cb359-6"><a href="#cb359-6" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(obj)</span>
<span id="cb359-7"><a href="#cb359-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">EOFError</span>: <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb360"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb360-1"><a href="#cb360-1" aria-hidden="true" tabindex="-1"></a>datetime.fromtimestamp(predslog.stat().st_mtime).time()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>datetime.time(18, 21, 50, 118789)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb362"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb362-1"><a href="#cb362-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(predslog, <span class="st">'rb'</span>) <span class="im">as</span> preds_file, <span class="bu">open</span>(rank, <span class="st">'w'</span>, newline<span class="op">=</span><span class="st">''</span>) <span class="im">as</span> rank_file:</span>
<span id="cb362-2"><a href="#cb362-2" aria-hidden="true" tabindex="-1"></a>    writer <span class="op">=</span> csv.writer(rank_file)</span>
<span id="cb362-3"><a href="#cb362-3" aria-hidden="true" tabindex="-1"></a>    writer.writerow(L(<span class="st">'subset'</span>, <span class="st">'#true (t)'</span>, <span class="st">'#true^subset (ts)'</span>, <span class="st">'% (ts/t)'</span>, <span class="st">'#top_preds'</span>, <span class="st">'#top_preds^subset'</span>, <span class="st">'#true^top_preds (ttp)'</span>, <span class="st">'#top_preds^subset^true'</span>, <span class="st">'precision (ttp/15)'</span>, <span class="st">'#true^topk (ttk)'</span>, <span class="st">'prec (ttk/15)'</span>))</span>
<span id="cb362-4"><a href="#cb362-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb362-5"><a href="#cb362-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb362-6"><a href="#cb362-6" aria-hidden="true" tabindex="-1"></a>            y, cf, preds <span class="op">=</span> pickle.load(preds_file)</span>
<span id="cb362-7"><a href="#cb362-7" aria-hidden="true" tabindex="-1"></a>            writer.writerow(FetchCallback._get_stat(y, cf, preds))</span>
<span id="cb362-8"><a href="#cb362-8" aria-hidden="true" tabindex="-1"></a>            rank_file.flush()</span>
<span id="cb362-9"><a href="#cb362-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">EOFError</span>: <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb363"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb363-1"><a href="#cb363-1" aria-hidden="true" tabindex="-1"></a>datetime.fromtimestamp(rank.stat().st_mtime).time()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>datetime.time(18, 35, 9, 58730)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb365"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb365-1"><a href="#cb365-1" aria-hidden="true" tabindex="-1"></a>df_rank <span class="op">=</span> pd.read_csv(rank)</span>
<span id="cb365-2"><a href="#cb365-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="bu">len</span>(df_rank)<span class="op">=</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb365-3"><a href="#cb365-3" aria-hidden="true" tabindex="-1"></a>df_rank.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>len(df_rank)=3372</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">subset</th>
<th data-quarto-table-cell-role="th">#true (t)</th>
<th data-quarto-table-cell-role="th">#true^subset (ts)</th>
<th data-quarto-table-cell-role="th">% (ts/t)</th>
<th data-quarto-table-cell-role="th">#top_preds</th>
<th data-quarto-table-cell-role="th">#top_preds^subset</th>
<th data-quarto-table-cell-role="th">#true^top_preds (ttp)</th>
<th data-quarto-table-cell-role="th">#top_preds^subset^true</th>
<th data-quarto-table-cell-role="th">precision (ttp/15)</th>
<th data-quarto-table-cell-role="th">#true^topk (ttk)</th>
<th data-quarto-table-cell-role="th">prec (ttk/15)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>936</td>
<td>39.0</td>
<td>33</td>
<td>84.615387</td>
<td>15</td>
<td>15</td>
<td>9</td>
<td>9</td>
<td>0.600000</td>
<td>9.0</td>
<td>0.600000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>827</td>
<td>38.0</td>
<td>30</td>
<td>78.947372</td>
<td>15</td>
<td>15</td>
<td>13</td>
<td>13</td>
<td>0.866667</td>
<td>13.0</td>
<td>0.866667</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>700</td>
<td>40.0</td>
<td>32</td>
<td>80.000000</td>
<td>15</td>
<td>15</td>
<td>13</td>
<td>13</td>
<td>0.866667</td>
<td>13.0</td>
<td>0.866667</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>797</td>
<td>27.0</td>
<td>17</td>
<td>62.962959</td>
<td>15</td>
<td>14</td>
<td>8</td>
<td>7</td>
<td>0.533333</td>
<td>8.0</td>
<td>0.533333</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>642</td>
<td>30.0</td>
<td>27</td>
<td>90.000000</td>
<td>15</td>
<td>14</td>
<td>9</td>
<td>8</td>
<td>0.600000</td>
<td>9.0</td>
<td>0.600000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We are missing out on:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb367"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb367-1"><a href="#cb367-1" aria-hidden="true" tabindex="-1"></a>df_rank[df_rank[<span class="st">'#true^top_preds (ttp)'</span>] <span class="op">!=</span> df_rank[<span class="st">'#true^topk (ttk)'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">subset</th>
<th data-quarto-table-cell-role="th">#true (t)</th>
<th data-quarto-table-cell-role="th">#true^subset (ts)</th>
<th data-quarto-table-cell-role="th">% (ts/t)</th>
<th data-quarto-table-cell-role="th">#top_preds</th>
<th data-quarto-table-cell-role="th">#top_preds^subset</th>
<th data-quarto-table-cell-role="th">#true^top_preds (ttp)</th>
<th data-quarto-table-cell-role="th">#top_preds^subset^true</th>
<th data-quarto-table-cell-role="th">precision (ttp/15)</th>
<th data-quarto-table-cell-role="th">#true^topk (ttk)</th>
<th data-quarto-table-cell-role="th">prec (ttk/15)</th>
</tr>
</thead>
<tbody>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb368"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb368-1"><a href="#cb368-1" aria-hidden="true" tabindex="-1"></a>df_rank[df_rank[<span class="st">'#true^top_preds (ttp)'</span>] <span class="op">-</span> df_rank[<span class="st">'#top_preds^subset^true'</span>] <span class="op">&gt;=</span> <span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">subset</th>
<th data-quarto-table-cell-role="th">#true (t)</th>
<th data-quarto-table-cell-role="th">#true^subset (ts)</th>
<th data-quarto-table-cell-role="th">% (ts/t)</th>
<th data-quarto-table-cell-role="th">#top_preds</th>
<th data-quarto-table-cell-role="th">#top_preds^subset</th>
<th data-quarto-table-cell-role="th">#true^top_preds (ttp)</th>
<th data-quarto-table-cell-role="th">#top_preds^subset^true</th>
<th data-quarto-table-cell-role="th">precision (ttp/15)</th>
<th data-quarto-table-cell-role="th">#true^topk (ttk)</th>
<th data-quarto-table-cell-role="th">prec (ttk/15)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>797</td>
<td>27.0</td>
<td>17</td>
<td>62.962959</td>
<td>15</td>
<td>14</td>
<td>8</td>
<td>7</td>
<td>0.533333</td>
<td>8.0</td>
<td>0.533333</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>642</td>
<td>30.0</td>
<td>27</td>
<td>90.000000</td>
<td>15</td>
<td>14</td>
<td>9</td>
<td>8</td>
<td>0.600000</td>
<td>9.0</td>
<td>0.600000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">11</td>
<td>782</td>
<td>15.0</td>
<td>12</td>
<td>80.000000</td>
<td>15</td>
<td>13</td>
<td>10</td>
<td>9</td>
<td>0.666667</td>
<td>10.0</td>
<td>0.666667</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">18</td>
<td>656</td>
<td>22.0</td>
<td>15</td>
<td>68.181816</td>
<td>15</td>
<td>14</td>
<td>9</td>
<td>8</td>
<td>0.600000</td>
<td>9.0</td>
<td>0.600000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">21</td>
<td>653</td>
<td>38.0</td>
<td>31</td>
<td>81.578949</td>
<td>15</td>
<td>14</td>
<td>11</td>
<td>10</td>
<td>0.733333</td>
<td>11.0</td>
<td>0.733333</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3363</td>
<td>203</td>
<td>14.0</td>
<td>10</td>
<td>71.428574</td>
<td>15</td>
<td>12</td>
<td>8</td>
<td>7</td>
<td>0.533333</td>
<td>8.0</td>
<td>0.533333</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3364</td>
<td>122</td>
<td>6.0</td>
<td>4</td>
<td>66.666672</td>
<td>15</td>
<td>11</td>
<td>5</td>
<td>4</td>
<td>0.333333</td>
<td>5.0</td>
<td>0.333333</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3366</td>
<td>168</td>
<td>18.0</td>
<td>13</td>
<td>72.222221</td>
<td>15</td>
<td>10</td>
<td>8</td>
<td>6</td>
<td>0.533333</td>
<td>8.0</td>
<td>0.533333</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3367</td>
<td>167</td>
<td>18.0</td>
<td>9</td>
<td>50.000000</td>
<td>15</td>
<td>10</td>
<td>12</td>
<td>8</td>
<td>0.800000</td>
<td>12.0</td>
<td>0.800000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3371</td>
<td>111</td>
<td>4.0</td>
<td>2</td>
<td>50.000000</td>
<td>15</td>
<td>6</td>
<td>1</td>
<td>0</td>
<td>0.066667</td>
<td>1.0</td>
<td>0.066667</td>
</tr>
</tbody>
</table>

<p>1582 rows × 11 columns</p>
</div>
</div>
</div>
<p>TODO: - Implement sortish=shuffle+split+sort+cat</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb369"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb369-1"><a href="#cb369-1" aria-hidden="true" tabindex="-1"></a>df_rank[<span class="st">'precision (ttp/15)'</span>].mean(), df_rank[<span class="st">'prec (ttk/15)'</span>].mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(0.590154242462093, 0.590154242462093)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb371"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb371-1"><a href="#cb371-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb371-2"><a href="#cb371-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Name'</span>: [<span class="st">'Alice'</span>, <span class="st">'Bob'</span>, <span class="st">'Charlie'</span>, <span class="st">'David'</span>],</span>
<span id="cb371-3"><a href="#cb371-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Age'</span>: [<span class="dv">25</span>, <span class="dv">30</span>, <span class="dv">35</span>, <span class="dv">40</span>],</span>
<span id="cb371-4"><a href="#cb371-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Salary'</span>: [<span class="dv">50000</span>, <span class="dv">60000</span>, <span class="dv">70000</span>, <span class="dv">80000</span>]</span>
<span id="cb371-5"><a href="#cb371-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb371-6"><a href="#cb371-6" aria-hidden="true" tabindex="-1"></a>df.style.applymap(<span class="kw">lambda</span> _: <span class="ss">f"color:</span><span class="sc">{</span><span class="st">'blue'</span><span class="sc">}</span><span class="ss">"</span>, subset<span class="op">=</span>[<span class="st">'Salary'</span>, <span class="st">'Name'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_dcdad_row0_col0, #T_dcdad_row0_col2, #T_dcdad_row1_col0, #T_dcdad_row1_col2, #T_dcdad_row2_col0, #T_dcdad_row2_col2, #T_dcdad_row3_col0, #T_dcdad_row3_col2 {
  color: blue;
}
</style>

<table id="T_dcdad" data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th class="blank level0" data-quarto-table-cell-role="th">&nbsp;</th>
<th id="T_dcdad_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">Name</th>
<th id="T_dcdad_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">Age</th>
<th id="T_dcdad_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">Salary</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_dcdad_level0_row0" class="row_heading level0 row0" data-quarto-table-cell-role="th">0</td>
<td id="T_dcdad_row0_col0" class="data row0 col0">Alice</td>
<td id="T_dcdad_row0_col1" class="data row0 col1">25</td>
<td id="T_dcdad_row0_col2" class="data row0 col2">50000</td>
</tr>
<tr class="even">
<td id="T_dcdad_level0_row1" class="row_heading level0 row1" data-quarto-table-cell-role="th">1</td>
<td id="T_dcdad_row1_col0" class="data row1 col0">Bob</td>
<td id="T_dcdad_row1_col1" class="data row1 col1">30</td>
<td id="T_dcdad_row1_col2" class="data row1 col2">60000</td>
</tr>
<tr class="odd">
<td id="T_dcdad_level0_row2" class="row_heading level0 row2" data-quarto-table-cell-role="th">2</td>
<td id="T_dcdad_row2_col0" class="data row2 col0">Charlie</td>
<td id="T_dcdad_row2_col1" class="data row2 col1">35</td>
<td id="T_dcdad_row2_col2" class="data row2 col2">70000</td>
</tr>
<tr class="even">
<td id="T_dcdad_level0_row3" class="row_heading level0 row3" data-quarto-table-cell-role="th">3</td>
<td id="T_dcdad_row3_col0" class="data row3 col0">David</td>
<td id="T_dcdad_row3_col1" class="data row3 col1">40</td>
<td id="T_dcdad_row3_col2" class="data row3 col2">80000</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb372"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb372-1"><a href="#cb372-1" aria-hidden="true" tabindex="-1"></a><span class="co"># df.loc[df['precision (tpc/t)'] &gt; 1.0, 'precision (tpc/t)'] = 1.0</span></span>
<span id="cb372-2"><a href="#cb372-2" aria-hidden="true" tabindex="-1"></a><span class="co"># df.head()</span></span>
<span id="cb372-3"><a href="#cb372-3" aria-hidden="true" tabindex="-1"></a><span class="co"># df.loc[:, 'precision (tpc/t)'].mean(), df['prec'].mean()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb373"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb373-1"><a href="#cb373-1" aria-hidden="true" tabindex="-1"></a>tbar <span class="op">=</span> tqdm(learn.dls.valid, leave<span class="op">=</span><span class="va">False</span>) </span>
<span id="cb373-2"><a href="#cb373-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> xb,yb <span class="kw">in</span> tbar:</span>
<span id="cb373-3"><a href="#cb373-3" aria-hidden="true" tabindex="-1"></a>    tbar.set_postfix({<span class="st">'xb'</span>:xb.shape, <span class="st">'yb'</span>: yb.shape})</span>
<span id="cb373-4"><a href="#cb373-4" aria-hidden="true" tabindex="-1"></a>    pred, <span class="op">*</span>_ <span class="op">=</span> learn.model(xb)</span>
<span id="cb373-5"><a href="#cb373-5" aria-hidden="true" tabindex="-1"></a>    prec <span class="op">=</span> precision_at_k(pred, yb)</span>
<span id="cb373-6"><a href="#cb373-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(prec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>0.6833333333333333
0.6791666666666667
0.65
0.6625000000000001
0.7083333333333334
0.7458333333333333
0.6375
0.675
0.7
0.6000000000000001
0.6625000000000001
0.7041666666666666
0.6666666666666666
0.6875
0.7416666666666667
0.65
0.6458333333333334
0.675
0.5958333333333333
0.7166666666666666
0.6791666666666667
0.6666666666666667
0.6
0.6749999999999999
0.6666666666666666
0.6291666666666667
0.7541666666666667
0.6666666666666667
0.6416666666666666
0.6416666666666666
0.7083333333333333
0.6458333333333334
0.6916666666666667
0.6833333333333333
0.6916666666666667
0.6375
0.6375000000000001
0.6125
0.6541666666666667
0.7000000000000001
0.7125000000000001
0.6291666666666667
0.6624999999999999
0.6166666666666667
0.6625000000000001
0.75
0.6916666666666667
0.6958333333333333
0.6291666666666667
0.6666666666666667
0.5625
0.6041666666666666
0.75
0.6291666666666667
0.6041666666666666
0.65
0.6458333333333333
0.6791666666666667
0.5833333333333333
0.6333333333333333
0.6416666666666666
0.5833333333333333
0.5791666666666666
0.575
0.6124999999999999
0.5833333333333333
0.6625
0.5958333333333332
0.6583333333333333
0.625
0.7125
0.6375
0.6416666666666667
0.5249999999999999
0.6666666666666667
0.6083333333333333
0.6958333333333333
0.6458333333333334
0.6375
0.55
0.6458333333333333
0.6291666666666667
0.5916666666666666
0.6041666666666667
0.7208333333333333
0.6000000000000001
0.65
0.6166666666666667
0.5916666666666666
0.6208333333333333
0.5458333333333334
0.6166666666666667
0.6000000000000001
0.5791666666666666
0.5791666666666666
0.5708333333333333
0.5875
0.6166666666666667
0.6666666666666666
0.6583333333333334
0.7124999999999999
0.6625000000000001
0.7124999999999999
0.6833333333333333
0.6291666666666667
0.5541666666666667
0.6666666666666667
0.6416666666666666
0.6208333333333333
0.5791666666666666
0.5708333333333333
0.5958333333333334
0.5666666666666667
0.625
0.6125
0.6583333333333333
0.6416666666666666
0.6583333333333333
0.6416666666666666
0.6666666666666667
0.6375
0.49166666666666664
0.575
0.6458333333333333
0.5333333333333333
0.5833333333333333
0.6083333333333334
0.5874999999999999
0.5958333333333334
0.5833333333333334
0.5625
0.5375
0.5916666666666667
0.5291666666666667
0.6166666666666667
0.5916666666666667
0.5875
0.5458333333333334
0.5041666666666667
0.6083333333333334
0.6083333333333334
0.5874999999999999
0.5125
0.55
0.625
0.5708333333333333
0.5166666666666666
0.5541666666666667
0.5291666666666666
0.5958333333333333
0.625
0.5875
0.5458333333333334
0.4708333333333333
0.48333333333333334
0.6458333333333333
0.5333333333333333
0.425
0.5125
0.5041666666666667
0.49583333333333335
0.525
0.5208333333333334
0.4125
0.5791666666666667
0.6125
0.49583333333333335
0.5166666666666667
0.5333333333333333
0.5125
0.5833333333333333
0.65
0.5208333333333334
0.5041666666666667
0.46249999999999997
0.4375
0.41250000000000003
0.5375
0.43333333333333335
0.48750000000000004
0.43333333333333335
0.5333333333333333
0.5249999999999999
0.5666666666666667
0.525
0.45
0.45
0.4708333333333333
0.5625
0.4833333333333333
0.4458333333333333
0.4708333333333333
0.48750000000000004
0.4666666666666667
0.4083333333333333
0.45
0.4083333333333333
0.4916666666666667
0.5166666666666666
0.49583333333333335
0.43333333333333335
0.5083333333333333
0.4708333333333333
0.4666666666666667
0.43333333333333335
0.31666666666666665
0.4666666666666667
0.4125
0.4041666666666667
0.5
0.4388888888888889</code></pre>
</div>
</div>
</section>
<section id="plotting-the-label-embeddings" class="level2">
<h2 class="anchored" data-anchor-id="plotting-the-label-embeddings">Plotting the Label Embeddings</h2>
<blockquote class="blockquote">
<p>To know if the model learnt embeddings that are meaningful</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb375"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb375-1"><a href="#cb375-1" aria-hidden="true" tabindex="-1"></a>lbs_emb <span class="op">=</span> learn.model[<span class="op">-</span><span class="dv">1</span>].pay_attn.lbs.weight</span>
<span id="cb375-2"><a href="#cb375-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> to_np(lbs_emb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s do a PCA and t-SNE on the labels embedding. Before doing PCA though we need to standardize <code>X</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb376"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb376-1"><a href="#cb376-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb377"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb377-1"><a href="#cb377-1" aria-hidden="true" tabindex="-1"></a>X_stand <span class="op">=</span> StandardScaler().fit_transform(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb378"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb378-1"><a href="#cb378-1" aria-hidden="true" tabindex="-1"></a>X_reduced, _vars <span class="op">=</span> plot_reduction(X, tSNE<span class="op">=</span><span class="va">True</span>) </span>
<span id="cb378-2"><a href="#cb378-2" aria-hidden="true" tabindex="-1"></a><span class="co"># X_random, _vars_rnd = plot_reduction(np.random.normal(size=(X.shape[0], 400)), tSNE=True) # to compare with a random embeddings</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="18_tutorial.train_mimic3_files/figure-html/cell-268-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb379"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb379-1"><a href="#cb379-1" aria-hidden="true" tabindex="-1"></a><span class="co"># print('\n'.join(L(source.glob('**/*desc*')).map(str)))</span></span>
<span id="cb379-2"><a href="#cb379-2" aria-hidden="true" tabindex="-1"></a>codes <span class="op">=</span> load_pickle(source<span class="op">/</span><span class="st">'code_desc.pkl'</span>)</span>
<span id="cb379-3"><a href="#cb379-3" aria-hidden="true" tabindex="-1"></a>df_lbl <span class="op">=</span> pd.DataFrame([(lbl, codes.get(lbl, <span class="st">"not found"</span>), freq) <span class="cf">for</span> lbl, freq <span class="kw">in</span> lbl_freqs.items()], columns<span class="op">=</span>[<span class="st">'label'</span>, <span class="st">'description'</span>, <span class="st">'frequency'</span>])</span>
<span id="cb379-4"><a href="#cb379-4" aria-hidden="true" tabindex="-1"></a>df_lbl <span class="op">=</span> df_lbl.sort_values(by<span class="op">=</span><span class="st">'frequency'</span>, ascending<span class="op">=</span><span class="va">False</span>, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb379-5"><a href="#cb379-5" aria-hidden="true" tabindex="-1"></a>df_lbl.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">description</th>
<th data-quarto-table-cell-role="th">frequency</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>401.9</td>
<td>Unspecified essential hypertension</td>
<td>84</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>38.93</td>
<td>Venous catheterization, not elsewhere classified</td>
<td>77</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>428.0</td>
<td>Congestive heart failure, unspecified</td>
<td>61</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>272.4</td>
<td>Other and unspecified hyperlipidemia</td>
<td>60</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>427.31</td>
<td>Atrial fibrillation</td>
<td>56</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Instead of doing a PCA on all the labels, let’s do it on the <code>top</code> most frequent labels:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb380"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb380-1"><a href="#cb380-1" aria-hidden="true" tabindex="-1"></a>top <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb380-2"><a href="#cb380-2" aria-hidden="true" tabindex="-1"></a>top_lbs <span class="op">=</span> [k <span class="cf">for</span> k, v <span class="kw">in</span> lbl_freqs.most_common(top)]</span>
<span id="cb380-3"><a href="#cb380-3" aria-hidden="true" tabindex="-1"></a>tfm_cat <span class="op">=</span> dls_clas.tfms[<span class="dv">1</span>][<span class="dv">1</span>]</span>
<span id="cb380-4"><a href="#cb380-4" aria-hidden="true" tabindex="-1"></a>top_lbs_emb <span class="op">=</span> lbs_emb[tfm_cat(top_lbs)]</span>
<span id="cb380-5"><a href="#cb380-5" aria-hidden="true" tabindex="-1"></a>topX <span class="op">=</span> to_np(top_lbs_emb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb381"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb381-1"><a href="#cb381-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.manifold <span class="im">import</span> TSNE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb382"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb382-1"><a href="#cb382-1" aria-hidden="true" tabindex="-1"></a>topX_tsne <span class="op">=</span> TSNE(n_components<span class="op">=</span><span class="dv">2</span>, perplexity<span class="op">=</span><span class="dv">40</span>).fit_transform(topX)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb383"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb383-1"><a href="#cb383-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">12</span>))</span>
<span id="cb383-2"><a href="#cb383-2" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb383-3"><a href="#cb383-3" aria-hidden="true" tabindex="-1"></a>plt.scatter(topX_tsne[:, <span class="dv">0</span>], topX_tsne[:, <span class="dv">1</span>], marker<span class="op">=</span><span class="st">'x'</span>, s<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb383-4"><a href="#cb383-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> lbl, x, y <span class="kw">in</span> <span class="bu">zip</span>(top_lbs, topX_tsne[:, <span class="dv">0</span>], topX_tsne[:, <span class="dv">1</span>]):</span>
<span id="cb383-5"><a href="#cb383-5" aria-hidden="true" tabindex="-1"></a>    plt.annotate(lbl,</span>
<span id="cb383-6"><a href="#cb383-6" aria-hidden="true" tabindex="-1"></a>                xy<span class="op">=</span>(x,y),</span>
<span id="cb383-7"><a href="#cb383-7" aria-hidden="true" tabindex="-1"></a>                xytext<span class="op">=</span>(<span class="dv">5</span>,<span class="op">-</span><span class="dv">5</span>),</span>
<span id="cb383-8"><a href="#cb383-8" aria-hidden="true" tabindex="-1"></a>                textcoords<span class="op">=</span><span class="st">'offset points'</span>,</span>
<span id="cb383-9"><a href="#cb383-9" aria-hidden="true" tabindex="-1"></a>                size<span class="op">=</span><span class="dv">7</span>)</span>
<span id="cb383-10"><a href="#cb383-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="18_tutorial.train_mimic3_files/figure-html/cell-273-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Take a look at some of the closely clustered labels to see if they have the same meaning. This will tell us if the model learned meaningful label embeddings:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb384"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb384-1"><a href="#cb384-1" aria-hidden="true" tabindex="-1"></a>df_lbl[df_lbl.label.isin([<span class="st">'36.13'</span>, <span class="st">'995.91'</span>, <span class="st">'88.72'</span>, <span class="st">'37.22'</span>])]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">description</th>
<th data-quarto-table-cell-role="th">frequency</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">48</td>
<td>88.72</td>
<td>Diagnostic ultrasound of heart</td>
<td>14</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">56</td>
<td>37.22</td>
<td>Left heart cardiac catheterization</td>
<td>13</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">64</td>
<td>995.91</td>
<td>Sepsis</td>
<td>11</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">70</td>
<td>36.13</td>
<td>(Aorto)coronary bypass of three coronary arteries</td>
<td>10</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Looks like it did!</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>